<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Nayra - AI Pintar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
    }
    
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100%;
      background: black;
      overflow: hidden;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    video {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      min-width: 100%;
      min-height: 100%;
      width: auto;
      height: auto;
      background: black;
      opacity: 0;
      transition: opacity 0.5s ease;
      z-index: 0;
      pointer-events: none;
    }

    video.show {
      opacity: 1;
      z-index: 1;
    }

    .overlay {
      position: fixed;
      bottom: 20px;
      left: 0;
      right: 0;
      z-index: 2;
      display: flex;
      justify-content: center;
      gap: 15px;
      padding: 0 20px;
    }

    .mic-button {
      background: linear-gradient(to bottom right, #00ff9d, #00c76d);
      color: white;
      border: none;
      width: 70px;
      height: 70px;
      font-size: 12px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 255, 127, 0.6);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      text-align: center;
      touch-action: manipulation;
    }

    .mic-button i {
      font-size: 20px;
      margin-bottom: 2px;
    }

    .mic-button:active {
      transform: scale(0.95);
      box-shadow: 0 2px 10px rgba(0, 255, 127, 0.8);
    }

    .cancel-button {
      background: linear-gradient(to bottom right, #ff4d4d, #a00000);
      box-shadow: 0 4px 15px rgba(255, 0, 0, 0.5);
    }

    .cancel-button:active {
      transform: scale(0.95);
      box-shadow: 0 2px 10px rgba(255, 0, 0, 0.7);
    }

    /* Loading state */
    .loading {
      background: linear-gradient(to bottom right, #ffa500, #ff8c00) !important;
      box-shadow: 0 4px 15px rgba(255, 165, 0, 0.6) !important;
    }

    /* Status message */
    .status {
      position: fixed;
      top: 20px;
      left: 0;
      right: 0;
      text-align: center;
      color: white;
      font-size: 14px;
      z-index: 3;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      margin: 0 20px;
      border-radius: 10px;
      display: none;
    }

    .status.show {
      display: block;
    }

    /* Untuk tablet */
    @media (min-width: 768px) {
      .mic-button {
        width: 90px;
        height: 90px;
        font-size: 14px;
      }
      
      .mic-button i {
        font-size: 24px;
      }
      
      .overlay {
        gap: 20px;
        bottom: 30px;
      }
    }
  </style>
</head>
<body>

<!-- Video Idle -->
<video id="idle" class="show" autoplay muted loop playsinline webkit-playsinline>
  <source src="media/idle.mp4" type="video/mp4" />
</video>

<!-- Video Avatar (bicara) -->
<video id="avatar" muted loop playsinline webkit-playsinline>
  <source src="media/avatar.mp4" type="video/mp4" />
</video>

<!-- Video Dance (separate file) -->
<video id="dance" muted playsinline webkit-playsinline>
  <source src="media/dance.mp4" type="video/mp4" />
</video>

<!-- Status Message -->
<div id="status" class="status"></div>

<!-- Tombol UI -->
<div class="overlay">
  <button id="micButton" class="mic-button">
    <i class="fas fa-microphone"></i>
    Bicara
  </button>
  <button id="cancelButton" class="mic-button cancel-button">
    <i class="fas fa-times"></i>
    Batal
  </button>
  <button id="resetButton" class="mic-button cancel-button">
    <i class="fas fa-rotate-left"></i>
    Reset
  </button>
</div>

<script>
// Sembunyikan API keys untuk security
const GROQ_KEYS = [
  "Bearer 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",
  "Bearer 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"
];

const idle = document.getElementById("idle");
const avatar = document.getElementById("avatar");
const dance = document.getElementById("dance");
const statusEl = document.getElementById("status");

let recognition = null;
let ucap = null;
let history = ambilRiwayat();

// ====== Utility Functions ======
function showStatus(message, duration = 3000) {
  statusEl.textContent = message;
  statusEl.classList.add('show');
  setTimeout(() => {
    statusEl.classList.remove('show');
  }, duration);
}

// ====== LocalStorage ======
function getNamaPengguna() {
  return localStorage.getItem("namaPengguna") || null;
}

function setNamaPengguna(nama) {
  localStorage.setItem("namaPengguna", nama);
}

function simpanRiwayat() {
  localStorage.setItem("riwayatChat", JSON.stringify(history));
}

function ambilRiwayat() {
  const data = localStorage.getItem("riwayatChat");
  return data ? JSON.parse(data) : [];
}

function hapusRiwayat() {
  localStorage.removeItem("riwayatChat");
  history = [];
}

// ====== Tampilan dan Kontrol ======
function show(video) {
  idle.classList.remove("show");
  avatar.classList.remove("show");
  dance.classList.remove("show");
  video.classList.add("show");
}

function bersihkanMarkdown(teks) {
  return teks.replace(/\*\*(.*?)\*\*/g, '$1').replace(/\*(.*?)\*/g, '$1');
}

// ====== Speech Recognition dengan Error Handling ======
async function mulaiRekam() {
  // Cek support speech recognition
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    showStatus("Browser tidak mendukung speech recognition");
    return;
  }

  // Request permission terlebih dahulu
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    // Stop stream immediately setelah dapat permission
    stream.getTracks().forEach(track => track.stop());
  } catch (err) {
    showStatus("Izin mikrofon diperlukan. Silakan berikan izin mikrofon.");
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  
  // Setup button loading state
  const micButton = document.getElementById("micButton");
  micButton.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Dengarkan';
  micButton.classList.add('loading');

  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = 'id-ID';
  recognition.maxAlternatives = 1;

  recognition.onstart = function() {
    showStatus("Mendengarkan...");
  };

  recognition.onresult = async function(event) {
    const teks = event.results[0][0].transcript.trim();
    showStatus(`Anda berkata: "${teks}"`);
    
    resetButtonState();

    if (/dance|nari|menari/i.test(teks)) {
      mulaiDance();
      return;
    }

    const regexNama = /nama(?:ku| saya)?(?: adalah)? ([a-zA-Z]+)/i;
    const match = teks.match(regexNama);
    if (match) {
      const nama = match[1];
      setNamaPengguna(nama);
      bicara(`Hai ${nama}, senang bertemu denganmu!`);
      return;
    }

    showStatus("Memproses...");
    const jawaban = await tanyaAI(teks);
    bicara(bersihkanMarkdown(jawaban));
  };

  recognition.onerror = function(event) {
    console.error("Speech Recognition Error:", event.error);
    let errorMsg = "Error speech recognition";
    
    switch(event.error) {
      case 'not-allowed':
      case 'permission-denied':
        errorMsg = "Izin mikrofon ditolak. Silakan berikan izin mikrofon.";
        break;
      case 'network':
        errorMsg = "Error jaringan. Periksa koneksi internet.";
        break;
      case 'no-speech':
        errorMsg = "Tidak ada suara terdeteksi. Coba lagi.";
        break;
      default:
        errorMsg = `Error: ${event.error}`;
    }
    
    showStatus(errorMsg);
    resetButtonState();
  };

  recognition.onend = function() {
    resetButtonState();
  };

  try {
    recognition.start();
  } catch (err) {
    showStatus("Gagal memulai speech recognition");
    resetButtonState();
  }
}

function resetButtonState() {
  const micButton = document.getElementById("micButton");
  micButton.innerHTML = '<i class="fas fa-microphone"></i> Bicara';
  micButton.classList.remove('loading');
}

// ====== AI Functions ======
async function cobaGroqDenganBanyakKey(body) {
  for (const key of GROQ_KEYS) {
    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 detik timeout
      
      const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": key,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body),
        signal: controller.signal
      });

      clearTimeout(timeoutId);

      if (!res.ok) {
        const err = await res.json();
        console.warn("Gagal dengan key:", err.error?.message);
        continue;
      }

      return await res.json();
    } catch (err) {
      if (err.name === 'AbortError') {
        console.warn("Request timeout");
      } else {
        console.error("Fetch error:", err);
      }
    }
  }
  return { error: { message: "Semua API gagal dihubungi. Cek koneksi internet." } };
}

async function tanyaAI(teks) {
  const nama = getNamaPengguna();
  const systemPrompt = `Kamu adalah Nayra AI, asisten pintar dari teta.education. ${
    nama ? `Nama pengguna adalah ${nama}.` : ""
  } Jawablah dengan ramah, sopan, dan mudah dimengerti oleh pengguna dari Indonesia.`;

  history.push({ role: "user", content: teks });

  const body = {
    model: "llama3-8b-8192",
    messages: [{ role: "system", content: systemPrompt }, ...history],
    temperature: 0.7,
    max_tokens: 500
  };

  const data = await cobaGroqDenganBanyakKey(body);

  if (data.error) {
    return "Maaf, terjadi error: " + data.error.message;
  }

  const reply = data.choices?.[0]?.message?.content || "Maaf, tidak ada jawaban.";
  history.push({ role: "assistant", content: reply });
  simpanRiwayat();

  return reply;
}

// ====== Video & Suara ======
function mulaiDance() {
  show(dance);
  dance.currentTime = 0;
  dance.play().catch(err => {
    console.warn("Video dance gagal:", err);
    showStatus("Video dance tidak dapat diputar");
  });
  dance.onended = () => show(idle);
}

function bicara(teks) {
  show(avatar);
  avatar.currentTime = 0;
  avatar.play().catch(err => {
    console.warn("Video avatar gagal:", err);
  });

  // Stop any ongoing speech
  if (speechSynthesis.speaking) {
    speechSynthesis.cancel();
  }

  ucap = new SpeechSynthesisUtterance(teks);
  ucap.lang = "id-ID";
  ucap.rate = 1.0;
  ucap.pitch = 1.0;
  
  ucap.onstart = () => {
    showStatus("Nayra sedang berbicara...");
  };
  
  ucap.onend = () => {
    avatar.pause();
    show(idle);
    ucap = null;
    showStatus("");
  };
  
  ucap.onerror = (event) => {
    console.error("Speech synthesis error:", event);
    showStatus("Error text-to-speech");
    avatar.pause();
    show(idle);
  };

  speechSynthesis.speak(ucap);
}

function cancelSemua() {
  if (recognition) {
    recognition.stop();
    recognition = null;
  }
  
  if (speechSynthesis.speaking || speechSynthesis.pending) {
    speechSynthesis.cancel();
  }

  resetButtonState();
  
  idle.pause(); 
  avatar.pause(); 
  dance.pause();
  
  show(idle);
  idle.currentTime = 0;
  idle.play().catch(err => console.warn("Idle video error:", err));
  
  showStatus("");
}

function resetKonteks() {
  hapusRiwayat();
  localStorage.removeItem("namaPengguna");
  bicara("Konteks telah dihapus. Kita bisa mulai percakapan baru.");
}

// ====== Event Listeners ======
document.getElementById("micButton").addEventListener("click", mulaiRekam);
document.getElementById("cancelButton").addEventListener("click", cancelSemua);
document.getElementById("resetButton").addEventListener("click", resetKonteks);

// Touch events untuk mobile
document.getElementById("micButton").addEventListener("touchend", function(e) {
  e.preventDefault();
  mulaiRekam();
});

// Prevent double tap zoom
document.addEventListener('touchstart', function(e) {
  if (e.touches.length > 1) {
    e.preventDefault();
  }
}, { passive: false });

let lastTouchEnd = 0;
document.addEventListener('touchend', function(e) {
  const now = (new Date()).getTime();
  if (now - lastTouchEnd <= 300) {
    e.preventDefault();
  }
  lastTouchEnd = now;
}, false);

// Auto-play video handling
document.addEventListener('DOMContentLoaded', function() {
  idle.play().catch(e => console.log('Auto-play prevented:', e));
});
</script>
</body>
</html>
