<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nayra AI - TETA SAINS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Google TTS Library -->
  <script src="https://code.responsivevoice.org/responsivevoice.js?key=HCPs4RfC"></script>
  <style>
    :root {
      --primary: #9999ff;
      --secondary: #7a7ae6;
    }
    
    body {
      font-family: 'Baloo 2', cursive;
      background-color: #f8fafc;
    }
    
    .app-container {
      max-width: 414px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      position: relative;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      max-width: 414px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
      background: white;
      z-index: 10;
      height: 70px;
      display: flex;
      align-items: center;
    }
    
    .nav-icon {
      transition: all 0.3s ease;
      font-size: 1.25rem;
    }
    
    .nav-icon.active {
      transform: translateY(-5px);
      color: var(--primary);
    }
    
    .app-logo {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .app-logo-icon {
      background-color: #9999ff;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
    }
    
    .app-name {
      font-weight: 700;
      font-size: 1.25rem;
      color: #9999ff;
    }

    /* Chat styles */
    .chat-container {
      padding-bottom: 80px;
    }
    
    .chat-header {
      position: sticky;
      top: 0;
      background: white;
      z-index: 5;
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .search-container {
      margin-top: 0.5rem;
      position: relative;
    }
    
    .search-input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border-radius: 1.5rem;
      border: 1px solid #e2e8f0;
      font-size: 0.875rem;
      outline: none;
      transition: all 0.3s ease;
    }
    
    .search-input:focus {
      border-color: #9999ff;
      box-shadow: 0 0 0 3px rgba(153, 153, 255, 0.1);
    }
    
    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
    }
    
    .user-list {
      padding: 0.5rem;
    }
    
    .user-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-radius: 0.75rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .user-item:hover {
      background-color: #f3f4f6;
    }
    
    .user-item.active {
      background-color: #e0f2fe;
    }
    
    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      margin-right: 0.75rem;
      font-size: 1.125rem;
    }
    
    .user-info {
      flex: 1;
    }
    
    .user-name {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.25rem;
    }
    
    .user-status {
      font-size: 0.75rem;
      color: #6b7280;
    }
    
    .no-users {
      text-align: center;
      padding: 2rem;
      color: #6b7280;
    }
    
    .chat-messages {
      padding: 1rem;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }
    
    .message {
      margin-bottom: 1rem;
      display: flex;
    }
    
    .message.sent {
      justify-content: flex-end;
    }
    
    .message.received {
      justify-content: flex-start;
    }
    
    .message-bubble {
      max-width: 70%;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      position: relative;
    }
    
    .message.sent .message-bubble {
      background-color: #9999ff;
      color: white;
      border-bottom-right-radius: 0.25rem;
    }
    
    .message.received .message-bubble {
      background-color: #f3f4f6;
      color: #1f2937;
      border-bottom-left-radius: 0.25rem;
    }
    
    .message-time {
      font-size: 0.75rem;
      margin-top: 0.25rem;
      opacity: 0.7;
    }
    
    .message-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(0,0,0,0.1);
    }
    
    .message-action-btn {
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .message-action-btn:hover {
      background: rgba(153, 153, 255, 0.1);
      color: #9999ff;
    }
    
    .message-action-btn.active {
      background: rgba(153, 153, 255, 0.2);
      color: #9999ff;
    }
    
    .message-input-container {
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      max-width: 414px;
      margin: 0 auto;
      background: white;
      padding: 0.75rem;
      border-top: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 9;
    }
    
    .message-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border-radius: 1.5rem;
      border: 1px solid #e2e8f0;
      outline: none;
      font-size: 0.875rem;
    }
    
    .message-input:focus {
      border-color: #9999ff;
    }
    
    .send-button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #9999ff;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .send-button:hover {
      background-color: #7a7ae6;
    }
    
    .send-button:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }
    
    /* Loading indicator */
    .loading {
      display: flex;
      justify-content: center;
      padding: 1rem;
      color: #6b7280;
    }
    
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #e2e8f0;
      border-top: 2px solid #9999ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100vh;
      background-color: white;
      box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
      transition: right 0.3s ease;
      z-index: 1001;
      overflow-y: auto;
    }
    
    .sidebar.active {
      right: 0;
    }
    
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .sidebar-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .hamburger {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #9999ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .hamburger:hover {
      background-color: #7a7ae6;
      transform: scale(1.05);
    }
    
    .sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .sidebar-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #9999ff;
    }
    
    .sidebar-content {
      padding: 1rem;
    }
    
    .ai-feature {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      background-color: #f7f9fc;
      transition: all 0.3s ease;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
    }
    
    .ai-feature:hover {
      background-color: #e6f0ff;
      transform: translateY(-2px);
    }
    
    .ai-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #9999ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-right: 1rem;
    }
    
    .ai-text {
      flex: 1;
    }
    
    .ai-title {
      font-weight: 600;
      color: #2d3748;
    }
    
    .ai-desc {
      font-size: 0.875rem;
      color: #718096;
    }
    
    /* TTS Controls */
    .tts-controls {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 100;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .tts-toggle {
      background: #9999ff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .tts-toggle:hover {
      background: #7a7ae6;
      transform: scale(1.1);
    }
    
    .tts-toggle.active {
      background: #ff6b6b;
    }
    
    .tts-voice-select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
      font-size: 12px;
      background: white;
    }
    
    /* Style khusus untuk bottom nav items */
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      text-decoration: none;
      flex: 1;
      height: 100%;
      padding: 0.5rem 0;
    }
    
    .nav-item span {
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }
    
    /* Nayra AI specific styles */
    .nayra-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-color: #9999ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-right: 0.75rem;
      font-size: 1.125rem;
    }
    
    .thinking-indicator {
      display: flex;
      align-items: center;
      color: #6b7280;
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }
    
    .thinking-dots {
      display: flex;
      margin-left: 0.5rem;
    }
    
    .thinking-dots span {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background-color: #6b7280;
      margin: 0 1px;
      animation: pulse 1.5s infinite ease-in-out;
    }
    
    .thinking-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .thinking-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }
    
    /* Improved mobile styles */
    @media (max-width: 414px) {
      .user-item {
        padding: 0.625rem;
      }
      
      .user-avatar {
        width: 42px;
        height: 42px;
        font-size: 1rem;
      }
      
      .message-bubble {
        max-width: 80%;
      }
      
      .message-input-container {
        padding: 0.625rem;
      }
      
      .sidebar {
        width: 280px;
        right: -280px;
      }
      
      .bottom-nav {
        height: 65px;
      }
      
      .nav-icon {
        font-size: 1.1rem;
      }
      
      .tts-controls {
        top: 70px;
        right: 10px;
      }
    }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Mobile App Container -->
  <div class="app-container">
    <!-- App Header -->
    <header class="bg-white p-4 border-b border-gray-200">
      <div class="flex justify-between items-center">
        <div class="app-logo">
          <div class="app-logo-icon">
            <i class="fas fa-robot"></i>
          </div>
          <h1 class="app-name">NAYRA AI</h1>
        </div>
        <div class="flex items-center space-x-3">
          <!-- TTS Toggle Button -->
          <button id="ttsToggle" class="tts-toggle" title="Toggle Text-to-Speech">
            <i class="fas fa-volume-up"></i>
          </button>
          
          <div class="hamburger" id="hamburgerButton">
            <i class="fas fa-bars"></i>
          </div>
        </div>
      </div>
    </header>

    <!-- TTS Controls -->
    <div id="ttsControls" class="tts-controls" style="display: none;">
      <select id="voiceSelect" class="tts-voice-select">
        <option value="Indonesian Female">Suara Perempuan Indonesia</option>
        <option value="Indonesian Male">Suara Laki-laki Indonesia</option>
        <option value="Google US English">English US (Female)</option>
        <option value="Google UK English Female">English UK (Female)</option>
      </select>
      <input type="range" id="ttsRate" min="0.5" max="2" step="0.1" value="1" title="Kecepatan bicara">
      <label for="ttsRate" style="font-size: 10px; text-align: center;">Kecepatan: <span id="rateValue">1.0</span></label>
    </div>

    <!-- Sidebar -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">Menu AI</div>
        <button class="hamburger" id="closeSidebar">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="sidebar-content">
        <!-- Link ke forum.html -->
        <a href="../media social/forum.html" class="ai-feature">
          <div class="ai-icon">
            <i class="fas fa-comments"></i>
          </div>
          <div class="ai-text">
            <div class="ai-title">Forum Diskusi</div>
            <div class="ai-desc">Diskusi terbuka dengan semua pengguna</div>
          </div>
        </a>
        
        <!-- Link ke chat pribadi -->
        <a href="../pesan/pesan.html" class="ai-feature">
          <div class="ai-icon">
            <i class="fas fa-comment-dots"></i>
          </div>
          <div class="ai-text">
            <div class="ai-title">Chat Pribadi</div>
            <div class="ai-desc">Chat dengan pengguna lain</div>
          </div>
        </a>
      </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
      <!-- Chat Messages -->
      <div id="chatMessages" class="chat-messages">
        <!-- Welcome message -->
        <div class="message received">
          <div class="message-bubble">
            <div class="message-text">
              Halo! Saya Nayra AI, asisten sains Anda. Saya siap membantu Anda dengan pertanyaan seputar sains, fisika, kimia, biologi, dan matematika. Apa yang ingin Anda ketahui hari ini?
            </div>
            <div class="message-time" id="welcomeTime"></div>
            <!-- TTS Action Button -->
            <div class="message-actions">
              <button class="message-action-btn" onclick="speakText(this, 'Halo! Saya Nayra AI, asisten sains Anda. Saya siap membantu Anda dengan pertanyaan seputar sains, fisika, kimia, biologi, dan matematika. Apa yang ingin Anda ketahui hari ini?')">
                <i class="fas fa-volume-up"></i> Dengarkan
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Input -->
    <div id="messageInputContainer" class="message-input-container">
      <input type="text" id="messageInput" class="message-input" placeholder="Tanyakan sesuatu tentang sains...">
      <button id="sendButton" class="send-button" disabled>
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
      <a href="../dashboard siswa.html" class="nav-item">
        <i class="fas fa-home nav-icon"></i>
        <span>Beranda</span>
      </a>
      <a href="../soal harian/dashboard soal.html" class="nav-item">
        <i class="fas fa-flask nav-icon"></i>
        <span>Soal Harian</span>
      </a>
      <a href="../ai/nayra.html" class="nav-item">
        <i class="fas fa-robot nav-icon"></i>
        <span>Nayra AI</span>
      </a>
      <a href="../materi harian/kategori materi.html" class="nav-item">
        <i class="fas fa-chalkboard-teacher nav-icon"></i>
        <span>Materi Harian</span>
      </a>
      <a href="../profil/profil.html" class="nav-item">
        <i class="fas fa-user nav-icon"></i>
        <span>Profil</span>
      </a>
    </nav>
  </div>

  <script>
    // DOM Elements
    const chatMessages = document.getElementById("chatMessages");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    const welcomeTime = document.getElementById("welcomeTime");
    
    // Sidebar elements
    const hamburgerButton = document.getElementById("hamburgerButton");
    const closeSidebar = document.getElementById("closeSidebar");
    const sidebar = document.getElementById("sidebar");
    const sidebarOverlay = document.getElementById("sidebarOverlay");
    
    // TTS Elements
    const ttsToggle = document.getElementById("ttsToggle");
    const ttsControls = document.getElementById("ttsControls");
    const voiceSelect = document.getElementById("voiceSelect");
    const ttsRate = document.getElementById("ttsRate");
    const rateValue = document.getElementById("rateValue");

    // TTS State
    let ttsEnabled = false;
    let currentSpeech = null;

    // Set welcome message time
    welcomeTime.textContent = formatTime(new Date());

    // Initialize TTS
    function initTTS() {
      // Set initial rate value
      rateValue.textContent = ttsRate.value;
      
      // Update rate value when slider changes
      ttsRate.addEventListener('input', function() {
        rateValue.textContent = this.value;
      });
      
      // Initialize responsivevoice
      if (typeof responsiveVoice !== "undefined") {
        responsiveVoice.setDefaultVoice("Indonesian Female");
        console.log("TTS initialized successfully");
      } else {
        console.error("TTS library failed to load");
      }
    }

    // Toggle TTS controls
    ttsToggle.addEventListener('click', function() {
      ttsEnabled = !ttsEnabled;
      
      if (ttsEnabled) {
        this.classList.add('active');
        this.innerHTML = '<i class="fas fa-volume-mute"></i>';
        ttsControls.style.display = 'flex';
        
        // Test TTS
        speakText(null, "TTS telah diaktifkan. Sekarang Anda dapat mendengarkan respons Nayra AI.");
      } else {
        this.classList.remove('active');
        this.innerHTML = '<i class="fas fa-volume-up"></i>';
        ttsControls.style.display = 'none';
        
        // Stop any ongoing speech
        if (currentSpeech) {
          responsiveVoice.cancel();
        }
      }
    });

    // Function to speak text
    function speakText(button, text) {
      if (!ttsEnabled) {
        alert("Aktifkan TTS terlebih dahulu dengan menekan tombol speaker di pojok kanan atas.");
        return;
      }
      
      // Stop any ongoing speech
      if (currentSpeech) {
        responsiveVoice.cancel();
      }
      
      // Remove active class from all buttons
      document.querySelectorAll('.message-action-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Add active class to clicked button
      if (button) {
        button.classList.add('active');
      }
      
      // Get selected voice and rate
      const voice = voiceSelect.value;
      const rate = parseFloat(ttsRate.value);
      
      // Speak the text
      currentSpeech = responsiveVoice.speak(text, voice, {
        rate: rate,
        onend: function() {
          if (button) {
            button.classList.remove('active');
          }
          currentSpeech = null;
        }
      });
    }

    // Stop speech function
    function stopSpeech() {
      if (currentSpeech) {
        responsiveVoice.cancel();
        currentSpeech = null;
      }
      
      // Remove active class from all buttons
      document.querySelectorAll('.message-action-btn').forEach(btn => {
        btn.classList.remove('active');
      });
    }

    // Toggle sidebar
    function toggleSidebar() {
      sidebar.classList.toggle("active");
      sidebarOverlay.classList.toggle("active");
    }

    // Close sidebar
    function closeSidebarFunc() {
      sidebar.classList.remove("active");
      sidebarOverlay.classList.remove("active");
    }

    // Event listeners for sidebar
    hamburgerButton.addEventListener("click", toggleSidebar);
    closeSidebar.addEventListener("click", closeSidebarFunc);
    sidebarOverlay.addEventListener("click", closeSidebarFunc);

    // Enable/disable send button based on input
    messageInput.addEventListener("input", () => {
      sendButton.disabled = !messageInput.value.trim();
    });

    // Send message
    sendButton.addEventListener("click", sendMessage);
    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && messageInput.value.trim()) {
        sendMessage();
      }
    });

    // Send message function
    async function sendMessage() {
      if (!messageInput.value.trim()) return;
      
      const messageText = messageInput.value.trim();
      
      // Add user message to chat
      addMessageToChat(messageText, 'sent');
      
      // Clear input
      messageInput.value = "";
      sendButton.disabled = true;
      
      // Show thinking indicator
      showThinkingIndicator();
      
      try {
        // Send message to Groq API (menggunakan API key dari Temanguru)
        const response = await fetchGroqResponse(messageText);
        
        // Remove thinking indicator
        removeThinkingIndicator();
        
        // Add AI response to chat
        const messageId = addMessageToChat(response, 'received');
        
        // Auto-speak the response if TTS is enabled
        if (ttsEnabled) {
          setTimeout(() => {
            speakText(null, response);
          }, 500);
        }
      } catch (error) {
        // Remove thinking indicator
        removeThinkingIndicator();
        
        // Show error message
        const errorMessage = "Maaf, saya mengalami masalah teknis saat memproses pertanyaan Anda. Silakan coba lagi nanti.";
        addMessageToChat(errorMessage, 'received');
        console.error("Error:", error);
        
        // Speak error if TTS is enabled
        if (ttsEnabled) {
          setTimeout(() => {
            speakText(null, errorMessage);
          }, 500);
        }
      }
    }

    // Add message to chat
    function addMessageToChat(text, type) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${type}`;
      
      const timeString = formatTime(new Date());
      const messageId = 'msg_' + Date.now();
      
      // Add TTS button for received messages
      let actionsHtml = '';
      if (type === 'received') {
        actionsHtml = `
          <div class="message-actions">
            <button class="message-action-btn" onclick="speakText(this, '${escapeHtmlForSpeech(text)}')">
              <i class="fas fa-volume-up"></i> Dengarkan
            </button>
            <button class="message-action-btn" onclick="copyToClipboard('${escapeHtmlForSpeech(text)}')">
              <i class="fas fa-copy"></i> Salin
            </button>
          </div>
        `;
      }
      
      messageDiv.innerHTML = `
        <div class="message-bubble">
          <div class="message-text">${escapeHtml(text)}</div>
          <div class="message-time">${timeString}</div>
          ${actionsHtml}
        </div>
      `;
      
      chatMessages.appendChild(messageDiv);
      
      // Scroll to bottom
      setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 100);
      
      return messageId;
    }

    // Copy to clipboard function
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        // Show temporary feedback
        const buttons = document.querySelectorAll('.message-action-btn');
        buttons.forEach(btn => {
          if (btn.innerHTML.includes('Salin')) {
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i> Tersalin!';
            setTimeout(() => {
              btn.innerHTML = original;
            }, 2000);
          }
        });
      });
    }

    // Show thinking indicator
    function showThinkingIndicator() {
      const thinkingDiv = document.createElement("div");
      thinkingDiv.className = "message received";
      thinkingDiv.id = "thinkingIndicator";
      
      thinkingDiv.innerHTML = `
        <div class="message-bubble">
          <div class="message-text">
            <div class="thinking-indicator">
              Nayra sedang berpikir
              <div class="thinking-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>
        </div>
      `;
      
      chatMessages.appendChild(thinkingDiv);
      
      // Scroll to bottom
      setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 100);
    }

    // Remove thinking indicator
    function removeThinkingIndicator() {
      const thinkingIndicator = document.getElementById("thinkingIndicator");
      if (thinkingIndicator) {
        thinkingIndicator.remove();
      }
    }

    // Fetch response from Groq API menggunakan API key dari Temanguru
    async function fetchGroqResponse(message) {
      // Menggunakan API key dari Temanguru
      const apiKey = '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';
      const apiUrl = 'https://api.groq.com/openai/v1/chat/completions';
      
      // Konteks untuk AI - fokus pada sains untuk Nayra AI
      const systemPrompt = `Anda adalah Nayra AI, asisten sains yang ramah dan membantu dalam aplikasi QUANTARA. 
      Fokuslah pada topik sains seperti fisika, kimia, biologi, matematika, dan ilmu pengetahuan lainnya. 
      
      Tugas Anda:
      1. Berikan penjelasan yang jelas, mudah dipahami, dan relevan dengan pertanyaan sains
      2. Bantu dengan pemecahan masalah dan konsep sains
      3. Berikan contoh yang relevan dan aplikatif
      4. Jika pertanyaan di luar topik sains, dengan sopan arahkan kembali ke topik sains
      5. Gunakan bahasa Indonesia yang baik dan sederhana
      6. Sesuaikan penjelasan dengan tingkat pengetahuan siswa
      7. Jangan gunakan markdown atau format khusus, gunakan teks biasa saja
      
      Anda adalah asisten khusus untuk aplikasi pembelajaran sains QUANTARA, kamu adalah asisten Ai Sains yang di latih dan dibuat oleh QUANTARA dikembangkan sejak tahun 2023.`;
      
      const requestBody = {
        model: 'llama-3.1-8b-instant', // Model Groq yang cepat dan efisien
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: message }
        ],
        temperature: 0.7,
        max_tokens: 1024,
        top_p: 1,
        stream: false
      };
      
      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        return data.choices[0].message.content;
      } catch (error) {
        // Fallback response jika API tidak tersedia
        console.error("Error calling Groq API:", error);
        return getFallbackResponse(message);
      }
    }

    // Fallback response jika API tidak tersedia
    function getFallbackResponse(message) {
      const lowerMessage = message.toLowerCase();
      
      // Respons sederhana berdasarkan kata kunci
      if (lowerMessage.includes('fisika') || lowerMessage.includes('fisik')) {
        return "Fisika adalah ilmu yang mempelajari tentang materi, energi, dan interaksi antara keduanya. Topik fisika mencakup mekanika, termodinamika, elektromagnetisme, dan banyak lagi. Apakah ada topik fisika khusus yang ingin Anda pelajari?";
      } else if (lowerMessage.includes('kimia')) {
        return "Kimia adalah ilmu yang mempelajari tentang komposisi, struktur, sifat, dan perubahan materi. Topik kimia meliputi atom, molekul, reaksi kimia, dan tabel periodik. Ada yang spesifik tentang kimia yang ingin Anda tanyakan?";
      } else if (lowerMessage.includes('biologi') || lowerMessage.includes('biolog')) {
        return "Biologi adalah ilmu yang mempelajari tentang kehidupan dan organisme hidup. Topik biologi mencakup sel, genetika, evolusi, ekosistem, dan anatomi. Apakah ada aspek biologi tertentu yang ingin Anda ketahui?";
      } else if (lowerMessage.includes('matematika') || lowerMessage.includes('matematik')) {
        return "Matematika adalah ilmu tentang angka, struktur, ruang, dan perubahan. Topik matematika meliputi aljabar, geometri, kalkulus, dan statistik. Ada pertanyaan matematika khusus yang bisa saya bantu?";
      } else if (lowerMessage.includes('halo') || lowerMessage.includes('hai') || lowerMessage.includes('hi')) {
        return "Halo! Saya Nayra AI, asisten sains Anda di TETA SAINS. Saya siap membantu dengan pertanyaan seputar sains. Apa yang ingin Anda pelajari hari ini?";
      } else {
        return "Terima kasih atas pertanyaannya! Sebagai asisten sains Nayra AI di TETA SAINS, saya khusus membantu dengan topik fisika, kimia, biologi, matematika, dan ilmu pengetahuan lainnya. Bisakah Anda memberikan lebih detail tentang apa yang ingin Anda ketahui?";
      }
    }

    // Helper functions
    function formatTime(date) {
      return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
    }

    function escapeHtml(s) {
      if (!s && s !== 0) return "";
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
    
    function escapeHtmlForSpeech(s) {
      if (!s && s !== 0) return "";
      return String(s)
        .replaceAll("'", "\\'")
        .replaceAll('"', '\\"')
        .replaceAll('\n', ' ');
    }

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      initTTS();
      
      // Add event listener for page visibility change
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          stopSpeech();
        }
      });
      
      // Add click outside to close TTS controls
      document.addEventListener('click', function(e) {
        if (!ttsToggle.contains(e.target) && !ttsControls.contains(e.target) && 
            ttsControls.style.display === 'flex') {
          ttsControls.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
