<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nayra AI - TETA SAINS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #9999ff;
      --secondary: #7a7ae6;
    }
    
    body {
      font-family: 'Baloo 2', cursive;
      background-color: #f8fafc;
    }
    
    .app-container {
      max-width: 414px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      position: relative;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      max-width: 414px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
      background: white;
      z-index: 10;
      height: 70px;
      display: flex;
      align-items: center;
    }
    
    .nav-icon {
      transition: all 0.3s ease;
      font-size: 1.25rem;
    }
    
    .nav-icon.active {
      transform: translateY(-5px);
      color: var(--primary);
    }
    
    .app-logo {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .app-logo-icon {
      background-color: #9999ff;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
    }
    
    .app-name {
      font-weight: 700;
      font-size: 1.25rem;
      color: #9999ff;
    }

    /* Avatar Container - FULL SCREEN */
    .avatar-container {
      width: 100%;
      max-width: 414px;
      height: calc(100vh - 140px);
      background: white;
      position: relative;
      overflow: hidden;
    }
    
    .avatar-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .avatar-idle {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* Status indicator */
    .avatar-status {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 5;
    }
    
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #4ade80;
    }
    
    .status-dot.idle {
      background: #94a3b8;
    }
    
    .status-dot.speaking {
      background: #3b82f6;
      animation: pulse 1.5s infinite;
    }
    
    .status-dot.listening {
      background: #ef4444;
      animation: pulse 1s infinite;
    }
    
    .status-dot.ready {
      background: #f59e0b;
      animation: pulse 1.2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* User input indicator */
    .user-input-indicator {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(153, 153, 255, 0.9);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.875rem;
      max-width: 80%;
      text-align: center;
      z-index: 5;
      display: none;
    }
    
    /* Tap to speak indicator */
    .tap-to-speak {
      position: absolute;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(59, 130, 246, 0.9);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.875rem;
      text-align: center;
      z-index: 5;
      display: none;
      cursor: pointer;
      animation: bounce 2s infinite;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(-5px); }
    }
    
    .message-input-container {
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      max-width: 414px;
      margin: 0 auto;
      background: white;
      padding: 0.75rem;
      border-top: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 9;
    }
    
    .message-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border-radius: 1.5rem;
      border: 1px solid #e2e8f0;
      outline: none;
      font-size: 0.875rem;
    }
    
    .message-input:focus {
      border-color: #9999ff;
    }
    
    .send-button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #9999ff;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .send-button:hover {
      background-color: #7a7ae6;
    }
    
    .send-button:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }
    
    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100vh;
      background-color: white;
      box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
      transition: right 0.3s ease;
      z-index: 1001;
      overflow-y: auto;
    }
    
    .sidebar.active {
      right: 0;
    }
    
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .sidebar-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .hamburger {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #9999ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .hamburger:hover {
      background-color: #7a7ae6;
      transform: scale(1.05);
    }
    
    .sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .sidebar-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #9999ff;
    }
    
    .sidebar-content {
      padding: 1rem;
    }
    
    .ai-feature {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      background-color: #f7f9fc;
      transition: all 0.3s ease;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
    }
    
    .ai-feature:hover {
      background-color: #e6f0ff;
      transform: translateY(-2px);
    }
    
    .ai-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #9999ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-right: 1rem;
    }
    
    .ai-text {
      flex: 1;
    }
    
    .ai-title {
      font-weight: 600;
      color: #2d3748;
    }
    
    .ai-desc {
      font-size: 0.875rem;
      color: #718096;
    }
    
    /* Style khusus untuk bottom nav items */
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      text-decoration: none;
      flex: 1;
      height: 100%;
      padding: 0.5rem 0;
    }
    
    .nav-item span {
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }
    
    /* Voice input button styles */
    .voice-input-button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #f3f4f6;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .voice-input-button:hover {
      background-color: #e5e7eb;
    }
    
    .voice-input-button.listening {
      background-color: #ef4444;
      color: white;
      animation: pulse 1.5s infinite;
    }
    
    /* Settings button in message input */
    .settings-button-small {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #f3f4f6;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .settings-button-small:hover {
      background-color: #e5e7eb;
    }
    
    /* Settings panel for TTS */
    .settings-panel {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100vh;
      background-color: white;
      box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
      transition: right 0.3s ease;
      z-index: 1002;
      overflow-y: auto;
    }
    
    .settings-panel.active {
      right: 0;
    }
    
    .settings-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1001;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .settings-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .settings-header {
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .settings-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #9999ff;
    }
    
    .settings-content {
      padding: 1rem;
    }
    
    .setting-item {
      margin-bottom: 1.5rem;
    }
    
    .setting-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #2d3748;
    }
    
    .voice-select {
      width: 100%;
      padding: 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #e2e8f0;
      font-size: 0.875rem;
      outline: none;
      transition: all 0.3s ease;
    }
    
    .voice-select:focus {
      border-color: #9999ff;
      box-shadow: 0 0 0 3px rgba(153, 153, 255, 0.1);
    }
    
    .slider-container {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    
    .slider-value {
      min-width: 40px;
      text-align: center;
      font-weight: 600;
      color: #9999ff;
    }
    
    input[type="range"] {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: #e2e8f0;
      outline: none;
      -webkit-appearance: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #9999ff;
      cursor: pointer;
    }
    
    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 0.875rem;
      color: #4b5563;
    }
    
    .checkbox-label input {
      margin-right: 0.5rem;
    }
    
    .settings-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .settings-button {
      flex: 1;
      padding: 0.75rem;
      border-radius: 0.5rem;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .settings-button.save {
      background-color: #9999ff;
      color: white;
    }
    
    .settings-button.save:hover {
      background-color: #7a7ae6;
    }
    
    .settings-button.cancel {
      background-color: #f3f4f6;
      color: #6b7280;
    }
    
    .settings-button.cancel:hover {
      background-color: #e5e7eb;
    }
    
    /* Improved mobile styles */
    @media (max-width: 414px) {
      .message-input-container {
        padding: 0.625rem;
      }
      
      .sidebar {
        width: 280px;
        right: -280px;
      }
      
      .settings-panel {
        width: 280px;
        right: -280px;
      }
      
      .bottom-nav {
        height: 65px;
      }
      
      .nav-icon {
        font-size: 1.1rem;
      }
      
      .avatar-container {
        height: calc(100vh - 135px);
      }
      
      .avatar-status {
        bottom: 70px;
      }
      
      .tap-to-speak {
        bottom: 100px;
      }
    }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Mobile App Container -->
  <div class="app-container">
    <!-- App Header -->
    <header class="bg-white p-4 border-b border-gray-200">
      <div class="flex justify-between items-center">
        <div class="app-logo">
          <div class="app-logo-icon">
            <i class="fas fa-robot"></i>
          </div>
          <h1 class="app-name">NAYRA AI</h1>
        </div>
        <div class="flex items-center space-x-3">
          <div class="hamburger" id="hamburgerButton">
            <i class="fas fa-bars"></i>
          </div>
        </div>
      </div>
    </header>

    <!-- Avatar Video Container -->
    <div class="avatar-container">
      <!-- Ganti src dengan path ke video avatar yang Anda siapkan -->
      <video id="avatarSpeaking" class="avatar-video" style="display: none;" loop>
        <!-- Ganti dengan video avatar berbicara Anda -->
        <source src="avatar-speaking.mp4" type="video/mp4">
        Browser Anda tidak mendukung tag video.
      </video>
      
      <video id="avatarIdle" class="avatar-idle" autoplay loop muted>
        <!-- Ganti dengan video avatar idle/diam Anda -->
        <source src="avatar-idle.mp4" type="video/mp4">
        Browser Anda tidak mendukung tag video.
      </video>
      
      <!-- User input indicator -->
      <div class="user-input-indicator" id="userInputIndicator">
        <i class="fas fa-user mr-2"></i>
        <span id="userInputText"></span>
      </div>
      
      <!-- Tap to speak indicator -->
      <div class="tap-to-speak" id="tapToSpeakIndicator">
        <i class="fas fa-hand-pointer mr-2"></i>
        <span>Ketuk untuk mendengar jawaban</span>
      </div>
      
      <!-- Avatar status -->
      <div class="avatar-status">
        <div class="status-dot idle" id="statusDot"></div>
        <span id="statusText">Siap Mendengarkan</span>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">Menu AI</div>
        <button class="hamburger" id="closeSidebar">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="sidebar-content">
        <!-- Link ke forum.html -->
        <a href="../media social/forum.html" class="ai-feature">
          <div class="ai-icon">
            <i class="fas fa-comments"></i>
          </div>
          <div class="ai-text">
            <div class="ai-title">Forum Diskusi</div>
            <div class="ai-desc">Diskusi terbuka dengan semua pengguna</div>
          </div>
        </a>
        
        <!-- Link ke chat pribadi -->
        <a href="../pesan/pesan.html" class="ai-feature">
          <div class="ai-icon">
            <i class="fas fa-comment-dots"></i>
          </div>
          <div class="ai-text">
            <div class="ai-title">Chat Pribadi</div>
            <div class="ai-desc">Chat dengan pengguna lain</div>
          </div>
        </a>
      </div>
    </div>

    <!-- Settings Panel for TTS -->
    <div class="settings-overlay" id="settingsOverlay"></div>
    
    <div class="settings-panel" id="settingsPanel">
      <div class="settings-header">
        <div class="settings-title">Pengaturan Suara</div>
        <button class="hamburger" id="closeSettings">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="settings-content">
        <div class="setting-item">
          <label class="setting-label" for="voiceSelect">Pilih Suara</label>
          <select id="voiceSelect" class="voice-select">
            <option value="">Memuat suara...</option>
          </select>
          <small class="text-gray-500 text-xs mt-1 block">Suara dengan aksen Indonesia direkomendasikan</small>
        </div>
        
        <div class="setting-item">
          <label class="setting-label">Kecepatan Bicara</label>
          <div class="slider-container">
            <span class="slider-value" id="rateValue">1.0</span>
            <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1">
          </div>
          <small class="text-gray-500 text-xs mt-1 block">1.0 = normal (direkomendasikan untuk Bahasa Indonesia)</small>
        </div>
        
        <div class="setting-item">
          <label class="setting-label">Tinggi Nada</label>
          <div class="slider-container">
            <span class="slider-value" id="pitchValue">1.0</span>
            <input type="range" id="pitchSlider" min="0.5" max="2" step="0.1" value="1">
          </div>
        </div>
        
        <div class="setting-item">
          <label class="setting-label">Volume</label>
          <div class="slider-container">
            <span class="slider-value" id="volumeValue">1.0</span>
            <input type="range" id="volumeSlider" min="0.1" max="1" step="0.1" value="1">
          </div>
        </div>
        
        <div class="setting-item">
          <label class="checkbox-label">
            <input type="checkbox" id="autoSpeakCheckbox" checked>
            <span>Baca otomatis respons Nayra AI</span>
          </label>
        </div>
        
        <div class="setting-item">
          <label class="checkbox-label">
            <input type="checkbox" id="voiceInputCheckbox" checked>
            <span>Aktifkan input suara</span>
          </label>
        </div>
        
        <div class="setting-item">
          <label class="checkbox-label">
            <input type="checkbox" id="androidModeCheckbox" checked>
            <span>Mode kompatibilitas Android</span>
          </label>
        </div>
        
        <div class="setting-item">
          <label class="checkbox-label">
            <input type="checkbox" id="indonesianAccentCheckbox" checked>
            <span>Prioritaskan aksen Indonesia</span>
          </label>
        </div>
        
        <div class="settings-buttons">
          <button class="settings-button cancel" id="cancelSettings">Batal</button>
          <button class="settings-button save" id="saveSettings">Simpan</button>
        </div>
      </div>
    </div>

    <!-- Message Input -->
    <div id="messageInputContainer" class="message-input-container">
      <button id="voiceInputButton" class="voice-input-button" title="Input suara">
        <i class="fas fa-microphone"></i>
      </button>
      
      <input type="text" id="messageInput" class="message-input" placeholder="Tanyakan sesuatu tentang sains atau tekan tombol mikrofon...">
      
      <button id="settingsButton" class="settings-button-small" title="Pengaturan suara">
        <i class="fas fa-cog"></i>
      </button>
      
      <button id="sendButton" class="send-button" disabled>
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
      <a href="../dashboard siswa.html" class="nav-item">
        <i class="fas fa-home nav-icon"></i>
        <span>Beranda</span>
      </a>
      <a href="../soal harian/dashboard soal.html" class="nav-item">
        <i class="fas fa-flask nav-icon"></i>
        <span>Soal Harian</span>
      </a>
      <a href="../ai/nayra.html" class="nav-item">
        <i class="fas fa-robot nav-icon"></i>
        <span>Nayra AI</span>
      </a>
      <a href="../kategori/kategori materi.html" class="nav-item">
        <i class="fas fa-chalkboard-teacher nav-icon"></i>
        <span>Materi Harian</span>
      </a>
      <a href="../profil/profil.html" class="nav-item">
        <i class="fas fa-user nav-icon"></i>
        <span>Profil</span>
      </a>
    </nav>
  </div>

  <script>
// ============================
// DOM Elements
// ============================
const messageInput = document.getElementById("messageInput");
const sendButton = document.getElementById("sendButton");

// Avatar elements
const avatarSpeaking = document.getElementById("avatarSpeaking");
const avatarIdle = document.getElementById("avatarIdle");
const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");
const userInputIndicator = document.getElementById("userInputIndicator");
const userInputText = document.getElementById("userInputText");
const tapToSpeakIndicator = document.getElementById("tapToSpeakIndicator");

// Sidebar elements
const hamburgerButton = document.getElementById("hamburgerButton");
const closeSidebar = document.getElementById("closeSidebar");
const sidebar = document.getElementById("sidebar");
const sidebarOverlay = document.getElementById("sidebarOverlay");

// Voice input elements
const voiceInputButton = document.getElementById("voiceInputButton");

// Settings elements
const settingsButton = document.getElementById("settingsButton");
const closeSettings = document.getElementById("closeSettings");
const cancelSettings = document.getElementById("cancelSettings");
const saveSettings = document.getElementById("saveSettings");
const settingsPanel = document.getElementById("settingsPanel");
const settingsOverlay = document.getElementById("settingsOverlay");

// TTS elements
const voiceSelect = document.getElementById("voiceSelect");
const rateSlider = document.getElementById("rateSlider");
const pitchSlider = document.getElementById("pitchSlider");
const volumeSlider = document.getElementById("volumeSlider");
const rateValue = document.getElementById("rateValue");
const pitchValue = document.getElementById("pitchValue");
const volumeValue = document.getElementById("volumeValue");
const autoSpeakCheckbox = document.getElementById("autoSpeakCheckbox");
const voiceInputCheckbox = document.getElementById("voiceInputCheckbox");
const androidModeCheckbox = document.getElementById("androidModeCheckbox");
const indonesianAccentCheckbox = document.getElementById("indonesianAccentCheckbox");

// ============================
// Global Variables
// ============================
let speechSynthesis = window.speechSynthesis;
let voices = [];
let currentUtterance = null;
let isSpeaking = false;
let userHasInteracted = false;
let pendingTTSResponse = null;
let pendingUserMessage = "";

// TTS settings
let ttsSettings = {
  voice: null,
  rate: 1,
  pitch: 1,
  volume: 1,
  autoSpeak: true,
  voiceInputEnabled: true,
  androidMode: true,
  preferIndonesianAccent: true
};

// Speech recognition
let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;
let isListening = false;

// ============================
// VIDEO PLAYBACK FUNCTIONS - FIXED
// ============================

// Function to ensure idle video plays correctly
function ensureIdleVideoPlays() {
  console.log("Memastikan video idle diputar...");
  
  // Ensure video is muted (required for autoplay in many browsers)
  avatarIdle.muted = true;
  
  // Reset video to beginning
  avatarIdle.currentTime = 0;
  
  // Set playback properties
  avatarIdle.loop = true;
  avatarIdle.playsInline = true; // Important for iOS
  
  // Try to play the video
  const playPromise = avatarIdle.play();
  
  if (playPromise !== undefined) {
    playPromise.then(() => {
      console.log("Video idle berhasil diputar");
      avatarIdle.style.display = 'block';
    }).catch(error => {
      console.log("Autoplay diblokir, menunggu interaksi pengguna:", error);
      // Video will play after user interaction
    });
  }
}

// Function to handle video switching
function switchToIdleVideo() {
  console.log("Beralih ke video idle");
  
  // Hide speaking video
  avatarSpeaking.style.display = 'none';
  avatarSpeaking.pause();
  
  // Show and play idle video
  avatarIdle.style.display = 'block';
  ensureIdleVideoPlays();
}

function switchToSpeakingVideo() {
  console.log("Beralih ke video speaking");
  
  // Hide idle video
  avatarIdle.style.display = 'none';
  avatarIdle.pause();
  
  // Show and play speaking video
  avatarSpeaking.style.display = 'block';
  avatarSpeaking.currentTime = 0;
  avatarSpeaking.play();
}

// ============================
// TTS Initialization - OPTIMIZED FOR INDONESIAN ACCENT
// ============================
function initializeTTS() {
  console.log("Menginisialisasi TTS dengan aksen Indonesia...");
  
  // Load saved settings
  const savedSettings = localStorage.getItem('nayraTtsSettings');
  if (savedSettings) {
    ttsSettings = JSON.parse(savedSettings);
  }
  
  // Apply settings to UI
  rateSlider.value = ttsSettings.rate;
  pitchSlider.value = ttsSettings.pitch;
  volumeSlider.value = ttsSettings.volume;
  autoSpeakCheckbox.checked = ttsSettings.autoSpeak;
  voiceInputCheckbox.checked = ttsSettings.voiceInputEnabled;
  androidModeCheckbox.checked = ttsSettings.androidMode;
  indonesianAccentCheckbox.checked = ttsSettings.preferIndonesianAccent;
  
  updateSliderValues();
  
  // Initialize voices - prioritizing Indonesian
  loadVoices();
  
  // Voice loading handler
  if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = function() {
      console.log("Suara berubah");
      loadVoices();
    };
  }
  
  // Initial voice load
  setTimeout(loadVoices, 500);
}

// Load voices with Indonesian priority
function loadVoices() {
  voices = speechSynthesis.getVoices();
  console.log(`Memuat ${voices.length} suara`);
  
  if (voices.length > 0) {
    populateVoiceList();
    
    // Auto-select Indonesian voice if available and preferred
    if ((!ttsSettings.voice || ttsSettings.voice === "") && ttsSettings.preferIndonesianAccent) {
      selectBestIndonesianVoice();
    } else if (ttsSettings.voice) {
      // Ensure the saved voice still exists
      const savedVoiceExists = voices.some(voice => voice.name === ttsSettings.voice);
      if (!savedVoiceExists) {
        selectBestIndonesianVoice();
      }
    }
  } else {
    // Retry for browsers that load voices async
    console.log("Tidak ada suara ditemukan, mencoba lagi...");
    setTimeout(loadVoices, 1000);
  }
}

// Select the best Indonesian voice
function selectBestIndonesianVoice() {
  // Find Indonesian voices
  const indonesianVoices = getIndonesianVoices();
  
  if (indonesianVoices.length > 0) {
    // Priority: 1. Google Indonesian, 2. Natural/Neural Indonesian, 3. Any Indonesian
    let selectedVoice = null;
    
    // 1. Google Indonesian voices (usually best quality)
    selectedVoice = indonesianVoices.find(v => v.name.includes('Google') && (v.name.includes('Indonesian') || v.name.includes('Indonesia')));
    
    // 2. Natural/Neural Indonesian voices
    if (!selectedVoice) {
      selectedVoice = indonesianVoices.find(v => 
        (v.name.includes('Natural') || v.name.includes('Neural') || v.name.includes('Premium')) &&
        (v.name.includes('Indonesian') || v.lang === 'id-ID')
      );
    }
    
    // 3. Any female Indonesian voice
    if (!selectedVoice) {
      selectedVoice = indonesianVoices.find(v => 
        v.name.includes('Female') || 
        v.name.includes('Woman') ||
        v.name.includes('Perempuan') ||
        v.gender === 'female'
      );
    }
    
    // 4. First available Indonesian voice
    if (!selectedVoice && indonesianVoices.length > 0) {
      selectedVoice = indonesianVoices[0];
    }
    
    if (selectedVoice) {
      ttsSettings.voice = selectedVoice.name;
      voiceSelect.value = selectedVoice.name;
      console.log("Memilih suara Indonesia:", selectedVoice.name, "Bahasa:", selectedVoice.lang);
    }
  } else if (voices.length > 0) {
    // Fallback to best available voice
    const femaleVoices = voices.filter(voice => 
      voice.name.includes('Female') || 
      voice.name.includes('Woman') ||
      voice.gender === 'female'
    );
    
    if (femaleVoices.length > 0) {
      ttsSettings.voice = femaleVoices[0].name;
      voiceSelect.value = femaleVoices[0].name;
      console.log("Memilih suara perempuan:", femaleVoices[0].name);
    } else {
      ttsSettings.voice = voices[0].name;
      voiceSelect.value = voices[0].name;
      console.log("Memilih suara pertama yang tersedia:", voices[0].name);
    }
  }
}

// Get Indonesian voices
function getIndonesianVoices() {
  return voices.filter(voice => 
    voice.lang.startsWith('id') || 
    voice.lang === 'id-ID' ||
    voice.lang === 'id' ||
    voice.name.toLowerCase().includes('indonesian') ||
    voice.name.toLowerCase().includes('indonesia') ||
    voice.name.toLowerCase().includes('bahasa')
  );
}

// Populate voice list with Indonesian priority
function populateVoiceList() {
  voiceSelect.innerHTML = '<option value="">Pilih suara...</option>';
  
  if (voices.length === 0) {
    voiceSelect.innerHTML = '<option value="">Tidak ada suara yang tersedia</option>';
    return;
  }
  
  // Get categorized voices
  const indonesianVoices = getIndonesianVoices();
  const naturalVoices = voices.filter(voice => 
    (voice.name.includes('Natural') || voice.name.includes('Neural') || voice.name.includes('Premium')) &&
    !indonesianVoices.includes(voice)
  );
  
  const femaleVoices = voices.filter(voice => 
    (voice.name.includes('Female') || 
     voice.name.includes('Woman') ||
     voice.name.includes('Perempuan') ||
     voice.gender === 'female') &&
    !indonesianVoices.includes(voice) &&
    !naturalVoices.includes(voice)
  );
  
  const otherVoices = voices.filter(voice => 
    !indonesianVoices.includes(voice) &&
    !naturalVoices.includes(voice) &&
    !femaleVoices.includes(voice)
  );
  
  // Add Indonesian voices first if preferred
  if (indonesianVoices.length > 0) {
    const optgroup = document.createElement('optgroup');
    optgroup.label = 'ðŸŽ¯ Suara Bahasa Indonesia (Direkomendasikan)';
    indonesianVoices.forEach(voice => {
      const option = createVoiceOption(voice);
      optgroup.appendChild(option);
    });
    voiceSelect.appendChild(optgroup);
  }
  
  // Add natural voices
  if (naturalVoices.length > 0) {
    const optgroup = document.createElement('optgroup');
    optgroup.label = 'ðŸŒŸ Suara Natural';
    naturalVoices.forEach(voice => {
      const option = createVoiceOption(voice);
      optgroup.appendChild(option);
    });
    voiceSelect.appendChild(optgroup);
  }
  
  // Add female voices
  if (femaleVoices.length > 0) {
    const optgroup = document.createElement('optgroup');
    optgroup.label = 'ðŸ‘© Suara Perempuan';
    femaleVoices.forEach(voice => {
      const option = createVoiceOption(voice);
      optgroup.appendChild(option);
    });
    voiceSelect.appendChild(optgroup);
  }
  
  // Add other voices
  if (otherVoices.length > 0) {
    const optgroup = document.createElement('optgroup');
    optgroup.label = 'ðŸ”Š Suara Lainnya';
    otherVoices.forEach(voice => {
      const option = createVoiceOption(voice);
      optgroup.appendChild(option);
    });
    voiceSelect.appendChild(optgroup);
  }
}

// Create voice option element
function createVoiceOption(voice) {
  const option = document.createElement('option');
  option.value = voice.name;
  
  // Add emoji for voice type
  let emoji = 'ðŸ”Š';
  if (voice.name.includes('Google') && voice.name.includes('Indonesian')) emoji = 'ðŸŽ¯';
  else if (voice.name.includes('Natural') || voice.name.includes('Neural')) emoji = 'ðŸŒŸ';
  else if (voice.name.includes('Female') || voice.name.includes('Woman')) emoji = 'ðŸ‘©';
  else if (voice.name.includes('Male') || voice.name.includes('Man')) emoji = 'ðŸ‘¨';
  
  option.textContent = `${emoji} ${voice.name} (${voice.lang})`;
  
  if (ttsSettings.voice && voice.name === ttsSettings.voice) {
    option.selected = true;
  }
  
  return option;
}

// Update slider values
function updateSliderValues() {
  rateValue.textContent = rateSlider.value;
  pitchValue.textContent = pitchSlider.value;
  volumeValue.textContent = volumeSlider.value;
}

// ============================
// Avatar Status Management - UPDATED WITH VIDEO FUNCTIONS
// ============================
function updateAvatarStatus(state, userMessage = '') {
  switch(state) {
    case 'speaking':
      statusDot.className = 'status-dot speaking';
      statusText.textContent = 'Sedang Berbicara';
      userInputIndicator.style.display = 'none';
      tapToSpeakIndicator.style.display = 'none';
      
      // Show speaking video, hide idle
      switchToSpeakingVideo();
      break;
      
    case 'listening':
      statusDot.className = 'status-dot listening';
      statusText.textContent = 'Sedang Mendengarkan';
      switchToIdleVideo();
      break;
      
    case 'thinking':
      statusDot.className = 'status-dot';
      statusText.textContent = 'Sedang Berpikir';
      if (userMessage) {
        userInputText.textContent = userMessage;
        userInputIndicator.style.display = 'flex';
      }
      switchToIdleVideo();
      break;
      
    case 'ready':
      statusDot.className = 'status-dot ready';
      statusText.textContent = 'Siap Berbicara';
      tapToSpeakIndicator.style.display = 'block';
      switchToIdleVideo();
      break;
      
    case 'idle':
    default:
      statusDot.className = 'status-dot idle';
      statusText.textContent = 'Siap Mendengarkan';
      userInputIndicator.style.display = 'none';
      tapToSpeakIndicator.style.display = 'none';
      switchToIdleVideo();
      break;
  }
}

// ============================
// TTS Functions - OPTIMIZED FOR INDONESIAN ACCENT
// ============================
function speakText(text, userMessage = '', fromUserInteraction = false) {
  if (!speechSynthesis || !ttsSettings.voiceInputEnabled) {
    console.error('TTS tidak tersedia atau dinonaktifkan');
    return false;
  }
  
  // Android requires user interaction
  if (ttsSettings.androidMode && !fromUserInteraction && !userHasInteracted) {
    console.log('Mode Android: Menyimpan TTS untuk interaksi pengguna');
    pendingTTSResponse = text;
    pendingUserMessage = userMessage;
    updateAvatarStatus('ready');
    return false;
  }
  
  // Stop any current speech
  if (isSpeaking) {
    speechSynthesis.cancel();
  }
  
  // Optimize text for Indonesian pronunciation
  const optimizedText = optimizeIndonesianText(text);
  
  const utterance = new SpeechSynthesisUtterance(optimizedText);
  
  // Find selected voice
  const selectedVoice = voices.find(voice => voice.name === ttsSettings.voice);
  if (selectedVoice) {
    utterance.voice = selectedVoice;
    utterance.lang = selectedVoice.lang || 'id-ID';
    console.log("Menggunakan suara:", selectedVoice.name, "Bahasa:", selectedVoice.lang);
  } else if (voices.length > 0) {
    // Try to find Indonesian voice if preferred
    if (ttsSettings.preferIndonesianAccent) {
      const indonesianVoice = voices.find(voice => voice.lang.startsWith('id'));
      if (indonesianVoice) {
        utterance.voice = indonesianVoice;
        utterance.lang = indonesianVoice.lang;
      } else {
        utterance.voice = voices[0];
        utterance.lang = voices[0].lang;
      }
    } else {
      utterance.voice = voices[0];
      utterance.lang = voices[0].lang;
    }
  } else {
    utterance.lang = 'id-ID';
  }
  
  // Apply settings optimized for Indonesian
  utterance.rate = parseFloat(ttsSettings.rate);
  utterance.pitch = parseFloat(ttsSettings.pitch);
  utterance.volume = parseFloat(ttsSettings.volume);
  
  // Adjust rate for Indonesian (slightly slower for clarity)
  if (utterance.lang.startsWith('id')) {
    utterance.rate = Math.min(utterance.rate, 1.1); // Cap at 1.1 for Indonesian
  }
  
  // Update avatar
  updateAvatarStatus('speaking', userMessage);
  
  // Event handlers
  utterance.onstart = function() {
    console.log('TTS dimulai');
    isSpeaking = true;
  };
  
  utterance.onend = function() {
    console.log('TTS selesai');
    isSpeaking = false;
    updateAvatarStatus('idle');
  };
  
  utterance.onerror = function(event) {
    console.error('TTS error:', event);
    isSpeaking = false;
    updateAvatarStatus('idle');
    
    // Show user-friendly error
    if (event.error === 'not-allowed') {
      showNotification('Izinkan audio di pengaturan browser');
    }
  };
  
  try {
    speechSynthesis.speak(utterance);
    return true;
  } catch (error) {
    console.error('Gagal berbicara:', error);
    updateAvatarStatus('idle');
    return false;
  }
}

// Optimize text for better Indonesian pronunciation
function optimizeIndonesianText(text) {
  return text
    // Common Indonesian pronunciation fixes
    .replace(/(\d+)Â°/g, '$1 derajat')
    .replace(/cmÂ³/g, 'sentimeter kubik')
    .replace(/mÂ³/g, 'meter kubik')
    .replace(/km\/jam/g, 'kilometer per jam')
    .replace(/m\/s/g, 'meter per detik')
    
    // Scientific terms in Indonesian
    .replace(/photosynthesis/gi, 'fotosintesis')
    .replace(/gravity/gi, 'gravitasi')
    .replace(/molecule/gi, 'molekul')
    .replace(/atom/gi, 'atom')
    .replace(/element/gi, 'unsur')
    .replace(/compound/gi, 'senyawa')
    .replace(/velocity/gi, 'kecepatan')
    .replace(/acceleration/gi, 'percepatan')
    .replace(/energy/gi, 'energi')
    .replace(/force/gi, 'gaya')
    
    // Add pauses for better comprehension
    .replace(/([.!?]) /g, '$1  ')
    .replace(/, /g, ',  ')
    .replace(/;/g, '; ')
    .replace(/:/g, ': ')
    
    // Remove extra whitespace
    .trim();
}

// Function to trigger pending TTS
function triggerPendingTTS() {
  if (pendingTTSResponse) {
    const success = speakText(pendingTTSResponse, pendingUserMessage, true);
    if (success) {
      pendingTTSResponse = null;
      pendingUserMessage = "";
    }
  }
}

// Stop TTS
function stopSpeaking() {
  if (isSpeaking) {
    speechSynthesis.cancel();
    isSpeaking = false;
    updateAvatarStatus('idle');
  }
}

// ============================
// Speech Recognition
// ============================
function initializeSpeechRecognition() {
  if (!SpeechRecognition) {
    console.warn('Speech recognition tidak didukung');
    voiceInputButton.disabled = true;
    voiceInputButton.title = 'Input suara tidak didukung';
    return;
  }
  
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = true;
  recognition.lang = 'id-ID'; // Set to Indonesian
  
  recognition.onstart = function() {
    isListening = true;
    voiceInputButton.classList.add('listening');
    voiceInputButton.innerHTML = '<i class="fas fa-stop"></i>';
    updateAvatarStatus('listening');
  };
  
  recognition.onresult = function(event) {
    const transcript = Array.from(event.results)
      .map(result => result[0])
      .map(result => result.transcript)
      .join('');
    
    messageInput.value = transcript;
    sendButton.disabled = !transcript.trim();
  };
  
  recognition.onend = function() {
    isListening = false;
    voiceInputButton.classList.remove('listening');
    voiceInputButton.innerHTML = '<i class="fas fa-microphone"></i>';
    updateAvatarStatus('idle');
  };
  
  recognition.onerror = function(event) {
    console.error('Speech recognition error:', event.error);
    isListening = false;
    voiceInputButton.classList.remove('listening');
    voiceInputButton.innerHTML = '<i class="fas fa-microphone"></i>';
    updateAvatarStatus('idle');
    
    if (event.error === 'not-allowed') {
      showNotification('Izinkan mikrofon di pengaturan browser');
    }
  };
}

// ============================
// Message Handling
// ============================
async function sendMessage(fromUserInteraction = false) {
  if (!messageInput.value.trim()) return;
  
  const messageText = messageInput.value.trim();
  
  // Show thinking indicator
  updateAvatarStatus('thinking', messageText);
  
  // Clear input
  messageInput.value = "";
  sendButton.disabled = true;
  
  try {
    // Get AI response
    const response = await fetchGroqResponse(messageText);
    
    // Auto-speak if enabled
    if (ttsSettings.autoSpeak && ttsSettings.voiceInputEnabled) {
      setTimeout(() => {
        speakText(response, messageText, fromUserInteraction);
      }, 500);
    } else {
      updateAvatarStatus('idle');
    }
  } catch (error) {
    const errorMessage = "Maaf, terjadi masalah. Silakan coba lagi.";
    
    if (ttsSettings.autoSpeak && ttsSettings.voiceInputEnabled) {
      setTimeout(() => {
        speakText(errorMessage, messageText, fromUserInteraction);
      }, 500);
    } else {
      updateAvatarStatus('idle');
    }
    console.error("Error:", error);
  }
}

// ============================
// API Integration
// ============================
async function fetchGroqResponse(message) {
  const apiKey = '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';
  const apiUrl = 'https://api.groq.com/openai/v1/chat/completions';
  
  const systemPrompt = `Anda adalah Nayra AI, asisten sains yang ramah dan membantu dalam aplikasi TETA SAINS. 
  Fokuslah pada topik sains seperti fisika, kimia, biologi, matematika, dan ilmu pengetahuan lainnya. 
  
  Tugas Anda:
  1. Berikan penjelasan yang jelas, mudah dipahami, dan relevan dengan pertanyaan sains
  2. Bantu dengan pemecahan masalah dan konsep sains
  3. Berikan contoh yang relevan dan aplikatif
  4. Jika pertanyaan di luar topik sains, dengan sopan arahkan kembali ke topik sains
  5. Gunakan bahasa Indonesia yang baik dan sederhana
  6. Sesuaikan penjelasan dengan tingkat pengetahuan siswa
  7. Gunakan istilah Indonesia yang tepat untuk istilah sains
  
  Anda adalah asisten khusus untuk aplikasi pembelajaran sains TETA SAINS.`;
  
  const requestBody = {
    model: 'llama-3.1-8b-instant',
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: message }
    ],
    temperature: 0.7,
    max_tokens: 1024,
    top_p: 1,
    stream: false
  };
  
  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    return data.choices[0].message.content;
  } catch (error) {
    console.error("Error calling Groq API:", error);
    return getFallbackResponse(message);
  }
}

function getFallbackResponse(message) {
  const lowerMessage = message.toLowerCase();
  
  if (lowerMessage.includes('fisika') || lowerMessage.includes('fisik')) {
    return "Fisika adalah ilmu yang mempelajari tentang materi, energi, dan interaksi antara keduanya. Topik fisika mencakup mekanika, termodinamika, elektromagnetisme, dan banyak lagi. Apakah ada topik fisika khusus yang ingin Anda pelajari?";
  } else if (lowerMessage.includes('kimia')) {
    return "Kimia adalah ilmu yang mempelajari tentang komposisi, struktur, sifat, dan perubahan materi. Topik kimia meliputi atom, molekul, reaksi kimia, dan tabel periodik. Ada yang spesifik tentang kimia yang ingin Anda tanyakan?";
  } else if (lowerMessage.includes('biologi') || lowerMessage.includes('biolog')) {
    return "Biologi adalah ilmu yang mempelajari tentang kehidupan dan organisme hidup. Topik biologi mencakup sel, genetika, evolusi, ekosistem, dan anatomi. Apakah ada aspek biologi tertentu yang ingin Anda ketahui?";
  } else if (lowerMessage.includes('matematika') || lowerMessage.includes('matematik')) {
    return "Matematika adalah ilmu tentang angka, struktur, ruang, dan perubahan. Topik matematika meliputi aljabar, geometri, kalkulus, dan statistik. Ada pertanyaan matematika khusus yang bisa saya bantu?";
  } else if (lowerMessage.includes('halo') || lowerMessage.includes('hai') || lowerMessage.includes('hi')) {
    return "Halo! Saya Nayra AI, asisten sains Anda di TETA SAINS. Saya siap membantu dengan pertanyaan seputar sains. Apa yang ingin Anda pelajari hari ini?";
  } else {
    return "Terima kasih atas pertanyaannya! Sebagai asisten sains Nayra AI di TETA SAINS, saya khusus membantu dengan topik fisika, kimia, biologi, matematika, dan ilmu pengetahuan lainnya. Bisakah Anda memberikan lebih detail tentang apa yang ingin Anda ketahui?";
  }
}

// ============================
// UI Functions
// ============================
function toggleSidebar() {
  sidebar.classList.toggle("active");
  sidebarOverlay.classList.toggle("active");
}

function closeSidebarFunc() {
  sidebar.classList.remove("active");
  sidebarOverlay.classList.remove("active");
}

function toggleSettingsPanel() {
  settingsPanel.classList.toggle("active");
  settingsOverlay.classList.toggle("active");
}

function closeSettingsPanel() {
  settingsPanel.classList.remove("active");
  settingsOverlay.classList.remove("active");
}

function saveTtsSettings() {
  ttsSettings.voice = voiceSelect.value;
  ttsSettings.rate = parseFloat(rateSlider.value);
  ttsSettings.pitch = parseFloat(pitchSlider.value);
  ttsSettings.volume = parseFloat(volumeSlider.value);
  ttsSettings.autoSpeak = autoSpeakCheckbox.checked;
  ttsSettings.voiceInputEnabled = voiceInputCheckbox.checked;
  ttsSettings.androidMode = androidModeCheckbox.checked;
  ttsSettings.preferIndonesianAccent = indonesianAccentCheckbox.checked;
  
  localStorage.setItem('nayraTtsSettings', JSON.stringify(ttsSettings));
  voiceInputButton.disabled = !ttsSettings.voiceInputEnabled;
  
  // Reload voices to apply changes
  loadVoices();
  
  closeSettingsPanel();
  showNotification('Pengaturan suara disimpan');
}

function showNotification(message) {
  const notification = document.createElement('div');
  notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

// Test Indonesian pronunciation
function testIndonesianVoice() {
  if (voices.length > 0 && ttsSettings.voiceInputEnabled) {
    const testText = "Halo! Saya Nayra AI dengan aksen Indonesia. Siap membantu Anda belajar sains.";
    speakText(testText, "", true);
  }
}

// ============================
// Event Listeners - UPDATED FOR VIDEO PLAYBACK
// ============================
// Sidebar
hamburgerButton.addEventListener("click", toggleSidebar);
closeSidebar.addEventListener("click", closeSidebarFunc);
sidebarOverlay.addEventListener("click", closeSidebarFunc);

// Settings
settingsButton.addEventListener("click", toggleSettingsPanel);
closeSettings.addEventListener("click", closeSettingsPanel);
cancelSettings.addEventListener("click", closeSettingsPanel);
settingsOverlay.addEventListener("click", closeSettingsPanel);
saveSettings.addEventListener("click", saveTtsSettings);

// Sliders
rateSlider.addEventListener('input', function() {
  rateValue.textContent = this.value;
});

pitchSlider.addEventListener('input', function() {
  pitchValue.textContent = this.value;
});

volumeSlider.addEventListener('input', function() {
  volumeValue.textContent = this.value;
});

// Voice select
voiceSelect.addEventListener('change', function() {
  console.log("Selected voice:", this.value);
  // Test the selected voice
  if (this.value && ttsSettings.autoSpeak) {
    setTimeout(testIndonesianVoice, 500);
  }
});

// Indonesian accent checkbox
indonesianAccentCheckbox.addEventListener('change', function() {
  if (this.checked) {
    console.log("Prioritas aksen Indonesia diaktifkan");
    selectBestIndonesianVoice();
  }
});

// Message input
messageInput.addEventListener("input", () => {
  sendButton.disabled = !messageInput.value.trim();
});

// Send button - CRITICAL FOR ANDROID
sendButton.addEventListener("click", () => {
  userHasInteracted = true;
  sendMessage(true);
});

// Enter key
messageInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && messageInput.value.trim()) {
    userHasInteracted = true;
    sendMessage(true);
  }
});

// Voice input button
voiceInputButton.addEventListener("click", function() {
  userHasInteracted = true;
  if (!recognition || !ttsSettings.voiceInputEnabled) {
    showNotification('Input suara dinonaktifkan. Aktifkan di pengaturan.');
    return;
  }
  
  if (isListening) {
    recognition.stop();
  } else {
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(function(stream) {
        stream.getTracks().forEach(track => track.stop());
        recognition.start();
      })
      .catch(function(err) {
        console.error('Microphone access denied:', err);
        alert('Izinkan akses mikrofon di pengaturan browser Anda.');
      });
  }
});

// Tap to speak indicator
tapToSpeakIndicator.addEventListener("click", function() {
  userHasInteracted = true;
  triggerPendingTTS();
});

// Avatar click for pending TTS
avatarIdle.addEventListener("click", function() {
  if (pendingTTSResponse) {
    userHasInteracted = true;
    triggerPendingTTS();
  } else if (ttsSettings.autoSpeak) {
    // Play welcome message if no pending response
    userHasInteracted = true;
    speakText("Halo! Saya Nayra AI dengan aksen Indonesia. Silakan ajukan pertanyaan sains Anda.", "", true);
  }
});

avatarSpeaking.addEventListener("click", function() {
  if (isSpeaking) {
    stopSpeaking();
  }
});

// ============================
// Initialize Application - UPDATED FOR VIDEO
// ============================
document.addEventListener('DOMContentLoaded', function() {
  console.log("DOM dimuat, menginisialisasi aplikasi...");
  
  // Initialize TTS dengan aksen Indonesia
  initializeTTS();
  
  // Initialize speech recognition
  initializeSpeechRecognition();
  
  // Setup initial interaction listener
  setupInitialInteraction();
  
  // Check if Android
  const isAndroid = /Android/i.test(navigator.userAgent);
  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  console.log("Android:", isAndroid, "iOS:", isIOS);
  
  if (isAndroid) {
    showNotification("Mode Android aktif. Ketuk layar untuk memulai dengan aksen Indonesia.");
  }
  
  // Test TTS availability
  setTimeout(() => {
    if (voices.length > 0 && !userHasInteracted) {
      console.log("TTS siap dengan", voices.length, "suara tersedia");
      console.log("Suara terpilih:", ttsSettings.voice);
      
      // Show voice info
      const indonesianVoices = getIndonesianVoices();
      if (indonesianVoices.length > 0) {
        console.log("Suara Indonesia ditemukan:", indonesianVoices.length);
      } else {
        console.log("Tidak ada suara Indonesia spesifik, menggunakan yang terbaik");
      }
    }
  }, 2000);
});

// Handle page visibility changes - UPDATED FOR VIDEO
document.addEventListener('visibilitychange', function() {
  if (document.hidden) {
    // Page is hidden, stop any ongoing speech
    if (isSpeaking) {
      speechSynthesis.cancel();
    }
    if (isListening) {
      recognition.stop();
    }
    // Pause videos when page is hidden
    avatarIdle.pause();
    avatarSpeaking.pause();
  } else {
    // Page is visible again, resume idle video
    console.log("Halaman terlihat lagi, memutar video idle...");
    ensureIdleVideoPlays();
  }
});

// Initial user interaction listener - UPDATED FOR VIDEO
function setupInitialInteraction() {
  const firstInteractionHandler = function() {
    userHasInteracted = true;
    console.log("Pengguna telah berinteraksi, TTS sekarang dapat bekerja");
    
    // Start video playback after user interaction
    ensureIdleVideoPlays();
    
    // Remove listeners
    document.removeEventListener('click', firstInteractionHandler);
    document.removeEventListener('touchstart', firstInteractionHandler);
    document.removeEventListener('keydown', firstInteractionHandler);
    
    // Play welcome message if enabled
    if (ttsSettings.autoSpeak && ttsSettings.voiceInputEnabled && !isSpeaking) {
      setTimeout(() => {
        speakText("Halo! Saya Nayra AI dengan aksen Indonesia, asisten sains Anda di TETA SAINS. Silakan ajukan pertanyaan sains Anda.", "", true);
      }, 1000);
    }
  };
  
  // Listen for any user interaction
  document.addEventListener('click', firstInteractionHandler);
  document.addEventListener('touchstart', firstInteractionHandler);
  document.addEventListener('keydown', firstInteractionHandler);
  
  // Auto-show welcome after 3 seconds if no interaction
  setTimeout(() => {
    if (!userHasInteracted) {
      showNotification("Ketuk layar untuk memulai percakapan dengan Nayra AI");
    }
  }, 3000);
  
  // Try to play idle video immediately (muted)
  ensureIdleVideoPlays();
}
    </script>
</body>
</html>
