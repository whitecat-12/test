<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nayra AI - TETA SAINS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #9999ff;
      --secondary: #7a7ae6;
    }
    
    body {
      font-family: 'Baloo 2', cursive;
      background-color: #f8fafc;
    }
    
    .app-container {
      max-width: 414px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      position: relative;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      max-width: 414px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
      background: white;
      z-index: 10;
      height: 70px;
      display: flex;
      align-items: center;
    }
    
    .nav-icon {
      transition: all 0.3s ease;
      font-size: 1.25rem;
    }
    
    .nav-icon.active {
      transform: translateY(-5px);
      color: var(--primary);
    }
    
    .app-logo {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .app-logo-icon {
      background-color: #9999ff;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
    }
    
    .app-name {
      font-weight: 700;
      font-size: 1.25rem;
      color: #9999ff;
    }

    /* Chat styles */
    .chat-container {
      padding-bottom: 80px;
    }
    
    .chat-header {
      position: sticky;
      top: 0;
      background: white;
      z-index: 5;
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .search-container {
      margin-top: 0.5rem;
      position: relative;
    }
    
    .search-input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border-radius: 1.5rem;
      border: 1px solid #e2e8f0;
      font-size: 0.875rem;
      outline: none;
      transition: all 0.3s ease;
    }
    
    .search-input:focus {
      border-color: #9999ff;
      box-shadow: 0 0 0 3px rgba(153, 153, 255, 0.1);
    }
    
    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
    }
    
    .user-list {
      padding: 0.5rem;
    }
    
    .user-item {
      display: flex;
      align-items: center;
      padding: 0.75rem;
      border-radius: 0.75rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .user-item:hover {
      background-color: #f3f4f6;
    }
    
    .user-item.active {
      background-color: #e0f2fe;
    }
    
    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      margin-right: 0.75rem;
      font-size: 1.125rem;
    }
    
    .user-info {
      flex: 1;
    }
    
    .user-name {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 0.25rem;
    }
    
    .user-status {
      font-size: 0.75rem;
      color: #6b7280;
    }
    
    .no-users {
      text-align: center;
      padding: 2rem;
      color: #6b7280;
    }
    
    .chat-messages {
      padding: 1rem;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }
    
    .message {
      margin-bottom: 1rem;
      display: flex;
    }
    
    .message.sent {
      justify-content: flex-end;
    }
    
    .message.received {
      justify-content: flex-start;
    }
    
    .message-bubble {
      max-width: 70%;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      position: relative;
    }
    
    .message.sent .message-bubble {
      background-color: #9999ff;
      color: white;
      border-bottom-right-radius: 0.25rem;
    }
    
    .message.received .message-bubble {
      background-color: #f3f4f6;
      color: #1f2937;
      border-bottom-left-radius: 0.25rem;
    }
    
    .message-time {
      font-size: 0.75rem;
      margin-top: 0.25rem;
      opacity: 0.7;
    }
    
    .message-input-container {
      position: fixed;
      bottom: 70px;
      left: 0;
      right: 0;
      max-width: 414px;
      margin: 0 auto;
      background: white;
      padding: 0.75rem;
      border-top: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 9;
    }
    
    .message-input {
      flex: 1;
      padding: 0.75rem 1rem;
      border-radius: 1.5rem;
      border: 1px solid #e2e8f0;
      outline: none;
      font-size: 0.875rem;
    }
    
    .message-input:focus {
      border-color: #9999ff;
    }
    
    .send-button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #9999ff;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .send-button:hover {
      background-color: #7a7ae6;
    }
    
    .send-button:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }
    
    /* Loading indicator */
    .loading {
      display: flex;
      justify-content: center;
      padding: 1rem;
      color: #6b7280;
    }
    
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #e2e8f0;
      border-top: 2px solid #9999ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100vh;
      background-color: white;
      box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
      transition: right 0.3s ease;
      z-index: 1001;
      overflow-y: auto;
    }
    
    .sidebar.active {
      right: 0;
    }
    
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .sidebar-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .hamburger {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #9999ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .hamburger:hover {
      background-color: #7a7ae6;
      transform: scale(1.05);
    }
    
    .sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .sidebar-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #9999ff;
    }
    
    .sidebar-content {
      padding: 1rem;
    }
    
    .ai-feature {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      background-color: #f7f9fc;
      transition: all 0.3s ease;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
    }
    
    .ai-feature:hover {
      background-color: #e6f0ff;
      transform: translateY(-2px);
    }
    
    .ai-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #9999ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-right: 1rem;
    }
    
    .ai-text {
      flex: 1;
    }
    
    .ai-title {
      font-weight: 600;
      color: #2d3748;
    }
    
    .ai-desc {
      font-size: 0.875rem;
      color: #718096;
    }
    
    /* Style khusus untuk bottom nav items */
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      text-decoration: none;
      flex: 1;
      height: 100%;
      padding: 0.5rem 0;
    }
    
    .nav-item span {
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }
    
    /* Nayra AI specific styles */
    .nayra-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-color: #9999ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-right: 0.75rem;
      font-size: 1.125rem;
    }
    
    .thinking-indicator {
      display: flex;
      align-items: center;
      color: #6b7280;
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }
    
    .thinking-dots {
      display: flex;
      margin-left: 0.5rem;
    }
    
    .thinking-dots span {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background-color: #6b7280;
      margin: 0 1px;
      animation: pulse 1.5s infinite ease-in-out;
    }
    
    .thinking-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .thinking-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 1; }
    }
    
    /* Voice input button styles */
    .voice-input-button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #f3f4f6;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .voice-input-button:hover {
      background-color: #e5e7eb;
    }
    
    .voice-input-button.listening {
      background-color: #ef4444;
      color: white;
      animation: pulse 1.5s infinite;
    }
    
    /* TTS button styles */
    .tts-button {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: #f3f4f6;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.875rem;
      margin-left: 0.5rem;
      margin-top: 0.25rem;
    }
    
    .tts-button:hover {
      background-color: #9999ff;
      color: white;
    }
    
    .tts-button.playing {
      background-color: #9999ff;
      color: white;
    }
    
    .message-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 0.25rem;
      padding-left: 0.5rem;
    }
    
    /* Settings panel for TTS */
    .settings-panel {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100vh;
      background-color: white;
      box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
      transition: right 0.3s ease;
      z-index: 1002;
      overflow-y: auto;
    }
    
    .settings-panel.active {
      right: 0;
    }
    
    .settings-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1001;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .settings-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .settings-header {
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .settings-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #9999ff;
    }
    
    .settings-content {
      padding: 1rem;
    }
    
    .setting-item {
      margin-bottom: 1.5rem;
    }
    
    .setting-label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #2d3748;
    }
    
    .voice-select {
      width: 100%;
      padding: 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #e2e8f0;
      font-size: 0.875rem;
      outline: none;
      transition: all 0.3s ease;
    }
    
    .voice-select:focus {
      border-color: #9999ff;
      box-shadow: 0 0 0 3px rgba(153, 153, 255, 0.1);
    }
    
    .slider-container {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 0.5rem;
    }
    
    .slider-value {
      min-width: 40px;
      text-align: center;
      font-weight: 600;
      color: #9999ff;
    }
    
    input[type="range"] {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: #e2e8f0;
      outline: none;
      -webkit-appearance: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #9999ff;
      cursor: pointer;
    }
    
    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 0.875rem;
      color: #4b5563;
    }
    
    .checkbox-label input {
      margin-right: 0.5rem;
    }
    
    .settings-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .settings-button {
      flex: 1;
      padding: 0.75rem;
      border-radius: 0.5rem;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .settings-button.save {
      background-color: #9999ff;
      color: white;
    }
    
    .settings-button.save:hover {
      background-color: #7a7ae6;
    }
    
    .settings-button.cancel {
      background-color: #f3f4f6;
      color: #6b7280;
    }
    
    .settings-button.cancel:hover {
      background-color: #e5e7eb;
    }
    
    /* Settings button in message input */
    .settings-button-small {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #f3f4f6;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .settings-button-small:hover {
      background-color: #e5e7eb;
    }
    
    /* Improved mobile styles */
    @media (max-width: 414px) {
      .user-item {
        padding: 0.625rem;
      }
      
      .user-avatar {
        width: 42px;
        height: 42px;
        font-size: 1rem;
      }
      
      .message-bubble {
        max-width: 80%;
      }
      
      .message-input-container {
        padding: 0.625rem;
      }
      
      .sidebar {
        width: 280px;
        right: -280px;
      }
      
      .settings-panel {
        width: 280px;
        right: -280px;
      }
      
      .bottom-nav {
        height: 65px;
      }
      
      .nav-icon {
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Mobile App Container -->
  <div class="app-container">
    <!-- App Header -->
    <header class="bg-white p-4 border-b border-gray-200">
      <div class="flex justify-between items-center">
        <div class="app-logo">
          <div class="app-logo-icon">
            <i class="fas fa-robot"></i>
          </div>
          <h1 class="app-name">NAYRA AI</h1>
        </div>
        <div class="flex items-center space-x-3">
          <div class="hamburger" id="hamburgerButton">
            <i class="fas fa-bars"></i>
          </div>
        </div>
      </div>
    </header>

    <!-- Sidebar -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">Menu AI</div>
        <button class="hamburger" id="closeSidebar">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="sidebar-content">
        <!-- Link ke forum.html -->
        <a href="../media social/forum.html" class="ai-feature">
          <div class="ai-icon">
            <i class="fas fa-comments"></i>
          </div>
          <div class="ai-text">
            <div class="ai-title">Forum Diskusi</div>
            <div class="ai-desc">Diskusi terbuka dengan semua pengguna</div>
          </div>
        </a>
        
        <!-- Link ke chat pribadi -->
        <a href="../pesan/pesan.html" class="ai-feature">
          <div class="ai-icon">
            <i class="fas fa-comment-dots"></i>
          </div>
          <div class="ai-text">
            <div class="ai-title">Chat Pribadi</div>
            <div class="ai-desc">Chat dengan pengguna lain</div>
          </div>
        </a>
      </div>
    </div>

    <!-- Settings Panel for TTS -->
    <div class="settings-overlay" id="settingsOverlay"></div>
    
    <div class="settings-panel" id="settingsPanel">
      <div class="settings-header">
        <div class="settings-title">Pengaturan Suara</div>
        <button class="hamburger" id="closeSettings">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="settings-content">
        <div class="setting-item">
          <label class="setting-label" for="voiceSelect">Pilih Suara</label>
          <select id="voiceSelect" class="voice-select">
            <option value="">Loading suara...</option>
          </select>
        </div>
        
        <div class="setting-item">
          <label class="setting-label">Kecepatan Bicara</label>
          <div class="slider-container">
            <span class="slider-value" id="rateValue">1.0</span>
            <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1">
          </div>
        </div>
        
        <div class="setting-item">
          <label class="setting-label">Tinggi Nada</label>
          <div class="slider-container">
            <span class="slider-value" id="pitchValue">1.0</span>
            <input type="range" id="pitchSlider" min="0.5" max="2" step="0.1" value="1">
          </div>
        </div>
        
        <div class="setting-item">
          <label class="setting-label">Volume</label>
          <div class="slider-container">
            <span class="slider-value" id="volumeValue">1.0</span>
            <input type="range" id="volumeSlider" min="0.1" max="1" step="0.1" value="1">
          </div>
        </div>
        
        <div class="setting-item">
          <label class="checkbox-label">
            <input type="checkbox" id="autoSpeakCheckbox">
            <span>Baca otomatis respons Nayra AI</span>
          </label>
        </div>
        
        <div class="setting-item">
          <label class="checkbox-label">
            <input type="checkbox" id="voiceInputCheckbox" checked>
            <span>Aktifkan input suara</span>
          </label>
        </div>
        
        <div class="settings-buttons">
          <button class="settings-button cancel" id="cancelSettings">Batal</button>
          <button class="settings-button save" id="saveSettings">Simpan</button>
        </div>
      </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
      <!-- Chat Messages -->
      <div id="chatMessages" class="chat-messages">
        <!-- Welcome message -->
        <div class="message received">
          <div class="message-bubble">
            <div class="message-text">
              Halo! Saya Nayra AI, asisten sains Anda. Saya siap membantu Anda dengan pertanyaan seputar sains, fisika, kimia, biologi, dan matematika. Apa yang ingin Anda ketahui hari ini?
            </div>
            <div class="message-time" id="welcomeTime"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Input -->
    <div id="messageInputContainer" class="message-input-container">
      <button id="voiceInputButton" class="voice-input-button" title="Input suara">
        <i class="fas fa-microphone"></i>
      </button>
      
      <input type="text" id="messageInput" class="message-input" placeholder="Tanyakan sesuatu tentang sains atau tekan tombol mikrofon...">
      
      <button id="settingsButton" class="settings-button-small" title="Pengaturan suara">
        <i class="fas fa-cog"></i>
      </button>
      
      <button id="sendButton" class="send-button" disabled>
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
      <a href="../dashboard siswa.html" class="nav-item">
        <i class="fas fa-home nav-icon"></i>
        <span>Beranda</span>
      </a>
      <a href="../soal harian/dashboard soal.html" class="nav-item">
        <i class="fas fa-flask nav-icon"></i>
        <span>Soal Harian</span>
      </a>
      <a href="../ai/nayra.html" class="nav-item">
        <i class="fas fa-robot nav-icon"></i>
        <span>Nayra AI</span>
      </a>
      <a href="../kategori/kategori materi.html" class="nav-item">
        <i class="fas fa-chalkboard-teacher nav-icon"></i>
        <span>Materi Harian</span>
      </a>
      <a href="../profil/profil.html" class="nav-item">
        <i class="fas fa-user nav-icon"></i>
        <span>Profil</span>
      </a>
    </nav>
  </div>

  <script>
    // DOM Elements
    const chatMessages = document.getElementById("chatMessages");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    const welcomeTime = document.getElementById("welcomeTime");
    
    // Sidebar elements
    const hamburgerButton = document.getElementById("hamburgerButton");
    const closeSidebar = document.getElementById("closeSidebar");
    const sidebar = document.getElementById("sidebar");
    const sidebarOverlay = document.getElementById("sidebarOverlay");
    
    // Voice input elements
    const voiceInputButton = document.getElementById("voiceInputButton");
    
    // Settings elements
    const settingsButton = document.getElementById("settingsButton");
    const closeSettings = document.getElementById("closeSettings");
    const cancelSettings = document.getElementById("cancelSettings");
    const saveSettings = document.getElementById("saveSettings");
    const settingsPanel = document.getElementById("settingsPanel");
    const settingsOverlay = document.getElementById("settingsOverlay");
    
    // TTS elements
    const voiceSelect = document.getElementById("voiceSelect");
    const rateSlider = document.getElementById("rateSlider");
    const pitchSlider = document.getElementById("pitchSlider");
    const volumeSlider = document.getElementById("volumeSlider");
    const rateValue = document.getElementById("rateValue");
    const pitchValue = document.getElementById("pitchValue");
    const volumeValue = document.getElementById("volumeValue");
    const autoSpeakCheckbox = document.getElementById("autoSpeakCheckbox");
    const voiceInputCheckbox = document.getElementById("voiceInputCheckbox");
    
    // TTS variables
    let speechSynthesis = window.speechSynthesis;
    let voices = [];
    let currentUtterance = null;
    let isSpeaking = false;
    let ttsSettings = {
      voice: null,
      rate: 1,
      pitch: 1,
      volume: 1,
      autoSpeak: false,
      voiceInputEnabled: true
    };
    
    // Speech recognition variables
    let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let isListening = false;

    // Set welcome message time
    welcomeTime.textContent = formatTime(new Date());

    // Initialize TTS
    function initializeTTS() {
      // Load saved settings
      const savedSettings = localStorage.getItem('nayraTtsSettings');
      if (savedSettings) {
        ttsSettings = JSON.parse(savedSettings);
      }
      
      // Apply settings to UI
      rateSlider.value = ttsSettings.rate;
      pitchSlider.value = ttsSettings.pitch;
      volumeSlider.value = ttsSettings.volume;
      autoSpeakCheckbox.checked = ttsSettings.autoSpeak;
      voiceInputCheckbox.checked = ttsSettings.voiceInputEnabled;
      
      updateSliderValues();
      
      // Load voices
      loadVoices();
      
      // If voices are already loaded
      if (speechSynthesis.getVoices().length > 0) {
        populateVoiceList();
      }
      
      // When voices are loaded
      speechSynthesis.onvoiceschanged = function() {
        populateVoiceList();
      };
    }
    
    // Load voices
    function loadVoices() {
      voices = speechSynthesis.getVoices();
    }
    
    // Populate voice list
    function populateVoiceList() {
      voiceSelect.innerHTML = '<option value="">Pilih suara...</option>';
      
      // Filter voices for Indonesian or English
      const filteredVoices = voices.filter(voice => 
        voice.lang.startsWith('id') || 
        voice.lang.startsWith('en') || 
        voice.name.includes('Indonesian') ||
        voice.name.includes('English')
      );
      
      // Sort voices by language and name
      filteredVoices.sort((a, b) => {
        if (a.lang.startsWith('id') && !b.lang.startsWith('id')) return -1;
        if (!a.lang.startsWith('id') && b.lang.startsWith('id')) return 1;
        return a.name.localeCompare(b.name);
      });
      
      filteredVoices.forEach(voice => {
        const option = document.createElement('option');
        option.value = voice.name;
        option.textContent = `${voice.name} (${voice.lang})`;
        
        // Select saved voice
        if (ttsSettings.voice && voice.name === ttsSettings.voice) {
          option.selected = true;
        }
        
        // Auto-select Indonesian voice if available and no saved preference
        if (!ttsSettings.voice && voice.lang.startsWith('id')) {
          option.selected = true;
          ttsSettings.voice = voice.name;
        }
        
        voiceSelect.appendChild(option);
      });
      
      // If no voices found
      if (filteredVoices.length === 0) {
        voiceSelect.innerHTML = '<option value="">Tidak ada suara yang tersedia</option>';
      }
    }
    
    // Update slider values display
    function updateSliderValues() {
      rateValue.textContent = rateSlider.value;
      pitchValue.textContent = pitchSlider.value;
      volumeValue.textContent = volumeSlider.value;
    }
    
    // Speak text using TTS
    function speakText(text, messageId = null) {
      if (!speechSynthesis || !ttsSettings.voiceInputEnabled) return;
      
      // Stop any current speech
      if (isSpeaking) {
        speechSynthesis.cancel();
      }
      
      const utterance = new SpeechSynthesisUtterance(text);
      
      // Find selected voice
      const selectedVoice = voices.find(voice => voice.name === ttsSettings.voice);
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      
      // Apply settings
      utterance.rate = ttsSettings.rate;
      utterance.pitch = ttsSettings.pitch;
      utterance.volume = ttsSettings.volume;
      utterance.lang = selectedVoice ? selectedVoice.lang : 'id-ID';
      
      // Highlight message if provided
      if (messageId) {
        const messageElement = document.getElementById(messageId);
        if (messageElement) {
          utterance.onstart = function() {
            messageElement.classList.add('playing');
            isSpeaking = true;
          };
          
          utterance.onend = function() {
            messageElement.classList.remove('playing');
            isSpeaking = false;
          };
          
          utterance.onerror = function() {
            messageElement.classList.remove('playing');
            isSpeaking = false;
          };
        }
      }
      
      currentUtterance = utterance;
      speechSynthesis.speak(utterance);
    }
    
    // Stop TTS
    function stopSpeaking() {
      if (isSpeaking) {
        speechSynthesis.cancel();
        isSpeaking = false;
        
        // Remove playing class from all messages
        document.querySelectorAll('.tts-button.playing').forEach(btn => {
          btn.classList.remove('playing');
        });
      }
    }
    
    // Initialize speech recognition
    function initializeSpeechRecognition() {
      if (!SpeechRecognition) {
        console.warn('Speech recognition not supported');
        voiceInputButton.disabled = true;
        voiceInputButton.title = 'Input suara tidak didukung';
        return;
      }
      
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = true;
      recognition.lang = 'id-ID';
      
      recognition.onstart = function() {
        isListening = true;
        voiceInputButton.classList.add('listening');
        voiceInputButton.innerHTML = '<i class="fas fa-stop"></i>';
      };
      
      recognition.onresult = function(event) {
        const transcript = Array.from(event.results)
          .map(result => result[0])
          .map(result => result.transcript)
          .join('');
        
        messageInput.value = transcript;
        sendButton.disabled = !transcript.trim();
      };
      
      recognition.onend = function() {
        isListening = false;
        voiceInputButton.classList.remove('listening');
        voiceInputButton.innerHTML = '<i class="fas fa-microphone"></i>';
      };
      
      recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        isListening = false;
        voiceInputButton.classList.remove('listening');
        voiceInputButton.innerHTML = '<i class="fas fa-microphone"></i>';
        
        if (event.error === 'not-allowed') {
          alert('Akses mikrofon ditolak. Silakan izinkan akses mikrofon di pengaturan browser Anda.');
        }
      };
    }
    
    // Toggle voice input
    function toggleVoiceInput() {
      if (!recognition || !ttsSettings.voiceInputEnabled) return;
      
      if (isListening) {
        recognition.stop();
      } else {
        // Request microphone permission
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(function(stream) {
            // Stop all tracks to release microphone
            stream.getTracks().forEach(track => track.stop());
            
            // Start recognition
            recognition.start();
          })
          .catch(function(err) {
            console.error('Microphone access denied:', err);
            alert('Tidak dapat mengakses mikrofon. Silakan izinkan akses mikrofon di pengaturan browser Anda.');
          });
      }
    }
    
    // Toggle sidebar
    function toggleSidebar() {
      sidebar.classList.toggle("active");
      sidebarOverlay.classList.toggle("active");
    }

    // Close sidebar
    function closeSidebarFunc() {
      sidebar.classList.remove("active");
      sidebarOverlay.classList.remove("active");
    }
    
    // Toggle settings panel
    function toggleSettingsPanel() {
      settingsPanel.classList.toggle("active");
      settingsOverlay.classList.toggle("active");
    }

    // Close settings panel
    function closeSettingsPanel() {
      settingsPanel.classList.remove("active");
      settingsOverlay.classList.remove("active");
    }
    
    // Save TTS settings
    function saveTtsSettings() {
      ttsSettings.voice = voiceSelect.value;
      ttsSettings.rate = parseFloat(rateSlider.value);
      ttsSettings.pitch = parseFloat(pitchSlider.value);
      ttsSettings.volume = parseFloat(volumeSlider.value);
      ttsSettings.autoSpeak = autoSpeakCheckbox.checked;
      ttsSettings.voiceInputEnabled = voiceInputCheckbox.checked;
      
      // Save to localStorage
      localStorage.setItem('nayraTtsSettings', JSON.stringify(ttsSettings));
      
      // Enable/disable voice input button
      voiceInputButton.disabled = !ttsSettings.voiceInputEnabled;
      
      closeSettingsPanel();
      showNotification('Pengaturan suara disimpan');
    }
    
    // Show notification
    function showNotification(message) {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Event listeners for sidebar
    hamburgerButton.addEventListener("click", toggleSidebar);
    closeSidebar.addEventListener("click", closeSidebarFunc);
    sidebarOverlay.addEventListener("click", closeSidebarFunc);
    
    // Event listeners for settings
    settingsButton.addEventListener("click", toggleSettingsPanel);
    closeSettings.addEventListener("click", closeSettingsPanel);
    cancelSettings.addEventListener("click", closeSettingsPanel);
    settingsOverlay.addEventListener("click", closeSettingsPanel);
    saveSettings.addEventListener("click", saveTtsSettings);
    
    // Slider event listeners
    rateSlider.addEventListener('input', function() {
      rateValue.textContent = this.value;
    });
    
    pitchSlider.addEventListener('input', function() {
      pitchValue.textContent = this.value;
    });
    
    volumeSlider.addEventListener('input', function() {
      volumeValue.textContent = this.value;
    });

    // Enable/disable send button based on input
    messageInput.addEventListener("input", () => {
      sendButton.disabled = !messageInput.value.trim();
    });

    // Send message
    sendButton.addEventListener("click", sendMessage);
    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && messageInput.value.trim()) {
        sendMessage();
      }
    });
    
    // Voice input button
    voiceInputButton.addEventListener("click", toggleVoiceInput);

    // Send message function
    async function sendMessage() {
      if (!messageInput.value.trim()) return;
      
      const messageText = messageInput.value.trim();
      
      // Add user message to chat
      addMessageToChat(messageText, 'sent');
      
      // Clear input
      messageInput.value = "";
      sendButton.disabled = true;
      
      // Show thinking indicator
      showThinkingIndicator();
      
      try {
        // Send message to Groq API (menggunakan API key dari Temanguru)
        const response = await fetchGroqResponse(messageText);
        
        // Remove thinking indicator
        removeThinkingIndicator();
        
        // Add AI response to chat
        const messageId = addMessageToChat(response, 'received', true);
        
        // Auto-speak response if enabled
        if (ttsSettings.autoSpeak && ttsSettings.voiceInputEnabled) {
          setTimeout(() => {
            speakText(response, messageId);
          }, 500);
        }
      } catch (error) {
        // Remove thinking indicator
        removeThinkingIndicator();
        
        // Show error message
        addMessageToChat(
          "Maaf, saya mengalami masalah teknis saat memproses pertanyaan Anda. Silakan coba lagi nanti.", 
          'received'
        );
        console.error("Error:", error);
      }
    }

    // Add message to chat
    function addMessageToChat(text, type, addTtsButton = false) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${type}`;
      
      const timeString = formatTime(new Date());
      const messageId = `message-${Date.now()}`;
      
      let messageContent = `
        <div class="message-bubble">
          <div class="message-text">${escapeHtml(text)}</div>
          <div class="message-time">${timeString}</div>
        </div>
      `;
      
      // Add TTS button for received messages
      if (type === 'received' && addTtsButton && ttsSettings.voiceInputEnabled) {
        messageContent += `
          <div class="message-actions">
            <button class="tts-button" data-message-id="${messageId}" title="Dengarkan jawaban">
              <i class="fas fa-volume-up"></i>
            </button>
          </div>
        `;
      }
      
      messageDiv.innerHTML = messageContent;
      messageDiv.id = messageId;
      
      chatMessages.appendChild(messageDiv);
      
      // Add event listener to TTS button if present
      if (type === 'received' && addTtsButton && ttsSettings.voiceInputEnabled) {
        const ttsButton = messageDiv.querySelector('.tts-button');
        ttsButton.addEventListener('click', function() {
          const msgId = this.getAttribute('data-message-id');
          const messageText = this.closest('.message').querySelector('.message-text').textContent;
          
          // Stop any current speech
          stopSpeaking();
          
          // Speak the message
          speakText(messageText, msgId);
        });
      }
      
      // Scroll to bottom
      setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 100);
      
      return messageId;
    }

    // Show thinking indicator
    function showThinkingIndicator() {
      const thinkingDiv = document.createElement("div");
      thinkingDiv.className = "message received";
      thinkingDiv.id = "thinkingIndicator";
      
      thinkingDiv.innerHTML = `
        <div class="message-bubble">
          <div class="message-text">
            <div class="thinking-indicator">
              Nayra sedang berpikir
              <div class="thinking-dots">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>
          </div>
        </div>
      `;
      
      chatMessages.appendChild(thinkingDiv);
      
      // Scroll to bottom
      setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 100);
    }

    // Remove thinking indicator
    function removeThinkingIndicator() {
      const thinkingIndicator = document.getElementById("thinkingIndicator");
      if (thinkingIndicator) {
        thinkingIndicator.remove();
      }
    }

    // Fetch response from Groq API menggunakan API key dari Temanguru
    async function fetchGroqResponse(message) {
      // Menggunakan API key dari Temanguru
      const apiKey = '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';
      const apiUrl = 'https://api.groq.com/openai/v1/chat/completions';
      
      // Konteks untuk AI - fokus pada sains untuk Nayra AI
      const systemPrompt = `Anda adalah Nayra AI, asisten sains yang ramah dan membantu dalam aplikasi TETA SAINS. 
      Fokuslah pada topik sains seperti fisika, kimia, biologi, matematika, dan ilmu pengetahuan lainnya. 
      
      Tugas Anda:
      1. Berikan penjelasan yang jelas, mudah dipahami, dan relevan dengan pertanyaan sains
      2. Bantu dengan pemecahan masalah dan konsep sains
      3. Berikan contoh yang relevan dan aplikatif
      4. Jika pertanyaan di luar topik sains, dengan sopan arahkan kembali ke topik sains
      5. Gunakan bahasa Indonesia yang baik dan sederhana
      6. Sesuaikan penjelasan dengan tingkat pengetahuan siswa
      
      Anda adalah asisten khusus untuk aplikasi pembelajaran sains TETA SAINS.`;
      
      const requestBody = {
        model: 'llama-3.1-8b-instant', // Model Groq yang cepat dan efisien
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: message }
        ],
        temperature: 0.7,
        max_tokens: 1024,
        top_p: 1,
        stream: false
      };
      
      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        return data.choices[0].message.content;
      } catch (error) {
        // Fallback response jika API tidak tersedia
        console.error("Error calling Groq API:", error);
        return getFallbackResponse(message);
      }
    }

    // Fallback response jika API tidak tersedia
    function getFallbackResponse(message) {
      const lowerMessage = message.toLowerCase();
      
      // Respons sederhana berdasarkan kata kunci
      if (lowerMessage.includes('fisika') || lowerMessage.includes('fisik')) {
        return "Fisika adalah ilmu yang mempelajari tentang materi, energi, dan interaksi antara keduanya. Topik fisika mencakup mekanika, termodinamika, elektromagnetisme, dan banyak lagi. Apakah ada topik fisika khusus yang ingin Anda pelajari?";
      } else if (lowerMessage.includes('kimia')) {
        return "Kimia adalah ilmu yang mempelajari tentang komposisi, struktur, sifat, dan perubahan materi. Topik kimia meliputi atom, molekul, reaksi kimia, dan tabel periodik. Ada yang spesifik tentang kimia yang ingin Anda tanyakan?";
      } else if (lowerMessage.includes('biologi') || lowerMessage.includes('biolog')) {
        return "Biologi adalah ilmu yang mempelajari tentang kehidupan dan organisme hidup. Topik biologi mencakup sel, genetika, evolusi, ekosistem, dan anatomi. Apakah ada aspek biologi tertentu yang ingin Anda ketahui?";
      } else if (lowerMessage.includes('matematika') || lowerMessage.includes('matematik')) {
        return "Matematika adalah ilmu tentang angka, struktur, ruang, dan perubahan. Topik matematika meliputi aljabar, geometri, kalkulus, dan statistik. Ada pertanyaan matematika khusus yang bisa saya bantu?";
      } else if (lowerMessage.includes('halo') || lowerMessage.includes('hai') || lowerMessage.includes('hi')) {
        return "Halo! Saya Nayra AI, asisten sains Anda di TETA SAINS. Saya siap membantu dengan pertanyaan seputar sains. Apa yang ingin Anda pelajari hari ini?";
      } else {
        return "Terima kasih atas pertanyaannya! Sebagai asisten sains Nayra AI di TETA SAINS, saya khusus membantu dengan topik fisika, kimia, biologi, matematika, dan ilmu pengetahuan lainnya. Bisakah Anda memberikan lebih detail tentang apa yang ingin Anda ketahui?";
      }
    }

    // Helper functions
    function formatTime(date) {
      return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
    }

    function escapeHtml(s) {
      if (!s && s !== 0) return "";
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
    
    // Initialize everything when page loads
    document.addEventListener('DOMContentLoaded', function() {
      initializeTTS();
      initializeSpeechRecognition();
      
      // Speak welcome message if auto-speak is enabled
      if (ttsSettings.autoSpeak && ttsSettings.voiceInputEnabled) {
        setTimeout(() => {
          const welcomeText = "Halo! Saya Nayra AI, asisten sains Anda. Saya siap membantu Anda dengan pertanyaan seputar sains, fisika, kimia, biologi, dan matematika. Apa yang ingin Anda ketahui hari ini?";
          speakText(welcomeText);
        }, 1000);
      }
    });
  </script>
</body>
  </html>
