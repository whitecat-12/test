<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Nayra - AI Pintar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #9999ff;
      --secondary: #7a7ae6;
    }
    
    * {
      box-sizing: border-box;
    }
    
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Baloo 2', cursive;
      height: 100%;
      background: black;
      overflow: hidden;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    .app-container {
      max-width: 414px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      position: relative;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    
    /* Video Styles */
    video {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      min-width: 100%;
      min-height: 100%;
      width: auto;
      height: auto;
      background: black;
      opacity: 0;
      transition: opacity 0.5s ease;
      z-index: 0;
      pointer-events: none;
    }
    
    video.show {
      opacity: 1;
      z-index: 1;
    }
    
    /* Overlay Controls */
    .overlay {
      position: fixed;
      bottom: 20px;
      left: 0;
      right: 0;
      z-index: 2;
      display: flex;
      justify-content: center;
      gap: 15px;
      padding: 0 20px;
    }
    
    .mic-button {
      background: linear-gradient(to bottom right, var(--primary), var(--secondary));
      color: white;
      border: none;
      width: 70px;
      height: 70px;
      font-size: 12px;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(153, 153, 255, 0.6);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      text-align: center;
      touch-action: manipulation;
    }
    
    .mic-button i {
      font-size: 20px;
      margin-bottom: 2px;
    }
    
    .mic-button:active {
      transform: scale(0.95);
      box-shadow: 0 2px 10px rgba(153, 153, 255, 0.8);
    }
    
    .cancel-button {
      background: linear-gradient(to bottom right, #ff4d4d, #a00000);
      box-shadow: 0 4px 15px rgba(255, 0, 0, 0.5);
    }
    
    .cancel-button:active {
      transform: scale(0.95);
      box-shadow: 0 2px 10px rgba(255, 0, 0, 0.7);
    }
    
    /* Loading state */
    .loading {
      background: linear-gradient(to bottom right, #ffa500, #ff8c00) !important;
      box-shadow: 0 4px 15px rgba(255, 165, 0, 0.6) !important;
    }
    
    /* Status message */
    .status {
      position: fixed;
      top: 20px;
      left: 0;
      right: 0;
      text-align: center;
      color: white;
      font-size: 14px;
      z-index: 3;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      margin: 0 20px;
      border-radius: 10px;
      display: none;
    }
    
    .status.show {
      display: block;
    }
    
    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      max-width: 414px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
      background: white;
      z-index: 10;
      height: 70px;
      display: flex;
      align-items: center;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      text-decoration: none;
      flex: 1;
      height: 100%;
      padding: 0.5rem 0;
    }
    
    .nav-icon {
      transition: all 0.3s ease;
      font-size: 1.25rem;
    }
    
    .nav-icon.active {
      transform: translateY(-5px);
      color: var(--primary);
    }
    
    .nav-item span {
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }
    
    /* Untuk tablet */
    @media (min-width: 768px) {
      .mic-button {
        width: 90px;
        height: 90px;
        font-size: 14px;
      }
      
      .mic-button i {
        font-size: 24px;
      }
      
      .overlay {
        gap: 20px;
        bottom: 30px;
      }
    }
    
    /* Mobile responsive */
    @media (max-width: 414px) {
      .mic-button {
        width: 65px;
        height: 65px;
      }
      
      .bottom-nav {
        height: 65px;
      }
      
      .nav-icon {
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>

  <!-- App Container -->
  <div class="app-container">
    <!-- Video Background -->
    <video id="idle" class="show" autoplay muted loop playsinline webkit-playsinline>
      <source src="media/idle.mp4" type="video/mp4" />
    </video>
    
    <video id="avatar" muted loop playsinline webkit-playsinline>
      <source src="media/avatar.mp4" type="video/mp4" />
    </video>
    
    <video id="dance" muted playsinline webkit-playsinline>
      <source src="media/dance.mp4" type="video/mp4" />
    </video>
    
    <!-- Status Message -->
    <div id="status" class="status"></div>
    
    <!-- Voice Control Buttons -->
    <div class="overlay">
      <button id="micButton" class="mic-button">
        <i class="fas fa-microphone"></i> Bicara
      </button>
      <button id="cancelButton" class="mic-button cancel-button">
        <i class="fas fa-times"></i> Batal
      </button>
      <button id="resetButton" class="mic-button cancel-button">
        <i class="fas fa-rotate-left"></i> Reset
      </button>
    </div>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
      <a href="../dashboard siswa.html" class="nav-item">
        <i class="fas fa-home nav-icon"></i>
        <span>Beranda</span>
      </a>
      <a href="../soal harian/dashboard soal.html" class="nav-item">
        <i class="fas fa-flask nav-icon"></i>
        <span>Soal Harian</span>
      </a>
      <a href="../ai/nayra.html" class="nav-item">
        <i class="fas fa-robot nav-icon"></i>
        <span>Nayra AI</span>
      </a>
      <a href="../kategori/kategori materi.html" class="nav-item">
        <i class="fas fa-chalkboard-teacher nav-icon"></i>
        <span>Materi Harian</span>
      </a>
      <a href="../profil/profil.html" class="nav-item">
        <i class="fas fa-user nav-icon"></i>
        <span>Profil</span>
      </a>
    </nav>
  </div>

  <script>
    // ====== DOM Elements ======
    const idle = document.getElementById("idle");
    const avatar = document.getElementById("avatar");
    const dance = document.getElementById("dance");
    const statusEl = document.getElementById("status");
    const micButton = document.getElementById("micButton");
    const cancelButton = document.getElementById("cancelButton");
    const resetButton = document.getElementById("resetButton");

    // ====== API Configuration ======
    const GROQ_KEYS = [
      "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",
      "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"
    ];
    
    // ====== State Variables ======
    let recognition = null;
    let speechSynthesis = window.speechSynthesis;
    let history = [];1
    let currentApiKeyIndex = 0;

    // ====== Utility Functions ======
    function showStatus(message, duration = 3000) {
      statusEl.textContent = message;
      statusEl.classList.add('show');
      setTimeout(() => {
        statusEl.classList.remove('show');
      }, duration);
    }

    function switchVideo(toShow, toHide1, toHide2) {
      toHide1.classList.remove('show');
      toHide2.classList.remove('show');
      toShow.classList.add('show');
    }

    // ====== LocalStorage Functions ======
    function getNamaPengguna() {
      return localStorage.getItem("namaPengguna") || null;
    }

    function setNamaPengguna(nama) {
      localStorage.setItem("namaPengguna", nama);
    }

    function ambilRiwayat() {
      try {
        const saved = localStorage.getItem("riwayatChat");
        return saved ? JSON.parse(saved) : [];
      } catch (e) {
        console.error("Gagal mengambil riwayat:", e);
        return [];
      }
    }

    function simpanRiwayat() {
      try {
        localStorage.setItem("riwayatChat", JSON.stringify(history));
      } catch (e) {
        console.error("Gagal menyimpan riwayat:", e);
      }
    }

    // ====== Speech Recognition ======
    function startRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showStatus("Browser tidak mendukung speech recognition");
        return;
      }

      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'id-ID';
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = function() {
        showStatus("Mendengarkan...", 5000);
        micButton.classList.add('loading');
        switchVideo(avatar, idle, dance);
      };

      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        showStatus(`Anda: ${transcript}`, 3000);
        micButton.classList.remove('loading');
        
        // Kirim ke AI
        processUserInput(transcript);
      };

      recognition.onerror = function(event) {
        console.error("Speech recognition error:", event.error);
        showStatus("Error: " + event.error, 3000);
        micButton.classList.remove('loading');
        switchVideo(idle, avatar, dance);
      };

      recognition.onend = function() {
        micButton.classList.remove('loading');
        switchVideo(idle, avatar, dance);
      };

      recognition.start();
    }

    function stopRecognition() {
      if (recognition) {
        recognition.stop();
        recognition = null;
      }
      micButton.classList.remove('loading');
      switchVideo(idle, avatar, dance);
      showStatus("Dibatalkan", 2000);
    }

    // ====== AI Processing ======
    async function processUserInput(input) {
      showStatus("Memproses...", 3000);
      switchVideo(avatar, idle, dance);
      
      try {
        const response = await fetchGroqResponse(input);
        speakResponse(response);
        
        // Simpan ke riwayat
        history.push({
          user: input,
          ai: response,
          timestamp: new Date().toISOString()
        });
        
        // Simpan ke localStorage
        simpanRiwayat();
        
      } catch (error) {
        console.error("Error processing input:", error);
        showStatus("Error: " + error.message, 3000);
        switchVideo(idle, avatar, dance);
      }
    }

    async function fetchGroqResponse(message) {
      const apiKey = GROQ_KEYS[currentApiKeyIndex];
      const apiUrl = 'https://api.groq.com/openai/v1/chat/completions';
      
      // Konteks untuk AI - mirip dengan versi sebelumnya
      const systemPrompt = `Anda adalah Nayra AI, asisten sains yang ramah dan membantu dalam aplikasi TETA SAINS. 
      Fokuslah pada topik sains seperti fisika, kimia, biologi, matematika, dan ilmu pengetahuan lainnya. 
      
      Tugas Anda:
      1. Berikan penjelasan yang jelas, mudah dipahami, dan relevan dengan pertanyaan sains
      2. Bantu dengan pemecahan masalah dan konsep sains
      3. Berikan contoh yang relevan dan aplikatif
      4. Jika pertanyaan di luar topik sains, dengan sopan arahkan kembali ke topik sains
      5. Gunakan bahasa Indonesia yang baik dan sederhana
      6. Sesuaikan penjelasan dengan tingkat pengetahuan siswa
      
      Anda adalah asisten khusus untuk aplikasi pembelajaran sains TETA SAINS.`;
      
      const requestBody = {
        model: 'llama-3.1-8b-instant',
        messages: [
          { role: 'system', content: systemPrompt },
          ...history.slice(-5).map(h => [
            { role: 'user', content: h.user },
            { role: 'assistant', content: h.ai }
          ]).flat(),
          { role: 'user', content: message }
        ],
        temperature: 0.7,
        max_tokens: 1024,
        top_p: 1,
        stream: false
      };
      
      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
          if (response.status === 429 || response.status === 401) {
            // Switch API key jika ada masalah
            currentApiKeyIndex = (currentApiKeyIndex + 1) % GROQ_KEYS.length;
            throw new Error(`API key ${currentApiKeyIndex + 1} bermasalah, mencoba yang lain...`);
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        return data.choices[0].message.content;
      } catch (error) {
        console.error("Error calling Groq API:", error);
        return getFallbackResponse(message);
      }
    }

    function getFallbackResponse(message) {
      const lowerMessage = message.toLowerCase();
      
      if (lowerMessage.includes('fisika') || lowerMessage.includes('fisik')) {
        return "Fisika adalah ilmu yang mempelajari tentang materi, energi, dan interaksi antara keduanya. Topik fisika mencakup mekanika, termodinamika, elektromagnetisme, dan banyak lagi.";
      } else if (lowerMessage.includes('kimia')) {
        return "Kimia adalah ilmu yang mempelajari tentang komposisi, struktur, sifat, dan perubahan materi. Topik kimia meliputi atom, molekul, reaksi kimia, dan tabel periodik.";
      } else if (lowerMessage.includes('biologi') || lowerMessage.includes('biolog')) {
        return "Biologi adalah ilmu yang mempelajari tentang kehidupan dan organisme hidup. Topik biologi mencakup sel, genetika, evolusi, ekosistem, dan anatomi.";
      } else if (lowerMessage.includes('matematika') || lowerMessage.includes('matematik')) {
        return "Matematika adalah ilmu tentang angka, struktur, ruang, dan perubahan. Topik matematika meliputi aljabar, geometri, kalkulus, dan statistik.";
      } else if (lowerMessage.includes('halo') || lowerMessage.includes('hai') || lowerMessage.includes('hi')) {
        return "Halo! Saya Nayra AI, asisten sains Anda di TETA SAINS. Saya siap membantu dengan pertanyaan seputar sains. Apa yang ingin Anda pelajari hari ini?";
      } else if (lowerMessage.includes('tari') || lowerMessage.includes('dance')) {
        return "Saya akan menari untuk Anda! Lihat ini!";
      } else {
        return "Terima kasih atas pertanyaannya! Sebagai asisten sains Nayra AI di TETA SAINS, saya khusus membantu dengan topik fisika, kimia, biologi, matematika, dan ilmu pengetahuan lainnya.";
      }
    }

    // ====== Text-to-Speech ======
    function speakResponse(text) {
      // Hentikan speech yang sedang berjalan
      speechSynthesis.cancel();
      
      // Cek apakah ada perintah khusus untuk tari
      if (text.toLowerCase().includes('tari') || text.toLowerCase().includes('dance')) {
        switchVideo(dance, idle, avatar);
        showStatus("Nayra sedang menari!", 5000);
        setTimeout(() => {
          switchVideo(idle, avatar, dance);
        }, 5000);
      } else {
        switchVideo(avatar, idle, dance);
      }
      
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'id-ID';
      utterance.rate = 1.0;
      utterance.pitch = 1.0;
      utterance.volume = 1.0;
      
      utterance.onstart = function() {
        showStatus("Nayra: " + text.substring(0, 50) + "...", 3000);
      };
      
      utterance.onend = function() {
        switchVideo(idle, avatar, dance);
      };
      
      utterance.onerror = function(event) {
        console.error("Speech synthesis error:", event);
        switchVideo(idle, avatar, dance);
      };
      
      speechSynthesis.speak(utterance);
    }

    // ====== Event Listeners ======
    micButton.addEventListener('click', startRecognition);
    cancelButton.addEventListener('click', stopRecognition);
    
    resetButton.addEventListener('click', function() {
      if (confirm("Apakah Anda yakin ingin mereset percakapan?")) {
        history = [];
        localStorage.removeItem("riwayatChat");
        showStatus("Percakapan telah direset", 2000);
        switchVideo(idle, avatar, dance);
        speechSynthesis.cancel();
      }
    });

    // ====== Initialize ======
    window.addEventListener('load', function() {
      history = ambilRiwayat();
      showStatus("Nayra AI siap membantu!", 2000);
      
      // Preload videos
      avatar.load();
      dance.load();
    });

    // Handle visibility change
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        speechSynthesis.cancel();
        if (recognition) {
          recognition.stop();
        }
      }
    });

  </script>
</body>
  </html>
