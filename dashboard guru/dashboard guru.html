<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Guru - Firebase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" 
    onload="renderMathInElement(document.body);"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold text-center mb-8 text-teal-700">Dashboard Guru - QUANTARA</h1>

    <!-- Loading Indicator -->
    <div id="loading" class="text-center py-8">
      <div class="inline-flex items-center">
        <i class="fas fa-spinner fa-spin text-teal-600 text-2xl mr-3"></i>
        <span class="text-gray-600">Memuat dashboard...</span>
      </div>
    </div>

    <!-- Content Area (initially hidden) -->
    <div id="content" class="hidden">
      <!-- Statistik Dashboard -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white p-4 rounded-xl shadow">
          <div class="flex items-center">
            <div class="bg-teal-100 p-3 rounded-lg mr-3">
              <i class="fas fa-question-circle text-teal-600 text-xl"></i>
            </div>
            <div>
              <p class="text-sm text-gray-500">Total Soal</p>
              <h3 class="text-xl font-bold" id="totalSoal">0</h3>
            </div>
          </div>
        </div>
        
        <div class="bg-white p-4 rounded-xl shadow">
          <div class="flex items-center">
            <div class="bg-blue-100 p-3 rounded-lg mr-3">
              <i class="fas fa-book text-blue-600 text-xl"></i>
            </div>
            <div>
              <p class="text-sm text-gray-500">Total Materi</p>
              <h3 class="text-xl font-bold" id="totalMateri">0</h3>
            </div>
          </div>
        </div>
        
        <div class="bg-white p-4 rounded-xl shadow">
          <div class="flex items-center">
            <div class="bg-purple-100 p-3 rounded-lg mr-3">
              <i class="fas fa-layer-group text-purple-600 text-xl"></i>
            </div>
            <div>
              <p class="text-sm text-gray-500">Mapel Aktif</p>
              <h3 class="text-xl font-bold" id="totalMapel">0</h3>
            </div>
          </div>
        </div>
        
        <div class="bg-white p-4 rounded-xl shadow">
          <div class="flex items-center">
            <div class="bg-green-100 p-3 rounded-lg mr-3">
              <i class="fas fa-user-graduate text-green-600 text-xl"></i>
            </div>
            <div>
              <p class="text-sm text-gray-500">Nilai Siswa</p>
              <h3 class="text-xl font-bold" id="totalNilai">0</h3>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Kolom Kiri: Form Input -->
        <div>
          <!-- Form input soal -->
          <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
            <h2 class="text-xl font-bold text-teal-700 mb-4">
              <i class="fas fa-plus-circle mr-2"></i>Tambah Soal Baru
            </h2>
            <form id="soalForm" class="space-y-4">
              <input type="hidden" id="soalId">

              <div>
                <label class="block font-semibold mb-1">Mata Pelajaran:</label>
                <div class="relative">
                  <input type="text" id="mapelInput" list="mapelList" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-teal-400 focus:outline-none" placeholder="Ketik atau pilih mata pelajaran" required>
                  <datalist id="mapelList"></datalist>
                </div>
                <div class="flex flex-wrap gap-2 mt-2">
                  <span class="bg-teal-100 text-teal-700 px-3 py-1 rounded-full text-sm">Fisika</span>
                  <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">Kimia</span>
                  <span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm">Biologi</span>
                  <span class="bg-pink-100 text-pink-700 px-3 py-1 rounded-full text-sm">Astronomi</span>
                  <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-sm">Matematika</span>
                  <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-sm">Lainnya</span>
                </div>
              </div>

              <div>
                <label class="block font-semibold mb-1">Pertanyaan:</label>
                <textarea id="pertanyaan" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" rows="3" placeholder="Gunakan $...$ untuk inline atau $$...$$ untuk display math" required></textarea>
              </div>

              <div>
                <label class="block font-semibold mb-1">Opsi Jawaban:</label>
                <div class="grid grid-cols-1 gap-3">
                  <div class="flex items-center gap-2">
                    <span class="bg-gray-200 w-8 h-8 rounded-full flex items-center justify-center font-bold">A</span>
                    <input type="text" id="opsiA" placeholder="Opsi A" class="flex-1 border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" required>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="bg-gray-200 w-8 h-8 rounded-full flex items-center justify-center font-bold">B</span>
                    <input type="text" id="opsiB" placeholder="Opsi B" class="flex-1 border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" required>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="bg-gray-200 w-8 h-8 rounded-full flex items-center justify-center font-bold">C</span>
                    <input type="text" id="opsiC" placeholder="Opsi C" class="flex-1 border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" required>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="bg-gray-200 w-8 h-8 rounded-full flex items-center justify-center font-bold">D</span>
                    <input type="text" id="opsiD" placeholder="Opsi D" class="flex-1 border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" required>
                  </div>
                </div>
              </div>

              <div>
                <label class="block font-semibold mb-1">Jawaban Benar:</label>
                <div class="grid grid-cols-4 gap-2">
                  <button type="button" data-jawaban="A" class="jawaban-btn bg-gray-200 text-gray-700 p-3 rounded-lg hover:bg-gray-300 font-bold">A</button>
                  <button type="button" data-jawaban="B" class="jawaban-btn bg-gray-200 text-gray-700 p-3 rounded-lg hover:bg-gray-300 font-bold">B</button>
                  <button type="button" data-jawaban="C" class="jawaban-btn bg-gray-200 text-gray-700 p-3 rounded-lg hover:bg-gray-300 font-bold">C</button>
                  <button type="button" data-jawaban="D" class="jawaban-btn bg-gray-200 text-gray-700 p-3 rounded-lg hover:bg-gray-300 font-bold">D</button>
                </div>
                <input type="hidden" id="jawaban" value="A">
              </div>

              <div>
                <label class="block font-semibold mb-1">Penjelasan (Opsional):</label>
                <textarea id="penjelasan" class="w-full border p-3 rounded-lg focus:ring-1 focus:ring-teal-400" rows="2" placeholder="Penjelasan untuk jawaban yang benar"></textarea>
              </div>

              <div class="flex gap-2">
                <button type="submit" class="flex-1 bg-teal-600 text-white p-3 rounded-lg hover:bg-teal-700 transition font-semibold flex justify-center items-center gap-2">
                  <i class="fa-solid fa-floppy-disk"></i> Simpan Soal
                </button>
                <button type="button" id="resetSoal" class="bg-gray-200 text-gray-700 p-3 rounded-lg hover:bg-gray-300 transition font-semibold">
                  Reset
                </button>
              </div>
            </form>
          </div>

          <!-- ðŸ”¹ Form Tambah Materi -->
          <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
            <h2 class="text-xl font-bold text-indigo-700 mb-4">
              <i class="fas fa-book-medical mr-2"></i>Tambah Materi Baru
            </h2>
            <form id="materiForm" class="space-y-4">
              <input type="hidden" id="materiId">

              <div>
                <label class="block font-semibold mb-1">Mata Pelajaran:</label>
                <input type="text" id="materiMapel" list="mapelList2" class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-indigo-400" placeholder="Ketik atau pilih mata pelajaran" required>
                <datalist id="mapelList2"></datalist>
              </div>

              <div>
                <label class="block font-semibold mb-1">Judul Materi:</label>
                <input type="text" id="judulMateri" class="w-full border p-3 rounded-lg focus:ring-1 focus:ring-indigo-400" placeholder="Contoh: Hukum Newton" required>
              </div>

              <div>
                <label class="block font-semibold mb-1">Deskripsi Singkat:</label>
                <textarea id="deskripsiMateri" class="w-full border p-3 rounded-lg focus:ring-1 focus:ring-indigo-400" rows="2" placeholder="Deskripsi singkat tentang materi ini" required></textarea>
              </div>

              <div>
                <label class="block font-semibold mb-1">Konten Materi:</label>
                <textarea id="kontenMateri" class="w-full border p-3 rounded-lg focus:ring-1 focus:ring-indigo-400" rows="4" placeholder="Tulis konten materi lengkap di sini. Gunakan $...$ untuk inline atau $$...$$ untuk display math" required></textarea>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block font-semibold mb-1">Tingkat Kesulitan:</label>
                  <select id="tingkatMateri" class="w-full border p-2 rounded-lg focus:ring-1 focus:ring-indigo-400">
                    <option value="mudah">Mudah</option>
                    <option value="menengah">Menengah</option>
                    <option value="sulit">Sulit</option>
                  </select>
                </div>

                <div>
                  <label class="block font-semibold mb-1">Durasi (menit):</label>
                  <input type="number" id="durasiMateri" class="w-full border p-2 rounded-lg focus:ring-1 focus:ring-indigo-400" value="15" min="5" max="120">
                </div>

                <div>
                  <label class="block font-semibold mb-1">Jenis Materi:</label>
                  <select id="jenisMateri" class="w-full border p-2 rounded-lg focus:ring-1 focus:ring-indigo-400">
                    <option value="teori">Teori</option>
                    <option value="contoh">Contoh Soal</option>
                    <option value="video">Video</option>
                    <option value="latihan">Latihan</option>
                  </select>
                </div>
              </div>

              <div class="flex gap-2">
                <button type="submit" class="flex-1 bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition font-semibold flex justify-center items-center gap-2">
                  <i class="fa-solid fa-book"></i> Simpan Materi
                </button>
                <button type="button" id="resetMateri" class="bg-gray-200 text-gray-700 p-3 rounded-lg hover:bg-gray-300 transition font-semibold">
                  Reset
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Kolom Kanan: Data dan Fakta -->
        <div>
          <!-- ðŸ”¹ Form Fakta Harian -->
          <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
            <h2 class="text-xl font-bold text-purple-700 mb-4">
              <i class="fas fa-lightbulb mr-2"></i>Fakta Sains Harian
            </h2>
            <form id="faktaForm" class="space-y-4">
              <textarea id="faktaInput" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-400" rows="3"
                placeholder="Masukkan fakta sains harian di sini..." required></textarea>
              <input type="text" id="sumberInput" class="w-full border p-3 rounded-lg focus:ring-1 focus:ring-purple-400" placeholder="Sumber fakta (contoh: Sains Daily)">
              <button type="submit" class="w-full bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-700 transition font-semibold flex justify-center items-center gap-2">
                <i class="fa-solid fa-floppy-disk"></i> Simpan Fakta Harian
              </button>
            </form>
          </div>

          <!-- Daftar soal -->
          <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-bold text-teal-700">
                <i class="fas fa-list-check mr-2"></i>Daftar Soal
              </h2>
              <button id="refreshSoal" class="bg-gray-100 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-200">
                <i class="fas fa-redo"></i>
              </button>
            </div>
            <div class="mb-4">
              <input type="text" id="searchSoal" class="w-full border p-2 rounded-lg" placeholder="Cari soal atau mata pelajaran...">
            </div>
            <div id="daftarSoal" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
          </div>

          <!-- Daftar materi -->
          <div class="bg-white p-6 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
              <h2 class="text-xl font-bold text-indigo-700">
                <i class="fas fa-book-open mr-2"></i>Daftar Materi
              </h2>
              <button id="refreshMateri" class="bg-gray-100 text-gray-700 px-3 py-1 rounded-lg hover:bg-gray-200">
                <i class="fas fa-redo"></i>
              </button>
            </div>
            <div class="mb-4">
              <input type="text" id="searchMateri" class="w-full border p-2 rounded-lg" placeholder="Cari materi atau mata pelajaran...">
            </div>
            <div id="daftarMateri" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
          </div>
        </div>
      </div>

      <div class="mt-8">
        <button id="logoutBtn" class="w-full bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 transition font-semibold flex justify-center items-center gap-2">
          <i class="fa-solid fa-right-from-bracket"></i> Logout
        </button>
      </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      <p id="errorText"></p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      getDocs, 
      doc, 
      updateDoc, 
      deleteDoc, 
      getDoc, 
      setDoc,
      query,
      orderBy,
      where 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJ5I8k2MzAyDLt9fUcXHRNtRVjKB_ETLY",
      authDomain: "projectid-81104.firebaseapp.com",
      projectId: "projectid-81104",
      storageBucket: "projectid-81104.firebasestorage.app",
      messagingSenderId: "554913260457",
      appId: "1:554913260457:web:bf988867ebfd902c651ab8",
      measurementId: "G-8WFHQW5WGN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM Elements
    const loading = document.getElementById('loading');
    const content = document.getElementById('content');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    
    const soalForm = document.getElementById('soalForm');
    const materiForm = document.getElementById('materiForm');
    const daftarSoal = document.getElementById('daftarSoal');
    const daftarMateri = document.getElementById('daftarMateri');
    const logoutBtn = document.getElementById('logoutBtn');
    const refreshSoal = document.getElementById('refreshSoal');
    const refreshMateri = document.getElementById('refreshMateri');
    const searchSoal = document.getElementById('searchSoal');
    const searchMateri = document.getElementById('searchMateri');
    const resetSoal = document.getElementById('resetSoal');
    const resetMateri = document.getElementById('resetMateri');

    const mapelInput = document.getElementById("mapelInput");
    const mapelList = document.getElementById("mapelList");
    const mapelList2 = document.getElementById("mapelList2");
    const materiMapelInput = document.getElementById("materiMapel");

    const faktaForm = document.getElementById("faktaForm");
    const faktaInput = document.getElementById("faktaInput");
    const sumberInput = document.getElementById("sumberInput");

    // Statistik
    const totalSoalEl = document.getElementById("totalSoal");
    const totalMateriEl = document.getElementById("totalMateri");
    const totalMapelEl = document.getElementById("totalMapel");
    const totalNilaiEl = document.getElementById("totalNilai");

    let currentUser = null;
    let userRole = null;
    let soalData = [];
    let materiData = [];

    // Show error message
    function showError(message) {
      errorText.textContent = message;
      errorMessage.classList.remove('hidden');
      loading.classList.add('hidden');
    }

    // Hide error message
    function hideError() {
      errorMessage.classList.add('hidden');
    }

    // Check if user is teacher
    async function checkUserRole(user) {
      try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (userDoc.exists()) {
          return userDoc.data().role;
        }
        return null;
      } catch (error) {
        console.error("Error checking user role:", error);
        return null;
      }
    }

    // Initialize dashboard
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      currentUser = user;
      
      // Check user role
      userRole = await checkUserRole(user);
      
      if (userRole !== "guru") {
        showError("Akses ditolak. Hanya guru yang dapat mengakses dashboard ini.");
        return;
      }

      // User is teacher, show content
      hideError();
      loading.classList.add('hidden');
      content.classList.remove('hidden');
      
      // Load initial data
      loadFakta();
      loadSoal();
      loadMateri();
      loadStatistik();
      loadMapelOptions();
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    // Refresh buttons
    refreshSoal.addEventListener("click", () => {
      loadSoal();
      loadStatistik();
    });

    refreshMateri.addEventListener("click", () => {
      loadMateri();
      loadStatistik();
    });

    // Search functionality
    searchSoal.addEventListener("input", (e) => {
      filterSoal(e.target.value);
    });

    searchMateri.addEventListener("input", (e) => {
      filterMateri(e.target.value);
    });

    // Reset buttons
    resetSoal.addEventListener("click", () => {
      soalForm.reset();
      document.getElementById("soalId").value = "";
      document.getElementById("jawaban").value = "A";
      resetJawabanButtons();
    });

    resetMateri.addEventListener("click", () => {
      materiForm.reset();
      document.getElementById("materiId").value = "";
      document.getElementById("durasiMateri").value = "15";
    });

    // Jawaban button selection
    document.querySelectorAll('.jawaban-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const jawaban = btn.dataset.jawaban;
        document.getElementById('jawaban').value = jawaban;
        
        // Reset all buttons
        document.querySelectorAll('.jawaban-btn').forEach(b => {
          b.classList.remove('bg-teal-600', 'text-white');
          b.classList.add('bg-gray-200', 'text-gray-700');
        });
        
        // Highlight selected button
        btn.classList.remove('bg-gray-200', 'text-gray-700');
        btn.classList.add('bg-teal-600', 'text-white');
      });
    });

    function resetJawabanButtons() {
      document.querySelectorAll('.jawaban-btn').forEach(b => {
        b.classList.remove('bg-teal-600', 'text-white');
        b.classList.add('bg-gray-200', 'text-gray-700');
      });
      document.querySelector('.jawaban-btn[data-jawaban="A"]').classList.add('bg-teal-600', 'text-white');
    }

    // ðŸ”¹ Load statistik
    async function loadStatistik() {
      try {
        // Total soal
        const soalSnapshot = await getDocs(collection(db, "soal"));
        totalSoalEl.textContent = soalSnapshot.size;
        
        // Total materi
        const materiSnapshot = await getDocs(collection(db, "materi"));
        totalMateriEl.textContent = materiSnapshot.size;
        
        // Total mapel unik
        const mapelSet = new Set();
        soalSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.mapel) mapelSet.add(data.mapel);
        });
        totalMapelEl.textContent = mapelSet.size;
        
        // Total nilai (try-catch karena collection mungkin belum ada)
        try {
          const nilaiSnapshot = await getDocs(collection(db, "nilai"));
          totalNilaiEl.textContent = nilaiSnapshot.size;
        } catch (error) {
          totalNilaiEl.textContent = "0";
        }
        
      } catch (error) {
        console.error("Error loading statistics:", error);
      }
    }

    // ðŸ”¹ Load mata pelajaran options
    async function loadMapelOptions() {
      try {
        const snapshot = await getDocs(collection(db, "soal"));
        const mapels = new Set();
        
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.mapel) mapels.add(data.mapel);
        });
        
        // Add default mapels
        const defaultMapels = ["Fisika", "Kimia", "Biologi", "Astronomi", "Matematika", "Lainnya"];
        defaultMapels.forEach(mapel => mapels.add(mapel));
        
        // Clear and populate datalist
        mapelList.innerHTML = '';
        mapelList2.innerHTML = '';
        
        Array.from(mapels).forEach(mapel => {
          const option1 = document.createElement('option');
          option1.value = mapel;
          mapelList.appendChild(option1);
          
          const option2 = document.createElement('option');
          option2.value = mapel;
          mapelList2.appendChild(option2);
        });
        
      } catch (error) {
        console.error("Error loading mapel options:", error);
      }
    }

    // ðŸ”¹ Load fakta harian
    async function loadFakta() {
      try {
        const snap = await getDoc(doc(db, "beranda", "faktaHarian"));
        if (snap.exists()) {
          faktaInput.value = snap.data().teks || "";
          sumberInput.value = snap.data().sumber || "";
        }
      } catch (error) {
        console.error("Error loading fakta:", error);
      }
    }

    // ðŸ”¹ Simpan fakta harian
    faktaForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      try {
        await setDoc(doc(db, "beranda", "faktaHarian"), {
          teks: faktaInput.value,
          sumber: sumberInput.value || "Sumber tidak diketahui",
          updatedAt: new Date(),
          updatedBy: currentUser.uid
        });
        showNotification("Fakta sains harian berhasil disimpan âœ…", "success");
      } catch (error) {
        console.error("Error saving fakta:", error);
        showNotification("Gagal menyimpan fakta sains harian", "error");
      }
    });

    // ðŸ”¹ Form soal
    soalForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      if (userRole !== "guru") {
        showNotification("Anda tidak memiliki izin untuk menambah soal", "error");
        return;
      }

      const soalId = document.getElementById("soalId").value;
      const mapel = mapelInput.value.trim();

      if (!mapel) {
        showNotification("Silakan isi mata pelajaran!", "error");
        return;
      }

      const soalData = {
        mapel: mapel,
        pertanyaan: document.getElementById("pertanyaan").value,
        opsi: {
          A: document.getElementById("opsiA").value,
          B: document.getElementById("opsiB").value,
          C: document.getElementById("opsiC").value,
          D: document.getElementById("opsiD").value
        },
        jawaban: document.getElementById("jawaban").value,
        penjelasan: document.getElementById("penjelasan").value,
        createdAt: new Date(),
        updatedAt: new Date(),
        createdBy: currentUser.uid,
        createdByName: currentUser.displayName || currentUser.email
      };

      try {
        if (soalId) {
          // Update existing soal
          await updateDoc(doc(db, "soal", soalId), soalData);
          showNotification("Soal berhasil diperbarui âœ…", "success");
        } else {
          // Generate unique ID
          const timestamp = Date.now();
          const randomId = Math.random().toString(36).substring(2, 9);
          const soalDocId = `${mapel.toLowerCase().replace(/\s+/g, '_')}_${timestamp}_${randomId}`;
          
          // Add new soal
          await setDoc(doc(db, "soal", soalDocId), soalData);
          showNotification("Soal berhasil ditambahkan âœ…", "success");
        }

        // Reset form
        soalForm.reset();
        document.getElementById("soalId").value = "";
        document.getElementById("jawaban").value = "A";
        resetJawabanButtons();
        
        // Reload data
        loadSoal();
        loadStatistik();
        loadMapelOptions();
        
      } catch (error) {
        console.error("Error menyimpan soal:", error);
        showNotification("Terjadi kesalahan saat menyimpan soal: " + error.message, "error");
      }
    });

    // ðŸ”¹ Form materi
    materiForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      if (userRole !== "guru") {
        showNotification("Anda tidak memiliki izin untuk menambah materi", "error");
        return;
      }

      const materiId = document.getElementById("materiId").value;
      const mapelMateri = materiMapelInput.value.trim();

      if (!mapelMateri) {
        showNotification("Silakan isi nama mata pelajaran!", "error");
        return;
      }

      const materiData = {
        mapel: mapelMateri,
        judul: document.getElementById("judulMateri").value,
        deskripsi: document.getElementById("deskripsiMateri").value,
        konten: document.getElementById("kontenMateri").value,
        tingkat: document.getElementById("tingkatMateri").value,
        durasi: parseInt(document.getElementById("durasiMateri").value),
        jenis: document.getElementById("jenisMateri").value,
        createdAt: new Date(),
        updatedAt: new Date(),
        createdBy: currentUser.uid,
        createdByName: currentUser.displayName || currentUser.email
      };

      try {
        if (materiId) {
          await updateDoc(doc(db, "materi", materiId), materiData);
          showNotification("Materi berhasil diperbarui âœ…", "success");
        } else {
          // Generate unique ID
          const timestamp = Date.now();
          const randomId = Math.random().toString(36).substring(2, 9);
          const materiDocId = `${mapelMateri.toLowerCase().replace(/\s+/g, '_')}_materi_${timestamp}_${randomId}`;
          
          await setDoc(doc(db, "materi", materiDocId), materiData);
          showNotification("Materi berhasil ditambahkan âœ…", "success");
        }

        materiForm.reset();
        document.getElementById("materiId").value = "";
        document.getElementById("durasiMateri").value = "15";
        
        loadMateri();
        loadStatistik();
        loadMapelOptions();
        
      } catch (error) {
        console.error("Error menyimpan materi:", error);
        showNotification("Terjadi kesalahan saat menyimpan materi: " + error.message, "error");
      }
    });

    // ðŸ”¹ Load soal
    async function loadSoal() {
      try {
        daftarSoal.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-teal-600"></i> Memuat soal...</div>';
        
        const q = query(collection(db, "soal"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        
        soalData = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        if (soalData.length === 0) {
          daftarSoal.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="fas fa-clipboard-question text-4xl mb-3"></i>
              <p>Belum ada soal. Tambahkan soal pertama Anda!</p>
            </div>`;
          return;
        }
        
        renderSoalList(soalData);
        
      } catch (error) {
        console.error("Error loading soal:", error);
        daftarSoal.innerHTML = `
          <div class="text-center py-8 text-red-500">
            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
            <p>Gagal memuat soal</p>
          </div>`;
      }
    }

    function renderSoalList(soalArray) {
      daftarSoal.innerHTML = '';
      
      soalArray.forEach((item, index) => {
        const soalCard = document.createElement("div");
        soalCard.className = "bg-gray-50 p-4 rounded-xl border border-gray-200 hover:border-teal-300 transition-colors";
        
        const mapelColor = getMapelColor(item.mapel);
        
        soalCard.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div class="flex items-center gap-2">
              <span class="${mapelColor.bg} ${mapelColor.text} text-xs font-medium px-2 py-1 rounded-full">${item.mapel || 'Umum'}</span>
              <span class="text-xs text-gray-500">#${index + 1}</span>
            </div>
            <div class="flex gap-1">
              <button data-id="${item.id}" class="editSoalBtn bg-blue-100 text-blue-700 hover:bg-blue-200 w-8 h-8 rounded-full flex items-center justify-center">
                <i class="fas fa-pen text-xs"></i>
              </button>
              <button data-id="${item.id}" class="deleteSoalBtn bg-red-100 text-red-700 hover:bg-red-200 w-8 h-8 rounded-full flex items-center justify-center">
                <i class="fas fa-trash text-xs"></i>
              </button>
            </div>
          </div>
          
          <div class="mb-3">
            <p class="text-sm font-medium text-gray-700 line-clamp-2">${item.pertanyaan.substring(0, 100)}${item.pertanyaan.length > 100 ? '...' : ''}</p>
          </div>
          
          <div class="flex justify-between items-center text-xs text-gray-500">
            <div class="flex items-center gap-2">
              <span class="bg-gray-200 px-2 py-1 rounded">Jawaban: ${item.jawaban}</span>
              ${item.penjelasan ? '<i class="fas fa-comment text-teal-500" title="Ada penjelasan"></i>' : ''}
            </div>
            <span>${new Date(item.createdAt?.toDate() || item.createdAt).toLocaleDateString('id-ID')}</span>
          </div>
        `;
        
        daftarSoal.appendChild(soalCard);
        
        // Render MathJax
        renderMathInElement(soalCard, {
          delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false}
          ],
          throwOnError: false
        });
      });
      
      setupSoalEventListeners();
    }

    function filterSoal(keyword) {
      if (!keyword.trim()) {
        renderSoalList(soalData);
        return;
      }
      
      const filtered = soalData.filter(item => 
        item.pertanyaan.toLowerCase().includes(keyword.toLowerCase()) ||
        item.mapel.toLowerCase().includes(keyword.toLowerCase()) ||
        item.penjelasan?.toLowerCase().includes(keyword.toLowerCase())
      );
      
      renderSoalList(filtered);
    }

    // ðŸ”¹ Load materi
    async function loadMateri() {
      try {
        daftarMateri.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-indigo-600"></i> Memuat materi...</div>';
        
        const q = query(collection(db, "materi"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        
        materiData = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        if (materiData.length === 0) {
          daftarMateri.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="fas fa-book text-4xl mb-3"></i>
              <p>Belum ada materi. Tambahkan materi pertama Anda!</p>
            </div>`;
          return;
        }
        
        renderMateriList(materiData);
        
      } catch (error) {
        console.error("Error loading materi:", error);
        daftarMateri.innerHTML = `
          <div class="text-center py-8 text-red-500">
            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
            <p>Gagal memuat materi</p>
          </div>`;
      }
    }

    function renderMateriList(materiArray) {
      daftarMateri.innerHTML = '';
      
      materiArray.forEach((item, index) => {
        const materiCard = document.createElement("div");
        materiCard.className = "bg-gray-50 p-4 rounded-xl border border-gray-200 hover:border-indigo-300 transition-colors";
        
        const mapelColor = getMapelColor(item.mapel);
        const difficultyColor = getDifficultyColor(item.tingkat);
        
        materiCard.innerHTML = `
          <div class="flex justify-between items-start mb-2">
            <div class="flex items-center gap-2">
              <span class="${mapelColor.bg} ${mapelColor.text} text-xs font-medium px-2 py-1 rounded-full">${item.mapel || 'Umum'}</span>
              <span class="${difficultyColor.bg} ${difficultyColor.text} text-xs font-medium px-2 py-1 rounded-full">${item.tingkat}</span>
            </div>
            <div class="flex gap-1">
              <button data-id="${item.id}" class="editMateriBtn bg-blue-100 text-blue-700 hover:bg-blue-200 w-8 h-8 rounded-full flex items-center justify-center">
                <i class="fas fa-pen text-xs"></i>
              </button>
              <button data-id="${item.id}" class="deleteMateriBtn bg-red-100 text-red-700 hover:bg-red-200 w-8 h-8 rounded-full flex items-center justify-center">
                <i class="fas fa-trash text-xs"></i>
              </button>
            </div>
          </div>
          
          <h3 class="font-medium text-gray-800 mb-1">${item.judul}</h3>
          <p class="text-sm text-gray-600 mb-3 line-clamp-2">${item.deskripsi}</p>
          
          <div class="flex justify-between items-center text-xs text-gray-500">
            <div class="flex items-center gap-2">
              <span class="bg-gray-200 px-2 py-1 rounded">${item.durasi} menit</span>
              <span class="bg-gray-200 px-2 py-1 rounded">${item.jenis}</span>
            </div>
            <span>${new Date(item.createdAt?.toDate() || item.createdAt).toLocaleDateString('id-ID')}</span>
          </div>
        `;
        
        daftarMateri.appendChild(materiCard);
      });
      
      setupMateriEventListeners();
    }

    function filterMateri(keyword) {
      if (!keyword.trim()) {
        renderMateriList(materiData);
        return;
      }
      
      const filtered = materiData.filter(item => 
        item.judul.toLowerCase().includes(keyword.toLowerCase()) ||
        item.mapel.toLowerCase().includes(keyword.toLowerCase()) ||
        item.deskripsi.toLowerCase().includes(keyword.toLowerCase())
      );
      
      renderMateriList(filtered);
    }

    // ðŸ”¹ Setup event listeners untuk soal
    function setupSoalEventListeners() {
      document.querySelectorAll(".editSoalBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const docId = btn.dataset.id;
          const docSnap = await getDoc(doc(db, "soal", docId));
          
          if (docSnap.exists()) {
            const data = docSnap.data();
            
            // Isi form edit
            document.getElementById("soalId").value = docId;
            mapelInput.value = data.mapel;
            document.getElementById("pertanyaan").value = data.pertanyaan;
            document.getElementById("opsiA").value = data.opsi.A;
            document.getElementById("opsiB").value = data.opsi.B;
            document.getElementById("opsiC").value = data.opsi.C;
            document.getElementById("opsiD").value = data.opsi.D;
            document.getElementById("jawaban").value = data.jawaban;
            document.getElementById("penjelasan").value = data.penjelasan || "";
            
            // Update jawaban button
            resetJawabanButtons();
            const selectedBtn = document.querySelector(`.jawaban-btn[data-jawaban="${data.jawaban}"]`);
            selectedBtn.classList.remove('bg-gray-200', 'text-gray-700');
            selectedBtn.classList.add('bg-teal-600', 'text-white');
            
            // Update submit button
            const submitBtn = soalForm.querySelector("button[type='submit']");
            submitBtn.innerHTML = '<i class="fa-solid fa-pen"></i> Update Soal';
            submitBtn.className = "flex-1 bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition font-semibold flex justify-center items-center gap-2";
            
            // Scroll to form
            soalForm.scrollIntoView({ behavior: 'smooth' });
          }
        });
      });

      document.querySelectorAll(".deleteSoalBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const docId = btn.dataset.id;
          
          if (confirm("Yakin ingin menghapus soal ini?")) {
            try {
              await deleteDoc(doc(db, "soal", docId));
              showNotification("Soal berhasil dihapus âœ…", "success");
              loadSoal();
              loadStatistik();
            } catch (error) {
              console.error("Error deleting soal:", error);
              showNotification("Gagal menghapus soal", "error");
            }
          }
        });
      });
    }

    // ðŸ”¹ Setup event listeners untuk materi
    function setupMateriEventListeners() {
      document.querySelectorAll(".editMateriBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const docId = btn.dataset.id;
          const docSnap = await getDoc(doc(db, "materi", docId));
          
          if (docSnap.exists()) {
            const data = docSnap.data();
            
            document.getElementById("materiId").value = docId;
            document.getElementById("materiMapel").value = data.mapel;
            document.getElementById("judulMateri").value = data.judul;
            document.getElementById("deskripsiMateri").value = data.deskripsi;
            document.getElementById("kontenMateri").value = data.konten;
            document.getElementById("tingkatMateri").value = data.tingkat;
            document.getElementById("durasiMateri").value = data.durasi;
            document.getElementById("jenisMateri").value = data.jenis;
            
            // Update submit button
            const submitBtn = materiForm.querySelector("button[type='submit']");
            submitBtn.innerHTML = '<i class="fa-solid fa-pen"></i> Update Materi';
            submitBtn.className = "flex-1 bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition font-semibold flex justify-center items-center gap-2";
            
            // Scroll to form
            materiForm.scrollIntoView({ behavior: 'smooth' });
          }
        });
      });

      document.querySelectorAll(".deleteMateriBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          if (confirm("Yakin ingin menghapus materi ini?")) {
            try {
              await deleteDoc(doc(db, "materi", btn.dataset.id));
              showNotification("Materi berhasil dihapus âœ…", "success");
              loadMateri();
              loadStatistik();
            } catch (error) {
              console.error("Error deleting materi:", error);
              showNotification("Gagal menghapus materi", "error");
            }
          }
        });
      });
    }

    // Helper functions
    function getMapelColor(mapel) {
      const mapelLower = mapel?.toLowerCase() || '';
      
      if (mapelLower.includes('fisik')) return { bg: 'bg-blue-100', text: 'text-blue-800' };
      if (mapelLower.includes('kimia')) return { bg: 'bg-green-100', text: 'text-green-800' };
      if (mapelLower.includes('biolog')) return { bg: 'bg-purple-100', text: 'text-purple-800' };
      if (mapelLower.includes('astronom')) return { bg: 'bg-pink-100', text: 'text-pink-800' };
      if (mapelLower.includes('matematik')) return { bg: 'bg-yellow-100', text: 'text-yellow-800' };
      return { bg: 'bg-gray-100', text: 'text-gray-800' };
    }

    function getDifficultyColor(tingkat) {
      switch(tingkat) {
        case 'mudah': return { bg: 'bg-green-100', text: 'text-green-800' };
        case 'menengah': return { bg: 'bg-yellow-100', text: 'text-yellow-800' };
        case 'sulit': return { bg: 'bg-red-100', text: 'text-red-800' };
        default: return { bg: 'bg-gray-100', text: 'text-gray-800' };
      }
    }

    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium transform transition-all duration-300 ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' :
        'bg-blue-500'
      }`;
      notification.innerHTML = `
        <div class="flex items-center gap-3">
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(-20px)';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }
  </script>
  
  <style>
    .rotate-180 {
      transform: rotate(180deg);
      transition: transform 0.3s ease;
    }
    
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    /* Scrollbar styling */
    .overflow-y-auto::-webkit-scrollbar {
      width: 6px;
    }
    
    .overflow-y-auto::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    .overflow-y-auto::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }
    
    .overflow-y-auto::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }
  </style>
</body>
</html>
