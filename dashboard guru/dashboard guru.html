<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Guru - Teta Sains</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-teal-700 mb-2">Dashboard Guru - Teta Sains</h1>
      <p class="text-gray-600" id="userInfo">Memuat informasi pengguna...</p>
    </div>

    <!-- Alert untuk error/success -->
    <div id="alertMessage" class="hidden fixed top-4 right-4 z-50 max-w-sm"></div>

    <!-- Container utama -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      
      <!-- Kolom Kiri: Form Input -->
      <div class="space-y-6">
        
        <!-- Form Input Soal -->
        <div class="bg-white p-6 rounded-2xl shadow-lg">
          <h2 class="text-xl font-bold text-teal-700 mb-4 flex items-center gap-2">
            <i class="fas fa-plus-circle"></i> Tambah Soal Baru
          </h2>
          <form id="soalForm" class="space-y-4">
            <input type="hidden" id="soalId">

            <div>
              <label class="block font-semibold mb-2 text-gray-700">Mata Pelajaran:</label>
              <div class="flex gap-2 mb-2">
                <input type="text" id="mapelInput" class="flex-1 border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" 
                  placeholder="Ketik nama mata pelajaran">
                <button type="button" id="tambahMapel" class="bg-teal-500 text-white px-4 py-3 rounded-lg hover:bg-teal-600 transition font-semibold">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <div id="daftarMapel" class="flex flex-wrap gap-2 mt-2"></div>
            </div>

            <div>
              <label class="block font-semibold mb-2 text-gray-700">Pertanyaan:</label>
              <textarea id="pertanyaan" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" 
                rows="3" placeholder="Tulis pertanyaan di sini... Gunakan $...$ untuk matematika" required></textarea>
            </div>

            <div>
              <label class="block font-semibold mb-2 text-gray-700">Opsi Jawaban:</label>
              <div class="grid grid-cols-1 gap-3">
                <div class="flex items-center gap-3">
                  <span class="font-bold text-teal-600 w-6">A.</span>
                  <input type="text" id="opsiA" class="flex-1 border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" 
                    placeholder="Opsi A" required>
                </div>
                <div class="flex items-center gap-3">
                  <span class="font-bold text-teal-600 w-6">B.</span>
                  <input type="text" id="opsiB" class="flex-1 border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" 
                    placeholder="Opsi B" required>
                </div>
                <div class="flex items-center gap-3">
                  <span class="font-bold text-teal-600 w-6">C.</span>
                  <input type="text" id="opsiC" class="flex-1 border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" 
                    placeholder="Opsi C" required>
                </div>
                <div class="flex items-center gap-3">
                  <span class="font-bold text-teal-600 w-6">D.</span>
                  <input type="text" id="opsiD" class="flex-1 border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" 
                    placeholder="Opsi D" required>
                </div>
              </div>
            </div>

            <div>
              <label class="block font-semibold mb-2 text-gray-700">Jawaban Benar:</label>
              <select id="jawaban" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400">
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
              </select>
            </div>

            <div>
              <label class="block font-semibold mb-2 text-gray-700">Penjelasan:</label>
              <textarea id="penjelasan" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" 
                rows="2" placeholder="Penjelasan jawaban (opsional)"></textarea>
            </div>

            <button type="submit" class="w-full bg-teal-600 text-white p-4 rounded-lg hover:bg-teal-700 transition font-semibold flex justify-center items-center gap-3">
              <i class="fa-solid fa-floppy-disk"></i> Simpan Soal
            </button>
          </form>
        </div>

        <!-- Form Input Materi -->
        <div class="bg-white p-6 rounded-2xl shadow-lg">
          <h2 class="text-xl font-bold text-indigo-700 mb-4 flex items-center gap-2">
            <i class="fas fa-book"></i> Tambah Materi Baru
          </h2>
          <form id="materiForm" class="space-y-4">
            <input type="hidden" id="materiId">

            <div>
              <label class="block font-semibold mb-2 text-gray-700">Mata Pelajaran:</label>
              <select id="materiMapel" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" required>
                <option value="">Pilih Mata Pelajaran</option>
              </select>
            </div>

            <div>
              <label class="block font-semibold mb-2 text-gray-700">Judul Materi:</label>
              <input type="text" id="judulMateri" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" 
                placeholder="Contoh: Hukum Newton tentang Gerak" required>
            </div>

            <div>
              <label class="block font-semibold mb-2 text-gray-700">Deskripsi Singkat:</label>
              <textarea id="deskripsiMateri" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" 
                rows="2" placeholder="Deskripsi singkat tentang materi ini" required></textarea>
            </div>

            <div>
              <label class="block font-semibold mb-2 text-gray-700">Konten Materi:</label>
              <textarea id="kontenMateri" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" 
                rows="5" placeholder="Tulis konten materi lengkap di sini..." required></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block font-semibold mb-2 text-gray-700">Tingkat Kesulitan:</label>
                <select id="tingkatMateri" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">
                  <option value="mudah">Mudah</option>
                  <option value="menengah">Menengah</option>
                  <option value="sulit">Sulit</option>
                </select>
              </div>

              <div>
                <label class="block font-semibold mb-2 text-gray-700">Durasi (menit):</label>
                <input type="number" id="durasiMateri" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" 
                  value="15" min="5" max="120">
              </div>

              <div>
                <label class="block font-semibold mb-2 text-gray-700">Jenis Materi:</label>
                <select id="jenisMateri" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">
                  <option value="teori">Teori</option>
                  <option value="contoh">Contoh Soal</option>
                  <option value="video">Video</option>
                  <option value="latihan">Latihan</option>
                </select>
              </div>
            </div>

            <button type="submit" class="w-full bg-indigo-600 text-white p-4 rounded-lg hover:bg-indigo-700 transition font-semibold flex justify-center items-center gap-3">
              <i class="fa-solid fa-book"></i> Simpan Materi
            </button>
          </form>
        </div>

        <!-- Form Fakta Harian -->
        <div class="bg-white p-6 rounded-2xl shadow-lg">
          <h2 class="text-xl font-bold text-amber-700 mb-4 flex items-center gap-2">
            <i class="fas fa-lightbulb"></i> Fakta Sains Harian
          </h2>
          <form id="faktaForm" class="space-y-4">
            <textarea id="faktaInput" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400"
              rows="3" placeholder="Masukkan fakta sains harian yang menarik..." required></textarea>
            <input type="text" id="sumberInput" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-400" 
              placeholder="Sumber fakta (contoh: Sains Daily, National Geographic)">
            <button type="submit" class="w-full bg-amber-600 text-white p-4 rounded-lg hover:bg-amber-700 transition font-semibold flex justify-center items-center gap-3">
              <i class="fa-solid fa-floppy-disk"></i> Simpan Fakta
            </button>
          </form>
        </div>
      </div>

      <!-- Kolom Kanan: Daftar Konten -->
      <div class="space-y-6">
        
        <!-- Daftar Soal -->
        <div class="bg-white p-6 rounded-2xl shadow-lg">
          <h2 class="text-xl font-bold text-teal-700 mb-4 flex items-center gap-2">
            <i class="fas fa-list"></i> Daftar Soal
            <span id="soalCount" class="bg-teal-100 text-teal-800 px-2 py-1 rounded-full text-sm">0</span>
          </h2>
          <div id="daftarSoal" class="space-y-4 max-h-96 overflow-y-auto"></div>
        </div>

        <!-- Daftar Materi -->
        <div class="bg-white p-6 rounded-2xl shadow-lg">
          <h2 class="text-xl font-bold text-indigo-700 mb-4 flex items-center gap-2">
            <i class="fas fa-book-open"></i> Daftar Materi
            <span id="materiCount" class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full text-sm">0</span>
          </h2>
          <div id="daftarMateri" class="space-y-4 max-h-96 overflow-y-auto"></div>
        </div>
      </div>
    </div>

    <!-- Logout Button -->
    <div class="text-center mt-8">
      <button id="logoutBtn" class="bg-red-500 text-white px-8 py-3 rounded-lg hover:bg-red-600 transition font-semibold flex items-center gap-2 mx-auto">
        <i class="fa-solid fa-right-from-bracket"></i> Logout
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJ5I8k2MzAyDLt9fUcXHRNtRVjKB_ETLY",
      authDomain: "projectid-81104.firebaseapp.com",
      projectId: "projectid-81104",
      storageBucket: "projectid-81104.firebasestorage.app",
      messagingSenderId: "554913260457",
      appId: "1:554913260457:web:bf988867ebfd902c651ab8",
      measurementId: "G-8WFHQW5WGN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Elements
    const userInfo = document.getElementById('userInfo');
    const alertMessage = document.getElementById('alertMessage');
    const soalCount = document.getElementById('soalCount');
    const materiCount = document.getElementById('materiCount');

    // Forms
    const soalForm = document.getElementById('soalForm');
    const materiForm = document.getElementById('materiForm');
    const faktaForm = document.getElementById('faktaForm');
    
    // Display areas
    const daftarSoal = document.getElementById('daftarSoal');
    const daftarMateri = document.getElementById('daftarMateri');

    // Mapel management
    const mapelInput = document.getElementById("mapelInput");
    const tambahMapelBtn = document.getElementById("tambahMapel");
    const daftarMapelDiv = document.getElementById("daftarMapel");
    const materiMapelSelect = document.getElementById("materiMapel");

    // Fakta elements
    const faktaInput = document.getElementById("faktaInput");
    const sumberInput = document.getElementById("sumberInput");

    let daftarMapel = [];

    // Utility functions
    function showAlert(message, type = 'error') {
      alertMessage.className = `fixed top-4 right-4 z-50 max-w-sm p-4 rounded-lg shadow-lg ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
      }`;
      alertMessage.textContent = message;
      alertMessage.classList.remove('hidden');
      
      setTimeout(() => {
        alertMessage.classList.add('hidden');
      }, 5000);
    }

    function renderMath(element) {
      if (typeof renderMathInElement !== 'undefined') {
        renderMathInElement(element, {
          delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false}
          ],
          throwOnError: false
        });
      }
    }

    // Authentication
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      try {
        // Cek role user
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          userInfo.textContent = `Halo, ${userData.name || user.email} (${userData.role || 'guru'})`;
          
          if (userData.role !== 'guru') {
            showAlert('Hanya guru yang dapat mengakses dashboard ini');
            setTimeout(() => window.location.href = "dashboard-siswa.html", 3000);
            return;
          }
        } else {
          // Jika belum ada di users collection, buat dokumen baru
          await setDoc(doc(db, "users", user.uid), {
            email: user.email,
            role: 'guru',
            createdAt: new Date()
          });
          userInfo.textContent = `Halo, ${user.email} (guru)`;
        }

        // Load data
        await loadFakta();
        await loadSoal();
        await loadMateri();
        
      } catch (error) {
        console.error('Error checking user role:', error);
        showAlert('Error memeriksa hak akses: ' + error.message);
      }
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        await signOut(auth);
        window.location.href = "login.html";
      } catch (error) {
        showAlert('Error saat logout: ' + error.message);
      }
    });

    // Load fakta
    async function loadFakta() {
      try {
        const snap = await getDoc(doc(db, "beranda", "faktaHarian"));
        if (snap.exists()) {
          faktaInput.value = snap.data().teks || "";
          sumberInput.value = snap.data().sumber || "";
        }
      } catch (error) {
        console.error('Error loading fakta:', error);
      }
    }

    // Simpan fakta
    faktaForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      try {
        await setDoc(doc(db, "beranda", "faktaHarian"), {
          teks: faktaInput.value,
          sumber: sumberInput.value || "Sumber tidak diketahui",
          updatedAt: new Date()
        });
        showAlert("Fakta sains harian berhasil disimpan ✅", 'success');
      } catch (error) {
        console.error('Error saving fakta:', error);
        showAlert('Error menyimpan fakta: ' + error.message);
      }
    });

    // Mapel management
    tambahMapelBtn.addEventListener("click", () => {
      const namaMapel = mapelInput.value.trim();
      if (!namaMapel) {
        showAlert('Nama mata pelajaran tidak boleh kosong');
        return;
      }
      if (daftarMapel.includes(namaMapel)) {
        showAlert('Mata pelajaran sudah ada!');
        return;
      }
      
      daftarMapel.push(namaMapel);
      updateMapelDisplay();
      mapelInput.value = "";
    });

    function updateMapelDisplay() {
      daftarMapelDiv.innerHTML = "";
      daftarMapel.forEach(mapel => {
        const span = document.createElement("span");
        span.className = "bg-teal-100 text-teal-700 px-3 py-1 rounded-full flex items-center gap-2 text-sm";
        span.innerHTML = `${mapel} <i class="fa-solid fa-xmark cursor-pointer hover:text-red-500"></i>`;
        span.querySelector("i").addEventListener("click", () => {
          daftarMapel = daftarMapel.filter(m => m !== mapel);
          updateMapelDisplay();
        });
        daftarMapelDiv.appendChild(span);
      });
      updateMateriMapelSelect();
    }

    function updateMateriMapelSelect() {
      materiMapelSelect.innerHTML = '<option value="">Pilih Mata Pelajaran</option>';
      daftarMapel.forEach(mapel => {
        const option = document.createElement("option");
        option.value = mapel;
        option.textContent = mapel;
        materiMapelSelect.appendChild(option);
      });
    }

    // Form soal
    soalForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      if (daftarMapel.length === 0) {
        showAlert("Silakan tambahkan minimal satu mata pelajaran!");
        return;
      }

      const mapel = daftarMapel[daftarMapel.length - 1];
      const soalData = {
        mapel: mapel,
        pertanyaan: document.getElementById("pertanyaan").value,
        opsi: {
          A: document.getElementById("opsiA").value,
          B: document.getElementById("opsiB").value,
          C: document.getElementById("opsiC").value,
          D: document.getElementById("opsiD").value
        },
        jawaban: document.getElementById("jawaban").value,
        penjelasan: document.getElementById("penjelasan").value,
        createdAt: new Date()
      };

      try {
        const soalId = document.getElementById("soalId").value;
        if (soalId) {
          await updateDoc(doc(db, "soal", soalId), soalData);
          showAlert("Soal berhasil diperbarui ✅", 'success');
        } else {
          await addDoc(collection(db, "soal"), soalData);
          showAlert("Soal berhasil ditambahkan ✅", 'success');
        }

        soalForm.reset();
        document.getElementById("soalId").value = "";
        loadSoal();
      } catch (error) {
        console.error("Error menyimpan soal:", error);
        showAlert('Error menyimpan soal: ' + error.message);
      }
    });

    // Form materi
    materiForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const materiData = {
        mapel: document.getElementById("materiMapel").value,
        judul: document.getElementById("judulMateri").value,
        deskripsi: document.getElementById("deskripsiMateri").value,
        konten: document.getElementById("kontenMateri").value,
        tingkat: document.getElementById("tingkatMateri").value,
        durasi: parseInt(document.getElementById("durasiMateri").value),
        jenis: document.getElementById("jenisMateri").value,
        createdAt: new Date()
      };

      try {
        const materiId = document.getElementById("materiId").value;
        if (materiId) {
          await updateDoc(doc(db, "materi", materiId), materiData);
          showAlert("Materi berhasil diperbarui ✅", 'success');
        } else {
          await addDoc(collection(db, "materi"), materiData);
          showAlert("Materi berhasil ditambahkan ✅", 'success');
        }

        materiForm.reset();
        document.getElementById("materiId").value = "";
        document.getElementById("durasiMateri").value = "15";
        loadMateri();
      } catch (error) {
        console.error("Error menyimpan materi:", error);
        showAlert('Error menyimpan materi: ' + error.message);
      }
    });

    // Load soal
    async function loadSoal() {
      try {
        daftarSoal.innerHTML = '<div class="text-center py-4 text-gray-500">Memuat soal...</div>';
        const snapshot = await getDocs(collection(db, "soal"));
        
        if (snapshot.empty) {
          daftarSoal.innerHTML = '<div class="text-center py-8 text-gray-500">Belum ada soal</div>';
          soalCount.textContent = '0';
          return;
        }

        let soalArray = [];
        snapshot.forEach(docSnap => {
          soalArray.push({ id: docSnap.id, ...docSnap.data() });
        });

        // Update mapel list from existing soal
        soalArray.forEach(soal => {
          if (!daftarMapel.includes(soal.mapel)) {
            daftarMapel.push(soal.mapel);
          }
        });
        updateMapelDisplay();

        // Group by mapel
        const grouped = {};
        soalArray.forEach(soal => {
          if (!grouped[soal.mapel]) grouped[soal.mapel] = [];
          grouped[soal.mapel].push(soal);
        });

        daftarSoal.innerHTML = '';
        Object.keys(grouped).forEach(mapel => {
          const mapelSection = document.createElement("div");
          mapelSection.className = "mb-4";
          mapelSection.innerHTML = `
            <div class="bg-teal-50 border border-teal-200 rounded-lg p-3 mb-2">
              <h3 class="font-bold text-teal-700">${mapel}</h3>
            </div>
            <div class="space-y-3">
              ${grouped[mapel].map(soal => `
                <div class="border border-gray-200 rounded-lg p-4 bg-white">
                  <div class="flex justify-between items-start mb-2">
                    <p class="font-medium flex-1">${soal.pertanyaan}</p>
                    <div class="flex gap-2 ml-4">
                      <button data-id="${soal.id}" class="editSoalBtn bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button data-id="${soal.id}" class="deleteSoalBtn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                  <div class="text-sm text-gray-600">
                    <span class="font-medium">Jawaban: ${soal.jawaban}</span>
                    ${soal.penjelasan ? `<p class="mt-1">${soal.penjelasan}</p>` : ''}
                  </div>
                </div>
              `).join('')}
            </div>
          `;
          daftarSoal.appendChild(mapelSection);
        });

        soalCount.textContent = soalArray.length;

        // Attach event listeners
        document.querySelectorAll(".editSoalBtn").forEach(btn => {
          btn.addEventListener("click", async () => {
            const docId = btn.dataset.id;
            const docSnap = await getDoc(doc(db, "soal", docId));
            if (docSnap.exists()) {
              const data = docSnap.data();
              document.getElementById("soalId").value = docId;
              document.getElementById("pertanyaan").value = data.pertanyaan;
              document.getElementById("opsiA").value = data.opsi.A;
              document.getElementById("opsiB").value = data.opsi.B;
              document.getElementById("opsiC").value = data.opsi.C;
              document.getElementById("opsiD").value = data.opsi.D;
              document.getElementById("jawaban").value = data.jawaban;
              document.getElementById("penjelasan").value = data.penjelasan || '';
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }
          });
        });

        document.querySelectorAll(".deleteSoalBtn").forEach(btn => {
          btn.addEventListener("click", async () => {
            if (confirm("Yakin ingin menghapus soal ini?")) {
              try {
                await deleteDoc(doc(db, "soal", btn.dataset.id));
                showAlert("Soal berhasil dihapus", 'success');
                loadSoal();
              } catch (error) {
                showAlert('Error menghapus soal: ' + error.message);
              }
            }
          });
        });

        // Render math
        renderMath(daftarSoal);

      } catch (error) {
        console.error("Error loading soal:", error);
        daftarSoal.innerHTML = '<div class="text-center py-8 text-red-500">Error memuat soal</div>';
        showAlert('Error memuat soal: ' + error.message);
      }
    }

    // Load materi
    async function loadMateri() {
      try {
        daftarMateri.innerHTML = '<div class="text-center py-4 text-gray-500">Memuat materi...</div>';
        const snapshot = await getDocs(collection(db, "materi"));
        
        if (snapshot.empty) {
          daftarMateri.innerHTML = '<div class="text-center py-8 text-gray-500">Belum ada materi</div>';
          materiCount.textContent = '0';
          return;
        }

        let materiArray = [];
        snapshot.forEach(docSnap => {
          materiArray.push({ id: docSnap.id, ...docSnap.data() });
        });

        // Update mapel list from existing materi
        materiArray.forEach(materi => {
          if (!daftarMapel.includes(materi.mapel)) {
            daftarMapel.push(materi.mapel);
          }
        });
        updateMapelDisplay();

        // Group by mapel
        const grouped = {};
        materiArray.forEach(materi => {
          if (!grouped[materi.mapel]) grouped[materi.mapel] = [];
          grouped[materi.mapel].push(materi);
        });

        daftarMateri.innerHTML = '';
        Object.keys(grouped).forEach(mapel => {
          const mapelSection = document.createElement("div");
          mapelSection.className = "mb-4";
          mapelSection.innerHTML = `
            <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3 mb-2">
              <h3 class="font-bold text-indigo-700">${mapel}</h3>
            </div>
            <div class="space-y-3">
              ${grouped[mapel].map(materi => {
                const difficultyClass = {
                  'mudah': 'bg-green-100 text-green-800',
                  'menengah': 'bg-yellow-100 text-yellow-800',
                  'sulit': 'bg-red-100 text-red-800'
                }[materi.tingkat] || 'bg-gray-100 text-gray-800';

                return `
                  <div class="border border-gray-200 rounded-lg p-4 bg-white">
                    <div class="flex justify-between items-start mb-2">
                      <h4 class="font-bold text-lg flex-1">${materi.judul}</h4>
                      <div class="flex gap-2 ml-4">
                        <button data-id="${materi.id}" class="editMateriBtn bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button data-id="${materi.id}" class="deleteMateriBtn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </div>
                    <p class="text-gray-600 mb-3">${materi.deskripsi}</p>
                    <div class="flex flex-wrap gap-2 text-sm">
                      <span class="${difficultyClass} px-2 py-1 rounded">${materi.tingkat}</span>
                      <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">${materi.durasi} menit</span>
                      <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded">${materi.jenis}</span>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
          daftarMateri.appendChild(mapelSection);
        });

        materiCount.textContent = materiArray.length;

        // Attach event listeners
        document.querySelectorAll(".editMateriBtn").forEach(btn => {
          btn.addEventListener("click", async () => {
            const docId = btn.dataset.id;
            const docSnap = await getDoc(doc(db, "materi", docId));
            if (docSnap.exists()) {
              const data = docSnap.data();
              document.getElementById("materiId").value = docId;
              document.getElementById("materiMapel").value = data.mapel;
              document.getElementById("judulMateri").value = data.judul;
              document.getElementById("deskripsiMateri").value = data.deskripsi;
              document.getElementById("kontenMateri").value = data.konten;
              document.getElementById("tingkatMateri").value = data.tingkat;
              document.getElementById("durasiMateri").value = data.durasi;
              document.getElementById("jenisMateri").value = data.jenis;
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }
          });
        });

        document.querySelectorAll(".deleteMateriBtn").forEach(btn => {
          btn.addEventListener("click", async () => {
            if (confirm("Yakin ingin menghapus materi ini?")) {
              try {
                await deleteDoc(doc(db, "materi", btn.dataset.id));
                showAlert("Materi berhasil dihapus", 'success');
                loadMateri();
              } catch (error) {
                showAlert('Error menghapus materi: ' + error.message);
              }
            }
          });
        });

      } catch (error) {
        console.error("Error loading materi:", error);
        daftarMateri.innerHTML = '<div class="text-center py-8 text-red-500">Error memuat materi</div>';
        showAlert('Error memuat materi: ' + error.message);
      }
    }
  </script>
</body>
</html>
