<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Guru - Firebase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" 
    onload="renderMathInElement(document.body);"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-center mb-8 text-teal-700">Dashboard Guru - Upload Soal & Materi</h1>

    <!-- Loading Indicator -->
    <div id="loading" class="text-center py-8">
      <div class="inline-flex items-center">
        <i class="fas fa-spinner fa-spin text-teal-600 text-2xl mr-3"></i>
        <span class="text-gray-600">Memuat dashboard...</span>
      </div>
    </div>

    <!-- Content Area (initially hidden) -->
    <div id="content" class="hidden">
      <!-- Form input soal -->
      <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
        <h2 class="text-xl font-bold text-teal-700 mb-4">Tambah Soal Baru</h2>
        <form id="soalForm" class="space-y-4">
          <input type="hidden" id="soalId">

          <div>
            <label class="block font-semibold mb-1">Mata Pelajaran:</label>
            <div class="flex gap-2 mb-2">
              <input type="text" id="mapelInput" class="w-full border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" placeholder="Ketik nama mata pelajaran">
              <button type="button" id="tambahMapel" class="bg-teal-500 text-white px-3 py-2 rounded-lg hover:bg-teal-600 transition">+</button>
            </div>
            <div id="daftarMapel" class="flex flex-wrap gap-2"></div>
          </div>

          <div>
            <label class="block font-semibold mb-1">Pertanyaan:</label>
            <textarea id="pertanyaan" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400" placeholder="Gunakan $...$ untuk inline atau $$...$$ untuk display math" required></textarea>
          </div>

          <div>
            <label class="block font-semibold mb-1">Opsi Jawaban:</label>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <input type="text" id="opsiA" placeholder="A" class="border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" required>
              <input type="text" id="opsiB" placeholder="B" class="border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" required>
              <input type="text" id="opsiC" placeholder="C" class="border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" required>
              <input type="text" id="opsiD" placeholder="D" class="border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" required>
            </div>
          </div>

          <div>
            <label class="block font-semibold mb-1">Jawaban Benar:</label>
            <select id="jawaban" class="w-full border p-2 rounded-lg focus:ring-1 focus:ring-teal-400">
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
          </div>

          <div>
            <label class="block font-semibold mb-1">Penjelasan:</label>
            <textarea id="penjelasan" class="w-full border p-3 rounded-lg focus:ring-1 focus:ring-teal-400" placeholder="Gunakan $...$ untuk inline atau $$...$$ untuk display math"></textarea>
          </div>

          <button type="submit" class="w-full bg-teal-600 text-white p-3 rounded-lg hover:bg-teal-700 transition font-semibold flex justify-center items-center gap-2">
            <i class="fa-solid fa-floppy-disk"></i> Simpan Soal
          </button>
        </form>
      </div>

      <!-- ðŸ”¹ Form Tambah Materi -->
      <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
        <h2 class="text-xl font-bold text-teal-700 mb-4">Tambah Materi Baru</h2>
        <form id="materiForm" class="space-y-4">
          <input type="hidden" id="materiId">

          <div>
            <label class="block font-semibold mb-1">Mata Pelajaran:</label>
            <input type="text" id="materiMapel" class="w-full border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" placeholder="Ketik nama mata pelajaran" required>
          </div>

          <div>
            <label class="block font-semibold mb-1">Judul Materi:</label>
            <input type="text" id="judulMateri" class="w-full border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" placeholder="Contoh: Hukum Newton" required>
          </div>

          <div>
            <label class="block font-semibold mb-1">Deskripsi Singkat:</label>
            <textarea id="deskripsiMateri" class="w-full border p-3 rounded-lg focus:ring-1 focus:ring-teal-400" placeholder="Deskripsi singkat tentang materi ini" required></textarea>
          </div>

          <div>
            <label class="block font-semibold mb-1">Konten Materi:</label>
            <textarea id="kontenMateri" class="w-full border p-3 rounded-lg focus:ring-1 focus:ring-teal-400" rows="6" placeholder="Tulis konten materi lengkap di sini. Gunakan $...$ untuk inline atau $$...$$ untuk display math" required></textarea>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block font-semibold mb-1">Tingkat Kesulitan:</label>
              <select id="tingkatMateri" class="w-full border p-2 rounded-lg focus:ring-1 focus:ring-teal-400">
                <option value="mudah">Mudah</option>
                <option value="menengah">Menengah</option>
                <option value="sulit">Sulit</option>
              </select>
            </div>

            <div>
              <label class="block font-semibold mb-1">Durasi Belajar (menit):</label>
              <input type="number" id="durasiMateri" class="w-full border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" value="15" min="5" max="120">
            </div>

            <div>
              <label class="block font-semibold mb-1">Jenis Materi:</label>
              <select id="jenisMateri" class="w-full border p-2 rounded-lg focus:ring-1 focus:ring-teal-400">
                <option value="teori">Teori</option>
                <option value="contoh">Contoh Soal</option>
                <option value="video">Video</option>
                <option value="latihan">Latihan</option>
              </select>
            </div>
          </div>

          <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition font-semibold flex justify-center items-center gap-2">
            <i class="fa-solid fa-book"></i> Simpan Materi
          </button>
        </form>
      </div>

      <!-- ðŸ”¹ Form Fakta Harian -->
      <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
        <h2 class="text-xl font-bold text-teal-700 mb-4">Fakta Sains Harian</h2>
        <form id="faktaForm" class="space-y-4">
          <textarea id="faktaInput" class="w-full border border-gray-300 p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-400"
            placeholder="Masukkan fakta sains harian di sini..." required></textarea>
          <input type="text" id="sumberInput" class="w-full border p-2 rounded-lg focus:ring-1 focus:ring-teal-400" placeholder="Sumber fakta (contoh: Sains Daily)">
          <button type="submit" class="w-full bg-teal-600 text-white p-3 rounded-lg hover:bg-teal-700 transition font-semibold flex justify-center items-center gap-2">
            <i class="fa-solid fa-floppy-disk"></i> Simpan Fakta
          </button>
        </form>
      </div>

      <!-- Daftar soal -->
      <div class="mb-8">
        <h2 class="text-2xl font-bold text-teal-700 mb-4">Daftar Soal</h2>
        <div id="daftarSoal" class="space-y-6"></div>
      </div>

      <!-- Daftar materi -->
      <div class="mb-8">
        <h2 class="text-2xl font-bold text-teal-700 mb-4">Daftar Materi</h2>
        <div id="daftarMateri" class="space-y-6"></div>
      </div>

      <button id="logoutBtn" class="mt-6 w-full bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 transition font-semibold flex justify-center items-center gap-2">
        <i class="fa-solid fa-right-from-bracket"></i> Logout
      </button>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      <p id="errorText"></p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJ5I8k2MzAyDLt9fUcXHRNtRVjKB_ETLY",
      authDomain: "projectid-81104.firebaseapp.com",
      projectId: "projectid-81104",
      storageBucket: "projectid-81104.firebasestorage.app",
      messagingSenderId: "554913260457",
      appId: "1:554913260457:web:bf988867ebfd902c651ab8",
      measurementId: "G-8WFHQW5WGN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM Elements
    const loading = document.getElementById('loading');
    const content = document.getElementById('content');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    
    const soalForm = document.getElementById('soalForm');
    const materiForm = document.getElementById('materiForm');
    const daftarSoal = document.getElementById('daftarSoal');
    const daftarMateri = document.getElementById('daftarMateri');
    const logoutBtn = document.getElementById('logoutBtn');

    const mapelInput = document.getElementById("mapelInput");
    const tambahMapelBtn = document.getElementById("tambahMapel");
    const daftarMapelDiv = document.getElementById("daftarMapel");
    const materiMapelInput = document.getElementById("materiMapel");

    const faktaForm = document.getElementById("faktaForm");
    const faktaInput = document.getElementById("faktaInput");
    const sumberInput = document.getElementById("sumberInput");

    let daftarMapel = [];
    let currentUser = null;
    let userRole = null;

    // Show error message
    function showError(message) {
      errorText.textContent = message;
      errorMessage.classList.remove('hidden');
      loading.classList.add('hidden');
    }

    // Hide error message
    function hideError() {
      errorMessage.classList.add('hidden');
    }

    // Check if user is teacher
    async function checkUserRole(user) {
      try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (userDoc.exists()) {
          return userDoc.data().role;
        }
        return null;
      } catch (error) {
        console.error("Error checking user role:", error);
        return null;
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      currentUser = user;
      
      // Check user role
      userRole = await checkUserRole(user);
      
      if (userRole !== "guru") {
        showError("Akses ditolak. Hanya guru yang dapat mengakses dashboard ini.");
        return;
      }

      // User is teacher, show content
      hideError();
      loading.classList.add('hidden');
      content.classList.remove('hidden');
      
      // Load initial data
      loadFakta();
      loadSoal();
      loadMateri();
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });

    // ðŸ”¹ Load fakta saat dashboard dibuka
    async function loadFakta() {
      try {
        const snap = await getDoc(doc(db, "beranda", "faktaHarian"));
        if (snap.exists()) {
          faktaInput.value = snap.data().teks || "";
          sumberInput.value = snap.data().sumber || "";
        }
      } catch (error) {
        console.error("Error loading fakta:", error);
        showError("Gagal memuat fakta harian");
      }
    }

    // ðŸ”¹ Simpan fakta baru/ubah fakta lama
    faktaForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      try {
        await setDoc(doc(db, "beranda", "faktaHarian"), {
          teks: faktaInput.value,
          sumber: sumberInput.value || "Sumber tidak diketahui",
          updatedAt: new Date()
        });
        alert("Fakta sains harian berhasil disimpan âœ…");
      } catch (error) {
        console.error("Error saving fakta:", error);
        alert("Gagal menyimpan fakta sains harian");
      }
    });

    // Tambah mata pelajaran (untuk form soal)
    tambahMapelBtn.addEventListener("click", () => {
      const namaMapel = mapelInput.value.trim();
      if (!namaMapel) return;
      if (daftarMapel.includes(namaMapel)) return alert("Mata pelajaran sudah ada!");
      daftarMapel.push(namaMapel);

      const span = document.createElement("span");
      span.className = "bg-teal-100 text-teal-700 px-3 py-1 rounded-full flex items-center gap-2";
      span.innerHTML = `${namaMapel} <i class="fa-solid fa-xmark cursor-pointer"></i>`;
      span.querySelector("i").addEventListener("click", () => {
        daftarMapel = daftarMapel.filter(m => m !== namaMapel);
        daftarMapelDiv.removeChild(span);
      });

      daftarMapelDiv.appendChild(span);
      mapelInput.value = "";
    });

    // ðŸ”¹ Form soal - MENYIMPAN SETIAP SOAL TERPISAH
    soalForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      if (userRole !== "guru") {
        alert("Anda tidak memiliki izin untuk menambah soal");
        return;
      }

      const soalId = document.getElementById("soalId").value;

      if (daftarMapel.length === 0) {
        alert("Silakan tambahkan minimal satu mata pelajaran!");
        return;
      }

      const mapel = daftarMapel[daftarMapel.length - 1];
      
      // Generate unique ID untuk setiap soal jika tidak ada ID
      const timestamp = Date.now();
      const randomId = Math.random().toString(36).substring(2, 9);
      const soalDocId = soalId || `${mapel.toLowerCase().replace(/\s+/g, '_')}_${timestamp}_${randomId}`;
      
      const soalData = {
        mapel: mapel,
        pertanyaan: document.getElementById("pertanyaan").value,
        opsi: {
          A: document.getElementById("opsiA").value,
          B: document.getElementById("opsiB").value,
          C: document.getElementById("opsiC").value,
          D: document.getElementById("opsiD").value
        },
        jawaban: document.getElementById("jawaban").value,
        penjelasan: document.getElementById("penjelasan").value,
        createdAt: new Date(),
        updatedAt: new Date(),
        createdBy: currentUser.uid,
        soalId: soalDocId // ID unik untuk setiap soal
      };

      try {
        if (soalId) {
          // Update soal yang sudah ada
          await updateDoc(doc(db, "soal", soalId), soalData);
          alert("Soal berhasil diperbarui âœ…");
        } else {
          // Simpan sebagai dokumen baru dengan ID yang sudah ditentukan
          await setDoc(doc(db, "soal", soalDocId), soalData);
          alert("Soal berhasil ditambahkan âœ…");
        }

        soalForm.reset();
        document.getElementById("soalId").value = "";
        daftarMapel = [];
        daftarMapelDiv.innerHTML = "";
        loadSoal();
      } catch (error) {
        console.error("Error menyimpan soal:", error);
        alert("Terjadi kesalahan saat menyimpan soal: " + error.message);
      }
    });

    // ðŸ”¹ Form materi
    materiForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      if (userRole !== "guru") {
        alert("Anda tidak memiliki izin untuk menambah materi");
        return;
      }

      const materiId = document.getElementById("materiId").value;
      const mapelMateri = materiMapelInput.value.trim();

      if (!mapelMateri) {
        alert("Silakan isi nama mata pelajaran!");
        return;
      }

      const materiData = {
        mapel: mapelMateri,
        judul: document.getElementById("judulMateri").value,
        deskripsi: document.getElementById("deskripsiMateri").value,
        konten: document.getElementById("kontenMateri").value,
        tingkat: document.getElementById("tingkatMateri").value,
        durasi: parseInt(document.getElementById("durasiMateri").value),
        jenis: document.getElementById("jenisMateri").value,
        createdAt: new Date(),
        updatedAt: new Date(),
        createdBy: currentUser.uid
      };

      try {
        if (materiId) {
          await updateDoc(doc(db, "materi", materiId), materiData);
          alert("Materi berhasil diperbarui âœ…");
        } else {
          // Generate unique ID untuk materi
          const timestamp = Date.now();
          const randomId = Math.random().toString(36).substring(2, 9);
          const materiDocId = `${mapelMateri.toLowerCase().replace(/\s+/g, '_')}_materi_${timestamp}_${randomId}`;
          
          await setDoc(doc(db, "materi", materiDocId), materiData);
          alert("Materi berhasil ditambahkan âœ…");
        }

        materiForm.reset();
        document.getElementById("materiId").value = "";
        document.getElementById("durasiMateri").value = "15";
        loadMateri();
      } catch (error) {
        console.error("Error menyimpan materi:", error);
        alert("Terjadi kesalahan saat menyimpan materi: " + error.message);
      }
    });

    // ðŸ”¹ Load soal - SETIAP SOAL DITAMPILKAN SECARA TERPISAH
    async function loadSoal() {
      try {
        daftarSoal.innerHTML = "";
        const snapshot = await getDocs(collection(db, "soal"));
        
        if (snapshot.empty) {
          daftarSoal.innerHTML = `
            <div class="bg-white p-8 rounded-2xl shadow text-center">
              <i class="fas fa-clipboard-question text-4xl text-gray-300 mb-4"></i>
              <h3 class="text-xl font-semibold text-gray-600 mb-2">Belum Ada Soal</h3>
              <p class="text-gray-500">Tambahkan soal pertama Anda menggunakan form di atas.</p>
            </div>
          `;
          return;
        }

        // Kelompokkan soal berdasarkan mata pelajaran
        const grouped = {};
        
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const mapel = data.mapel || "Tanpa Kategori";
          
          if (!grouped[mapel]) grouped[mapel] = [];
          grouped[mapel].push({ 
            id: docSnap.id, 
            ...data,
            index: grouped[mapel].length + 1
          });
        });

        // Tampilkan soal per mata pelajaran
        Object.keys(grouped).forEach(mapel => {
          const container = document.createElement("div");
          container.className = "bg-white rounded-2xl shadow mb-6";
          container.id = `mapel-${mapel.toLowerCase().replace(/\s+/g, '-')}`;

          const jumlahSoal = grouped[mapel].length;
          container.innerHTML = `
            <div class="p-4 bg-teal-600 text-white rounded-t-2xl cursor-pointer flex justify-between items-center">
              <div class="flex items-center gap-3">
                <i class="fa-solid fa-book-open"></i>
                <h2 class="text-lg font-semibold">${mapel}</h2>
                <span class="bg-teal-500 text-white text-xs px-2 py-1 rounded-full">${jumlahSoal} soal</span>
              </div>
              <i class="fa-solid fa-chevron-down transition-transform duration-300"></i>
            </div>
            <div class="p-4 space-y-4 hidden soal-container"></div>
          `;
          
          const soalList = container.querySelector(".soal-container");

          // Tampilkan setiap soal secara terpisah
          grouped[mapel].forEach((item, idx) => {
            const soalCard = document.createElement("div");
            soalCard.className = "bg-gray-50 p-4 rounded-xl shadow border border-gray-200";
            soalCard.id = `soal-${item.id}`;
            
            soalCard.innerHTML = `
              <div class="mb-4">
                <div class="flex justify-between items-start mb-3">
                  <div class="flex items-center gap-2">
                    <span class="bg-teal-100 text-teal-700 px-2 py-1 rounded text-sm font-medium">Soal #${idx + 1}</span>
                    <span class="text-xs text-gray-500">ID: ${item.id.substring(0, 8)}...</span>
                  </div>
                  <div class="flex gap-2">
                    <button data-id="${item.id}" class="editSoalBtn bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition flex items-center gap-1 text-sm">
                      <i class="fa-solid fa-pen text-xs"></i> Edit
                    </button>
                    <button data-id="${item.id}" class="deleteSoalBtn bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition flex items-center gap-1 text-sm">
                      <i class="fa-solid fa-trash text-xs"></i> Hapus
                    </button>
                  </div>
                </div>
                
                <div class="mb-4">
                  <p class="font-semibold text-gray-800 mb-2">Pertanyaan:</p>
                  <div class="bg-white p-3 rounded-lg border border-gray-300 katex-content">${item.pertanyaan}</div>
                </div>
                
                <div class="mb-4">
                  <p class="font-semibold text-gray-800 mb-2">Opsi Jawaban:</p>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <div class="flex items-center gap-2 p-2 rounded ${item.jawaban === 'A' ? 'bg-green-50 border border-green-200' : 'bg-gray-100'}">
                      <span class="font-bold ${item.jawaban === 'A' ? 'text-green-600' : 'text-gray-600'}">A.</span>
                      <span class="katex-content">${item.opsi.A}</span>
                      ${item.jawaban === 'A' ? '<span class="ml-auto bg-green-500 text-white text-xs px-2 py-1 rounded">Benar</span>' : ''}
                    </div>
                    <div class="flex items-center gap-2 p-2 rounded ${item.jawaban === 'B' ? 'bg-green-50 border border-green-200' : 'bg-gray-100'}">
                      <span class="font-bold ${item.jawaban === 'B' ? 'text-green-600' : 'text-gray-600'}">B.</span>
                      <span class="katex-content">${item.opsi.B}</span>
                      ${item.jawaban === 'B' ? '<span class="ml-auto bg-green-500 text-white text-xs px-2 py-1 rounded">Benar</span>' : ''}
                    </div>
                    <div class="flex items-center gap-2 p-2 rounded ${item.jawaban === 'C' ? 'bg-green-50 border border-green-200' : 'bg-gray-100'}">
                      <span class="font-bold ${item.jawaban === 'C' ? 'text-green-600' : 'text-gray-600'}">C.</span>
                      <span class="katex-content">${item.opsi.C}</span>
                      ${item.jawaban === 'C' ? '<span class="ml-auto bg-green-500 text-white text-xs px-2 py-1 rounded">Benar</span>' : ''}
                    </div>
                    <div class="flex items-center gap-2 p-2 rounded ${item.jawaban === 'D' ? 'bg-green-50 border border-green-200' : 'bg-gray-100'}">
                      <span class="font-bold ${item.jawaban === 'D' ? 'text-green-600' : 'text-gray-600'}">D.</span>
                      <span class="katex-content">${item.opsi.D}</span>
                      ${item.jawaban === 'D' ? '<span class="ml-auto bg-green-500 text-white text-xs px-2 py-1 rounded">Benar</span>' : ''}
                    </div>
                  </div>
                </div>
                
                ${item.penjelasan ? `
                <div class="mb-4">
                  <p class="font-semibold text-gray-800 mb-2">Penjelasan:</p>
                  <div class="bg-white p-3 rounded-lg border border-gray-300 katex-content">${item.penjelasan}</div>
                </div>
                ` : ''}
                
                <div class="text-xs text-gray-500 flex justify-between items-center pt-2 border-t border-gray-200">
                  <span>Dibuat: ${new Date(item.createdAt?.toDate() || item.createdAt).toLocaleDateString('id-ID')}</span>
                  <span class="bg-gray-200 px-2 py-1 rounded">ID: ${item.id}</span>
                </div>
              </div>
            `;
            
            soalList.appendChild(soalCard);
            
            // Render MathJax untuk konten soal
            renderMathInElement(soalCard, {
              delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
              ],
              throwOnError: false
            });
          });

          // Toggle show/hide untuk container mapel
          container.querySelector("div:first-child").addEventListener("click", (e) => {
            const icon = e.currentTarget.querySelector(".fa-chevron-down");
            icon.classList.toggle("rotate-180");
            soalList.classList.toggle("hidden");
          });

          daftarSoal.appendChild(container);
        });

        // Setup event listeners untuk edit dan hapus soal
        setupSoalEventListeners();
        
      } catch (error) {
        console.error("Error loading soal:", error);
        showError("Gagal memuat daftar soal");
      }
    }

    // ðŸ”¹ Setup event listeners untuk edit dan hapus soal
    function setupSoalEventListeners() {
      // Edit soal
      document.querySelectorAll(".editSoalBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const docId = btn.dataset.id;
          const docSnap = await getDoc(doc(db, "soal", docId));
          
          if (docSnap.exists()) {
            const data = docSnap.data();
            
            // Isi form edit
            document.getElementById("soalId").value = docId;
            
            // Kosongkan dan isi ulang daftar mapel
            daftarMapel = [];
            daftarMapelDiv.innerHTML = "";
            daftarMapel.push(data.mapel);
            
            const span = document.createElement("span");
            span.className = "bg-teal-100 text-teal-700 px-3 py-1 rounded-full flex items-center gap-2";
            span.innerHTML = `${data.mapel} <i class="fa-solid fa-xmark cursor-pointer"></i>`;
            daftarMapelDiv.appendChild(span);
            
            // Isi field lainnya
            document.getElementById("pertanyaan").value = data.pertanyaan;
            document.getElementById("opsiA").value = data.opsi.A;
            document.getElementById("opsiB").value = data.opsi.B;
            document.getElementById("opsiC").value = data.opsi.C;
            document.getElementById("opsiD").value = data.opsi.D;
            document.getElementById("jawaban").value = data.jawaban;
            document.getElementById("penjelasan").value = data.penjelasan || "";
            
            // Scroll ke form
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Update judul button
            const submitBtn = soalForm.querySelector("button[type='submit']");
            submitBtn.innerHTML = '<i class="fa-solid fa-pen"></i> Update Soal';
            submitBtn.className = "w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition font-semibold flex justify-center items-center gap-2";
          }
        });
      });

      // Hapus soal
      document.querySelectorAll(".deleteSoalBtn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const docId = btn.dataset.id;
          
          if (confirm("Yakin ingin menghapus soal ini?\nSoal akan dihapus secara permanen.")) {
            try {
              await deleteDoc(doc(db, "soal", docId));
              alert("Soal berhasil dihapus âœ…");
              loadSoal();
            } catch (error) {
              console.error("Error deleting soal:", error);
              alert("Gagal menghapus soal: " + error.message);
            }
          }
        });
      });
    }

    // ðŸ”¹ Load materi
    async function loadMateri() {
      try {
        daftarMateri.innerHTML = "";
        const snapshot = await getDocs(collection(db, "materi"));
        
        if (snapshot.empty) {
          daftarMateri.innerHTML = `
            <div class="bg-white p-8 rounded-2xl shadow text-center">
              <i class="fas fa-book text-4xl text-gray-300 mb-4"></i>
              <h3 class="text-xl font-semibold text-gray-600 mb-2">Belum Ada Materi</h3>
              <p class="text-gray-500">Tambahkan materi pertama Anda menggunakan form di atas.</p>
            </div>
          `;
          return;
        }
        
        const grouped = {};
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (!grouped[data.mapel]) grouped[data.mapel] = [];
          grouped[data.mapel].push({ id: docSnap.id, ...data });
        });

        Object.keys(grouped).forEach(mapel => {
          const container = document.createElement("div");
          container.className = "bg-white rounded-2xl shadow";

          container.innerHTML = `
            <div class="p-4 bg-indigo-600 text-white rounded-t-2xl cursor-pointer flex justify-between items-center">
              <h2 class="text-lg font-semibold">${mapel} (${grouped[mapel].length} materi)</h2>
              <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div class="p-4 space-y-4 hidden"></div>
          `;
          const materiList = container.querySelector("div:last-child");

          grouped[mapel].forEach(item => {
            const li = document.createElement("div");
            li.className = "bg-gray-50 p-4 rounded-xl shadow flex flex-col md:flex-row md:justify-between md:items-start gap-4 border border-gray-200";
            
            // Tentukan warna badge berdasarkan tingkat kesulitan
            let difficultyClass = "bg-green-100 text-green-800";
            if (item.tingkat === "menengah") {
              difficultyClass = "bg-yellow-100 text-yellow-800";
            } else if (item.tingkat === "sulit") {
              difficultyClass = "bg-red-100 text-red-800";
            }
            
            li.innerHTML = `
              <div class="flex-grow">
                <h3 class="font-bold text-lg mb-1">${item.judul}</h3>
                <p class="text-gray-600 mb-2">${item.deskripsi}</p>
                <div class="flex flex-wrap gap-2 text-sm mb-3">
                  <span class="${difficultyClass} px-2 py-1 rounded-full">${item.tingkat}</span>
                  <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${item.durasi} menit</span>
                  <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full">${item.jenis}</span>
                </div>
                <div class="text-xs text-gray-500">ID: ${item.id.substring(0, 10)}...</div>
              </div>
              <div class="flex gap-2">
                <button data-id="${item.id}" class="editMateriBtn bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 transition flex items-center gap-1">
                  <i class="fa-solid fa-pen"></i> Edit
                </button>
                <button data-id="${item.id}" class="deleteMateriBtn bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 transition flex items-center gap-1">
                  <i class="fa-solid fa-trash"></i> Hapus
                </button>
              </div>
            `;
            materiList.appendChild(li);
          });

          container.querySelector("div:first-child").addEventListener("click", () => {
            materiList.classList.toggle("hidden");
          });

          daftarMateri.appendChild(container);
        });

        // Edit & Hapus materi
        document.querySelectorAll(".editMateriBtn").forEach(btn => {
          btn.addEventListener("click", async () => {
            const docId = btn.dataset.id;
            const docSnap = await getDoc(doc(db, "materi", docId));
            if (docSnap.exists()) {
              const data = docSnap.data();
              document.getElementById("materiId").value = docId;
              document.getElementById("materiMapel").value = data.mapel;
              document.getElementById("judulMateri").value = data.judul;
              document.getElementById("deskripsiMateri").value = data.deskripsi;
              document.getElementById("kontenMateri").value = data.konten;
              document.getElementById("tingkatMateri").value = data.tingkat;
              document.getElementById("durasiMateri").value = data.durasi;
              document.getElementById("jenisMateri").value = data.jenis;
              
              // Update button
              const submitBtn = materiForm.querySelector("button[type='submit']");
              submitBtn.innerHTML = '<i class="fa-solid fa-pen"></i> Update Materi';
              submitBtn.className = "w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition font-semibold flex justify-center items-center gap-2";
              
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }
          });
        });

        document.querySelectorAll(".deleteMateriBtn").forEach(btn => {
          btn.addEventListener("click", async () => {
            if (confirm("Yakin ingin menghapus materi ini?")) {
              try {
                await deleteDoc(doc(db, "materi", btn.dataset.id));
                loadMateri();
              } catch (error) {
                console.error("Error deleting materi:", error);
                alert("Gagal menghapus materi: " + error.message);
              }
            }
          });
        });
      } catch (error) {
        console.error("Error loading materi:", error);
        showError("Gagal memuat daftar materi");
      }
    }

    // Reset form ketika klik mapel input (untuk soal baru)
    mapelInput.addEventListener("focus", () => {
      const submitBtn = soalForm.querySelector("button[type='submit']");
      if (document.getElementById("soalId").value) {
        // Jika sedang edit, reset ke mode tambah
        document.getElementById("soalId").value = "";
        submitBtn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Simpan Soal';
        submitBtn.className = "w-full bg-teal-600 text-white p-3 rounded-lg hover:bg-teal-700 transition font-semibold flex justify-center items-center gap-2";
        soalForm.reset();
        daftarMapel = [];
        daftarMapelDiv.innerHTML = "";
      }
    });

    // Reset form ketika klik materi mapel input (untuk materi baru)
    materiMapelInput.addEventListener("focus", () => {
      if (document.getElementById("materiId").value) {
        // Jika sedang edit, reset ke mode tambah
        document.getElementById("materiId").value = "";
        const submitBtn = materiForm.querySelector("button[type='submit']");
        submitBtn.innerHTML = '<i class="fa-solid fa-book"></i> Simpan Materi';
        submitBtn.className = "w-full bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition font-semibold flex justify-center items-center gap-2";
        materiForm.reset();
        document.getElementById("durasiMateri").value = "15";
      }
    });
  </script>
  
  <style>
    .rotate-180 {
      transform: rotate(180deg);
      transition: transform 0.3s ease;
    }
    
    /* Style untuk KaTeX rendering */
    .katex-content .katex {
      font-size: 1.1em;
    }
    
    /* Animasi untuk card soal */
    .soal-card {
      transition: all 0.3s ease;
    }
    
    .soal-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
  </style>
</body>
</html>
