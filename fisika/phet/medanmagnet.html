<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUANTARA - Simulasi Medan Magnet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #38b2ac;
            --secondary: #0e7490;
            --accent: #f59e0b;
        }
        
        body {
            font-family: 'Baloo 2', cursive;
            background-color: #f8fafc;
            overflow-x: hidden;
        }
        
        .app-container {
            max-width: 414px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        /* NAVBAR */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 414px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            background: white;
            z-index: 10;
            height: 70px;
            display: flex;
            align-items: center;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            text-decoration: none;
            flex: 1;
            height: 100%;
            padding: 0.5rem 0;
            transition: all 0.3s ease;
        }
        
        .nav-item span {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        
        .nav-item.active {
            color: var(--primary);
        }
        
        .nav-icon {
            transition: all 0.3s ease;
            font-size: 1.25rem;
        }
        
        .nav-icon.active {
            transform: translateY(-5px);
            color: var(--primary);
        }
        
        /* Magnetic Field Canvas */
        .field-container {
            position: relative;
            background: linear-gradient(135deg, #1a202c, #2d3748);
            border-radius: 12px;
            overflow: hidden;
            height: 300px;
            margin-bottom: 15px;
        }
        
        #magnetic-field {
            width: 100%;
            height: 100%;
        }
        
        /* Canvas untuk partikel */
        .particles-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            pointer-events: none;
        }
        
        /* Chart Container */
        .chart-container {
            height: 280px;
            position: relative;
            background: white;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .field-chart-container {
            height: 300px;
            position: relative;
            background: white;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        /* Empty Chart State */
        .empty-chart {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9ca3af;
            text-align: center;
        }
        
        .empty-chart-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        .empty-chart-text {
            font-size: 12px;
            max-width: 200px;
        }
        
        /* Chart Controls */
        .chart-controls {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .chart-btn {
            padding: 4px 10px;
            font-size: 11px;
            border-radius: 6px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .chart-btn:hover {
            background: #e5e7eb;
        }
        
        .chart-btn.active {
            background: #38b2ac;
            color: white;
            border-color: #38b2ac;
        }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #38b2ac;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Error Message */
        .error-message {
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        
        /* Table Styles */
        .data-table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
            background: white;
        }
        
        .data-table th {
            background-color: #38b2ac;
            color: white;
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #2c9c96;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #f1f5f9;
            color: #475569;
        }
        
        .data-table tr:hover {
            background-color: #f8fafc;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        .data-table tr:nth-child(even):hover {
            background-color: #f3f4f6;
        }
        
        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .export-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .export-btn-chart {
            background-color: #38b2ac;
            color: white;
        }
        
        .export-btn-chart:hover {
            background-color: #319795;
        }
        
        .export-btn-data {
            background-color: #8b5cf6;
            color: white;
        }
        
        .export-btn-data:hover {
            background-color: #7c3aed;
        }
        
        /* Scrollable Table Container */
        .table-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-top: 10px;
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }
        
        /* Section header */
        .section-header {
            font-size: 13px;
            font-weight: 600;
        }
        
        /* Field Controls */
        .field-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .control-group {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .control-label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 8px;
        }
        
        .control-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 12px;
            background: white;
        }
        
        .control-slider {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            outline: none;
            margin-top: 5px;
        }
        
        .control-value {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
            text-align: center;
        }
        
        .simulation-btn {
            background: linear-gradient(to right, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .simulation-btn:hover {
            background: linear-gradient(to right, #7c3aed, #6d28d9);
            transform: translateY(-2px);
        }
        
        .simulation-btn:active {
            transform: translateY(0);
        }
        
        .field-info {
            background: linear-gradient(to right, #dbeafe, #e0f2fe);
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 12px;
        }
        
        .info-label {
            color: #475569;
            font-weight: 500;
        }
        
        .info-value {
            color: #1e40af;
            font-weight: 600;
        }
        
        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            background: #f3f4f6;
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 15px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 8px 12px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: white;
            color: #38b2ac;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Magnet Styles */
        .magnet {
            position: absolute;
            transition: all 0.5s ease;
            z-index: 10;
        }
        
        .north-pole {
            color: #ef4444;
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.7);
        }
        
        .south-pole {
            color: #3b82f6;
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.7);
        }
        
        /* Particle animation */
        @keyframes particle-float {
            0% { transform: translateY(0) translateX(0); opacity: 0.8; }
            100% { transform: translateY(-20px) translateX(10px); opacity: 0; }
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            pointer-events: none;
            animation: particle-float 1.5s ease-in infinite;
        }
        
        /* Magnetic field lines animation */
        @keyframes field-pulse {
            0% { opacity: 0.3; }
            50% { opacity: 0.7; }
            100% { opacity: 0.3; }
        }
        
        .field-line {
            animation: field-pulse 2s ease-in-out infinite;
        }
        
        /* Lorentz Force Arrow */
        .force-arrow {
            position: absolute;
            z-index: 5;
        }
        
        .force-arrow-line {
            stroke-width: 3;
            stroke-linecap: round;
        }
        
        .force-arrow-head {
            fill: #f59e0b;
        }
        
        @media (max-width: 380px) {
            .chart-container, .field-chart-container {
                height: 250px;
            }
            
            .data-table {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile App Container -->
    <div class="app-container">
        
        <!-- Loading Indicator -->
        <div id="loading" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-50">
            <div class="loading-spinner mb-4"></div>
            <p class="text-gray-700 font-medium">Menyiapkan Simulasi Medan Magnet...</p>
            <p class="text-gray-500 text-sm mt-2">Memuat komponen simulasi</p>
        </div>
        
        <!-- Error Message -->
        <div id="error-message" class="error-message m-4 hidden">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle mr-3"></i>
                <div>
                    <p class="font-medium" id="error-title">Terjadi Kesalahan</p>
                    <p class="text-sm" id="error-detail"></p>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <main class="pb-24 p-4 custom-scrollbar" style="max-height: calc(100vh - 70px); overflow-y: auto;">
            <!-- Page Title -->
            <div class="mb-4">
                <h1 class="text-lg font-bold text-gray-800 mb-1">
                    <i class="fas fa-magnet text-red-500 mr-2"></i> Simulasi Medan Magnet & Gaya Lorentz
                </h1>
                <p class="text-gray-600 text-xs">
                    Simulasi gaya magnet dan gaya Lorentz dengan visualisasi yang realistis
                </p>
            </div>
            
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" id="tab-simulasi">
                    <i class="fas fa-magnet mr-1"></i> Simulasi
                </button>
                <button class="tab-btn" id="tab-data">
                    <i class="fas fa-table mr-1"></i> Data
                </button>
                <button class="tab-btn" id="tab-ekspor">
                    <i class="fas fa-download mr-1"></i> Ekspor
                </button>
            </div>
            
            <!-- Simulation Tab Content -->
            <div id="simulasi-content">
                <!-- Magnetic Field Visualization -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="section-header text-gray-700 flex items-center">
                            <i class="fas fa-atom text-blue-500 mr-2 text-xs"></i> Visualisasi Gaya Lorentz
                        </h3>
                        <div class="flex items-center gap-2">
                            <div class="text-xs text-white bg-blue-600 px-2 py-1 rounded">
                                <span id="simulation-time">0.0</span> s
                            </div>
                            <div class="text-xs text-white bg-red-500 px-2 py-1 rounded">
                                <span id="simulation-timer">5.0</span> s
                            </div>
                        </div>
                    </div>
                    
                    <div class="field-container">
                        <canvas id="magnetic-field"></canvas>
                        <!-- Particles will be drawn on this canvas -->
                        <canvas id="particles" class="particles-canvas"></canvas>
                        <!-- Lorentz force arrows will be drawn on this canvas -->
                        <canvas id="force-arrows" class="particles-canvas"></canvas>
                        
                        <!-- Magnets will be placed here -->
                        <div id="magnet-north" class="magnet">
                            <i class="fas fa-magnet text-4xl north-pole"></i>
                            <div class="text-xs text-white bg-red-500 px-2 py-1 rounded mt-1">UTARA</div>
                        </div>
                        
                        <div id="magnet-south" class="magnet">
                            <i class="fas fa-magnet text-4xl south-pole"></i>
                            <div class="text-xs text-white bg-blue-500 px-2 py-1 rounded mt-1">SELATAN</div>
                        </div>
                    </div>
                    
                    <!-- Field Info -->
                    <div class="field-info">
                        <div class="info-row">
                            <span class="info-label">Gaya Lorentz Aktif:</span>
                            <span class="info-value" id="info-lorentz-active">0.00 N</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Medan Magnet (B):</span>
                            <span class="info-value" id="info-magnetic-field">2.00 T</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Sudut θ (v⊥B):</span>
                            <span class="info-value" id="info-angle">90°</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Arah Gaya:</span>
                            <span class="info-value" id="info-force-direction">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Simulation Controls -->
                <div class="mb-6 p-4 bg-white border border-gray-200 rounded-xl shadow-sm">
                    <h3 class="section-header text-gray-700 flex items-center mb-4">
                        <i class="fas fa-sliders-h text-purple-500 mr-2 text-xs"></i> Kontrol Simulasi (5 Detik)
                    </h3>
                    
                    <div class="field-controls">
                        <!-- Kekuatan Magnet -->
                        <div class="control-group">
                            <label class="control-label">
                                <i class="fas fa-hand-rock mr-1"></i> Medan Magnet (B)
                            </label>
                            <input type="range" min="0.1" max="5" value="2" step="0.1" class="control-slider" id="strength-slider">
                            <div class="control-value" id="strength-value">2.0 Tesla</div>
                        </div>
                        
                        <!-- Muatan Partikel -->
                        <div class="control-group">
                            <label class="control-label">
                                <i class="fas fa-bolt mr-1"></i> Muatan (q)
                            </label>
                            <input type="range" min="-5" max="5" value="1" step="0.1" class="control-slider" id="charge-slider">
                            <div class="control-value" id="charge-value">+1 C</div>
                        </div>
                        
                        <!-- Kecepatan Partikel -->
                        <div class="control-group">
                            <label class="control-label">
                                <i class="fas fa-tachometer-alt mr-1"></i> Kecepatan (v)
                            </label>
                            <input type="range" min="1" max="20" value="10" class="control-slider" id="velocity-slider">
                            <div class="control-value" id="velocity-value">10 m/s</div>
                        </div>
                        
                        <!-- Sudut -->
                        <div class="control-group">
                            <label class="control-label">
                                <i class="fas fa-angle-up mr-1"></i> Sudut (θ)
                            </label>
                            <input type="range" min="0" max="180" value="90" class="control-slider" id="angle-slider">
                            <div class="control-value" id="angle-value">90°</div>
                        </div>
                    </div>
                    
                    <!-- Simulation Buttons -->
                    <div class="grid grid-cols-2 gap-3 mt-4">
                        <button id="btn-start-simulation" class="simulation-btn">
                            <i class="fas fa-play"></i> Mulai (5s)
                        </button>
                        <button id="btn-reset-simulation" class="simulation-btn" style="background: linear-gradient(to right, #6b7280, #4b5563);">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                        <button id="btn-pause-simulation" class="simulation-btn col-span-2" style="background: linear-gradient(to right, #f59e0b, #d97706);">
                            <i class="fas fa-pause"></i> Jeda / Lanjutkan
                        </button>
                    </div>
                </div>
                
                <!-- Real-time Data Visualization -->
                <div class="mb-6 p-4 bg-white border border-gray-200 rounded-xl shadow-sm">
                    <h3 class="section-header text-gray-700 flex items-center mb-4">
                        <i class="fas fa-chart-bar text-green-500 mr-2 text-xs"></i> Grafik Real-time (5 Detik)
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <p class="text-xs text-blue-700">Gaya Lorentz</p>
                            <p id="current-force" class="text-lg font-bold text-blue-800">0.00 N</p>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <p class="text-xs text-green-700">Energi Partikel</p>
                            <p id="current-energy" class="text-lg font-bold text-green-800">0.00 J</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg">
                            <p class="text-xs text-purple-700">Momentum</p>
                            <p id="current-momentum" class="text-lg font-bold text-purple-800">0.00 kg·m/s</p>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg">
                            <p class="text-xs text-red-700">Jari-jari Lintasan</p>
                            <p id="current-radius" class="text-lg font-bold text-red-800">0.00 m</p>
                        </div>
                    </div>
                    
                    <!-- Real-time Charts -->
                    <div class="chart-container mb-3">
                        <!-- Empty State for Force Chart -->
                        <div id="force-empty-state" class="empty-chart">
                            <i class="fas fa-hand-rock empty-chart-icon"></i>
                            <p class="empty-chart-text">
                                Grafik gaya Lorentz akan muncul saat simulasi berjalan
                            </p>
                        </div>
                        <canvas id="force-chart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <!-- Empty State for Energy Chart -->
                        <div id="energy-empty-state" class="empty-chart">
                            <i class="fas fa-bolt empty-chart-icon"></i>
                            <p class="empty-chart-text">
                                Grafik energi akan muncul saat simulasi berjalan
                            </p>
                        </div>
                        <canvas id="energy-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Data Tab Content (Hidden by default) -->
            <div id="data-content" class="hidden">
                <div class="mb-6 p-4 bg-white border border-gray-200 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="section-header text-gray-700 flex items-center">
                            <i class="fas fa-database text-purple-500 mr-2 text-xs"></i> Data Simulasi Real-time
                        </h3>
                        <div class="flex gap-2">
                            <button id="btn-clear-data" class="text-xs px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">
                                <i class="fas fa-trash mr-1"></i> Hapus
                            </button>
                            <button id="btn-export-selected" class="text-xs px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200">
                                <i class="fas fa-download mr-1"></i> Ekspor Terpilih
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table" id="magnetic-table">
                            <thead>
                                <tr>
                                    <th style="width: 30px;">
                                        <input type="checkbox" id="select-all">
                                    </th>
                                    <th>Waktu (s)</th>
                                    <th>F Lorentz (N)</th>
                                    <th>Energi (J)</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="magnetic-table-body">
                                <!-- Data rows will be inserted here -->
                                <tr>
                                    <td colspan="5" class="text-center py-6 text-gray-500">
                                        <i class="fas fa-database text-2xl mb-2 block text-gray-300"></i>
                                        <p class="text-sm">Belum ada data simulasi</p>
                                        <p class="text-xs mt-1">Klik "Mulai Simulasi" untuk memulai</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 grid grid-cols-4 gap-3">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-600">Total Data</p>
                            <p id="data-count" class="text-lg font-bold text-gray-800">0</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-600">Interval</p>
                            <p id="data-interval" class="text-lg font-bold text-gray-800">0.1 s</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-600">Tersisa</p>
                            <p id="data-remaining" class="text-lg font-bold text-blue-600">5.0 s</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-600">Status</p>
                            <p id="data-status" class="text-lg font-bold text-green-600">Siap</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Export Tab Content (Hidden by default) -->
            <div id="ekspor-content" class="hidden">
                <div class="mb-6 p-4 bg-white border border-gray-200 rounded-xl shadow-sm">
                    <h3 class="section-header text-gray-700 flex items-center mb-4">
                        <i class="fas fa-file-export text-green-500 mr-2 text-xs"></i> Ekspor Data Simulasi
                    </h3>
                    
                    <div class="space-y-4">
                        <!-- Export Individual Data -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-sm font-semibold text-blue-800 mb-3">
                                <i class="fas fa-file-export mr-2"></i> Ekspor Data Per Waktu
                            </h4>
                            
                            <div class="mb-3">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Pilih Waktu Spesifik:</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="export-specific-time" value="0" min="0" max="5" step="0.1" class="flex-1 p-2 border border-gray-300 rounded text-xs" placeholder="Waktu (s)">
                                    <button id="btn-export-specific" class="px-3 py-2 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                                        <i class="fas fa-download mr-1"></i> Ekspor
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Rentang: 0.0 - 5.0 detik</p>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2">
                                <button id="btn-export-first" class="px-3 py-2 bg-green-500 text-white rounded text-xs hover:bg-green-600">
                                    <i class="fas fa-download mr-1"></i> Data Pertama
                                </button>
                                <button id="btn-export-last" class="px-3 py-2 bg-purple-500 text-white rounded text-xs hover:bg-purple-600">
                                    <i class="fas fa-download mr-1"></i> Data Terakhir
                                </button>
                                <button id="btn-export-max" class="px-3 py-2 bg-red-500 text-white rounded text-xs hover:bg-red-600">
                                    <i class="fas fa-download mr-1"></i> Data Maksimum
                                </button>
                                <button id="btn-export-min" class="px-3 py-2 bg-yellow-500 text-white rounded text-xs hover:bg-yellow-600">
                                    <i class="fas fa-download mr-1"></i> Data Minimum
                                </button>
                            </div>
                        </div>
                        
                        <!-- Export Range -->
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h4 class="text-sm font-semibold text-purple-800 mb-3">
                                <i class="fas fa-cog mr-2"></i> Ekspor Berdasarkan Rentang
                            </h4>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Format Data</label>
                                    <select id="export-format" class="w-full p-2 border border-gray-300 rounded text-xs">
                                        <option value="csv">CSV (Excel)</option>
                                        <option value="json">JSON</option>
                                        <option value="txt">Teks</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">Presisi Data</label>
                                    <select id="export-precision" class="w-full p-2 border border-gray-300 rounded text-xs">
                                        <option value="2">2 Desimal</option>
                                        <option value="3">3 Desimal</option>
                                        <option value="4">4 Desimal</option>
                                        <option value="6">6 Desimal</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <label class="block text-xs font-medium text-gray-700 mb-1">Rentang Waktu (0-5 detik)</label>
                                <div class="flex gap-2">
                                    <input type="number" id="export-start" value="0" min="0" max="5" step="0.1" class="flex-1 p-2 border border-gray-300 rounded text-xs" placeholder="Mulai (s)">
                                    <input type="number" id="export-end" value="5" min="0" max="5" step="0.1" class="flex-1 p-2 border border-gray-300 rounded text-xs" placeholder="Selesai (s)">
                                </div>
                                <div class="flex gap-2 mt-2">
                                    <button id="btn-export-range" class="flex-1 px-3 py-2 bg-purple-500 text-white rounded text-xs hover:bg-purple-600">
                                        <i class="fas fa-download mr-1"></i> Ekspor Rentang
                                    </button>
                                    <button id="btn-export-all" class="flex-1 px-3 py-2 bg-green-600 text-white rounded text-xs hover:bg-green-700">
                                        <i class="fas fa-download mr-1"></i> Semua Data
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Export Charts -->
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="text-sm font-semibold text-green-800 mb-3">
                                <i class="fas fa-chart-line mr-2"></i> Ekspor Visualisasi
                            </h4>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <button id="btn-export-chart-force" class="px-3 py-2 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                                    <i class="fas fa-download mr-1"></i> Grafik Gaya
                                </button>
                                <button id="btn-export-chart-energy" class="px-3 py-2 bg-green-500 text-white rounded text-xs hover:bg-green-600">
                                    <i class="fas fa-download mr-1"></i> Grafik Energi
                                </button>
                                <button id="btn-export-chart-both" class="col-span-2 px-3 py-2 bg-purple-500 text-white rounded text-xs hover:bg-purple-600">
                                    <i class="fas fa-download mr-1"></i> Kedua Grafik
                                </button>
                            </div>
                        </div>
                        
                        <!-- Export Preview -->
                        <div class="mt-4">
                            <label class="block text-xs font-medium text-gray-700 mb-2">
                                <i class="fas fa-eye mr-1"></i> Pratinjau Data Terpilih
                            </label>
                            <div class="bg-gray-50 p-3 rounded-lg max-h-40 overflow-y-auto">
                                <pre id="export-preview" class="text-xs text-gray-600">Belum ada data simulasi. Jalankan simulasi terlebih dahulu.</pre>
                            </div>
                            <div class="mt-2 text-xs text-gray-500">
                                <i class="fas fa-info-circle mr-1"></i> Data akan diekspor sesuai pilihan di atas
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Information Panel -->
            <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl">
                <h3 class="section-header text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-info-circle text-blue-500 mr-2 text-xs"></i> Informasi Gaya Lorentz
                </h3>
                
                <div class="space-y-3">
                    <div class="text-xs text-gray-700">
                        <p class="mb-2"><span class="font-bold">Rumus Gaya Lorentz:</span></p>
                        <div class="bg-white p-2 rounded-lg mb-2">
                            <p class="mb-1">F = q(v × B) = q v B sin(θ)</p>
                            <p class="mb-1">F = gaya Lorentz (N)</p>
                            <p class="mb-1">q = muatan partikel (C)</p>
                            <p class="mb-1">v = kecepatan, B = medan magnet</p>
                            <p>θ = sudut antara v dan B</p>
                        </div>
                        
                        <p class="mb-2"><span class="font-bold">Karakteristik Gaya Lorentz:</span></p>
                        <ul class="list-disc pl-4 space-y-1">
                            <li>Gaya selalu tegak lurus terhadap v dan B</li>
                            <li>Tidak mengubah energi kinetik partikel</li>
                            <li>Menyebabkan gerak melingkar jika v⊥B</li>
                            <li>Arah gaya mengikuti kaidah tangan kanan</li>
                        </ul>
                        
                        <p class="mb-2 mt-3"><span class="font-bold">Simulasi 5 Detik:</span></p>
                        <ul class="list-disc pl-4 space-y-1">
                            <li>Simulasi otomatis berhenti setelah 5 detik</li>
                            <li>Data direkam setiap 0.1 detik (total 50 data)</li>
                            <li>Dapat mengekspor data per titik atau rentang</li>
                            <li>Visualisasi gaya Lorentz yang realistis</li>
                        </ul>
                    </div>
                    
                    <!-- Quick Tips -->
                    <div class="mt-4 pt-3 border-t border-blue-100">
                        <p class="text-xs font-medium text-gray-700 mb-2">Tips Simulasi:</p>
                        <div class="text-xs text-gray-600 space-y-1">
                            <div class="flex items-start">
                                <i class="fas fa-lightbulb text-yellow-500 mt-0.5 mr-2"></i>
                                <span>Sudut 90° menghasilkan gaya Lorentz maksimum</span>
                            </div>
                            <div class="flex items-start">
                                <i class="fas fa-lightbulb text-yellow-500 mt-0.5 mr-2"></i>
                                <span>Muatan positif: gaya sesuai kaidah tangan kanan</span>
                            </div>
                            <div class="flex items-start">
                                <i class="fas fa-lightbulb text-yellow-500 mt-0.5 mr-2"></i>
                                <span>Muatan negatif: arah gaya berlawanan</span>
                            </div>
                            <div class="flex items-start">
                                <i class="fas fa-lightbulb text-yellow-500 mt-0.5 mr-2"></i>
                                <span>Ekspor data per titik dengan klik tombol ekspor di tabel</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
          <a href="../../dashboard siswa.html" class="nav-item">
            <i class="fas fa-home nav-icon"></i>
            <span>Beranda</span>
          </a>
          <a href="../../soal harian/dashboard soal.html" class="nav-item">
            <i class="fas fa-flask nav-icon"></i>
            <span>Soal Harian</span>
          </a>
          <a href="../../ai/nayra.html" class="nav-item">
            <i class="fas fa-robot nav-icon"></i>
            <span>Nayra AI</span>
          </a>
          <a href="../../materi harian/kategori materi.html" class="nav-item">
            <i class="fas fa-chalkboard-teacher nav-icon"></i>
            <span>Materi Harian</span>
          </a>
          <a href="../../profil/profil.html" class="nav-item">
            <i class="fas fa-user nav-icon"></i>
            <span>Profil</span>
          </a>
        </nav>
    </div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // DOM Elements
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const errorTitle = document.getElementById('error-title');
        const errorDetail = document.getElementById('error-detail');
        
        // Tab Elements
        const tabSimulasi = document.getElementById('tab-simulasi');
        const tabData = document.getElementById('tab-data');
        const tabEkspor = document.getElementById('tab-ekspor');
        const simulasiContent = document.getElementById('simulasi-content');
        const dataContent = document.getElementById('data-content');
        const eksporContent = document.getElementById('ekspor-content');
        
        // Canvas Elements
        const fieldCanvas = document.getElementById('magnetic-field');
        const particlesCanvas = document.getElementById('particles');
        const forceArrowsCanvas = document.getElementById('force-arrows');
        let fieldCtx, particlesCtx, forceArrowsCtx;
        
        // Control Elements
        const strengthSlider = document.getElementById('strength-slider');
        const chargeSlider = document.getElementById('charge-slider');
        const velocitySlider = document.getElementById('velocity-slider');
        const angleSlider = document.getElementById('angle-slider');
        
        const strengthValue = document.getElementById('strength-value');
        const chargeValue = document.getElementById('charge-value');
        const velocityValue = document.getElementById('velocity-value');
        const angleValue = document.getElementById('angle-value');
        
        const btnStartSimulation = document.getElementById('btn-start-simulation');
        const btnResetSimulation = document.getElementById('btn-reset-simulation');
        const btnPauseSimulation = document.getElementById('btn-pause-simulation');
        
        // Display Elements
        const simulationTime = document.getElementById('simulation-time');
        const simulationTimer = document.getElementById('simulation-timer');
        const currentForce = document.getElementById('current-force');
        const currentEnergy = document.getElementById('current-energy');
        const currentMomentum = document.getElementById('current-momentum');
        const currentRadius = document.getElementById('current-radius');
        
        // Info Elements
        const infoLorentzActive = document.getElementById('info-lorentz-active');
        const infoMagneticField = document.getElementById('info-magnetic-field');
        const infoAngle = document.getElementById('info-angle');
        const infoForceDirection = document.getElementById('info-force-direction');
        
        // Empty State Elements
        const forceEmptyState = document.getElementById('force-empty-state');
        const energyEmptyState = document.getElementById('energy-empty-state');
        
        // Data Elements
        const magneticTableBody = document.getElementById('magnetic-table-body');
        const selectAllCheckbox = document.getElementById('select-all');
        const btnClearData = document.getElementById('btn-clear-data');
        const btnExportSelected = document.getElementById('btn-export-selected');
        const dataCount = document.getElementById('data-count');
        const dataInterval = document.getElementById('data-interval');
        const dataRemaining = document.getElementById('data-remaining');
        const dataStatus = document.getElementById('data-status');
        
        // Export Elements
        const exportFormat = document.getElementById('export-format');
        const exportPrecision = document.getElementById('export-precision');
        const exportStart = document.getElementById('export-start');
        const exportEnd = document.getElementById('export-end');
        const exportSpecificTime = document.getElementById('export-specific-time');
        const exportPreview = document.getElementById('export-preview');
        
        const btnExportSpecific = document.getElementById('btn-export-specific');
        const btnExportFirst = document.getElementById('btn-export-first');
        const btnExportLast = document.getElementById('btn-export-last');
        const btnExportMax = document.getElementById('btn-export-max');
        const btnExportMin = document.getElementById('btn-export-min');
        const btnExportRange = document.getElementById('btn-export-range');
        const btnExportAll = document.getElementById('btn-export-all');
        const btnExportChartForce = document.getElementById('btn-export-chart-force');
        const btnExportChartEnergy = document.getElementById('btn-export-chart-energy');
        const btnExportChartBoth = document.getElementById('btn-export-chart-both');
        
        // Magnet Elements
        const magnetNorth = document.getElementById('magnet-north');
        const magnetSouth = document.getElementById('magnet-south');
        
        // Chart Elements
        const forceChartCanvas = document.getElementById('force-chart');
        const energyChartCanvas = document.getElementById('energy-chart');
        
        // Variables
        let forceChart = null;
        let energyChart = null;
        
        let simulationRunning = false;
        let simulationPaused = false;
        let simulationTimeValue = 0;
        let simulationInterval = null;
        let animationFrame = null;
        let simulationData = [];
        
        // Simulation Parameters
        let params = {
            B: 2.0,           // Magnetic field strength (Tesla)
            q: 1.0,          // Charge (Coulomb)
            v: 10,           // Velocity (m/s)
            angle: 90,       // Angle between v and B (degrees)
            dt: 0.1,         // Time step (s)
            maxTime: 5.0     // Maximum simulation time (5 seconds)
        };
        
        // Canvas dimensions
        let canvasWidth = 0;
        let canvasHeight = 0;
        
        // Particle (for visualization)
        let particle = null;
        
        // Initialize
        function init() {
            try {
                // Get canvas contexts
                fieldCtx = fieldCanvas.getContext('2d');
                particlesCtx = particlesCanvas.getContext('2d');
                forceArrowsCtx = forceArrowsCanvas.getContext('2d');
                
                // Set canvas dimensions
                updateCanvasSize();
                window.addEventListener('resize', updateCanvasSize);
                
                // Initialize charts (empty)
                initForceChart();
                initEnergyChart();
                
                // Hide charts initially, show empty states
                forceChartCanvas.style.display = 'none';
                energyChartCanvas.style.display = 'none';
                
                // Set up control listeners
                setupControls();
                
                // Draw initial magnetic field
                drawMagneticField();
                
                // Initialize particle
                initParticle();
                
                // Hide loading
                setTimeout(() => {
                    loading.classList.add('hidden');
                }, 1000);
                
            } catch (err) {
                console.error('Error initializing simulation:', err);
                showError('Inisialisasi Gagal', 'Gagal memuat komponen simulasi');
            }
        }
        
        // Update canvas size
        function updateCanvasSize() {
            const container = document.querySelector('.field-container');
            canvasWidth = container.clientWidth;
            canvasHeight = container.clientHeight;
            
            fieldCanvas.width = canvasWidth;
            fieldCanvas.height = canvasHeight;
            particlesCanvas.width = canvasWidth;
            particlesCanvas.height = canvasHeight;
            forceArrowsCanvas.width = canvasWidth;
            forceArrowsCanvas.height = canvasHeight;
            
            // Redraw
            if (!simulationRunning) {
                drawMagneticField();
                drawParticle();
            }
        }
        
        // Initialize particle
        function initParticle() {
            const centerX = canvasWidth / 2;
            const centerY = canvasHeight / 2;
            
            particle = {
                x: centerX,
                y: centerY,
                radius: 8,
                color: params.q >= 0 ? '#ef4444' : '#3b82f6',
                charge: params.q,
                velocity: {
                    magnitude: params.v,
                    angle: params.angle * Math.PI / 180,
                    x: params.v * Math.cos(params.angle * Math.PI / 180),
                    y: params.v * Math.sin(params.angle * Math.PI / 180)
                },
                force: {
                    magnitude: 0,
                    angle: 0
                },
                trail: [],
                maxTrail: 15
            };
            
            // Update info display
            updateInfoDisplay();
        }
        
        // Initialize force chart (empty)
        function initForceChart() {
            const ctx = forceChartCanvas.getContext('2d');
            
            forceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Gaya Lorentz (N)',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 11,
                                    family: "'Baloo 2', cursive"
                                }
                            }
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `Gaya: ${context.parsed.y.toFixed(3)} N`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Waktu (s)',
                                font: {
                                    size: 11,
                                    family: "'Baloo 2', cursive"
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            min: 0,
                            max: 5,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Gaya Lorentz (N)',
                                font: {
                                    size: 11,
                                    family: "'Baloo 2', cursive"
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            beginAtZero: true,
                            suggestedMax: 10
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
        
        // Initialize energy chart (empty)
        function initEnergyChart() {
            const ctx = energyChartCanvas.getContext('2d');
            
            energyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Energi Kinetik (J)',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 11,
                                    family: "'Baloo 2', cursive"
                                }
                            }
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `Energi: ${context.parsed.y.toFixed(3)} J`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Waktu (s)',
                                font: {
                                    size: 11,
                                    family: "'Baloo 2', cursive"
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            min: 0,
                            max: 5,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Energi (J)',
                                font: {
                                    size: 11,
                                    family: "'Baloo 2', cursive"
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            beginAtZero: true,
                            suggestedMax: 50
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
        
        // Draw magnetic field lines
        function drawMagneticField() {
            fieldCtx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            const centerX = canvasWidth / 2;
            const centerY = canvasHeight / 2;
            
            // Draw background gradient
            const gradient = fieldCtx.createLinearGradient(0, 0, canvasWidth, canvasHeight);
            gradient.addColorStop(0, '#1a202c');
            gradient.addColorStop(1, '#2d3748');
            fieldCtx.fillStyle = gradient;
            fieldCtx.fillRect(0, 0, canvasWidth, canvasHeight);
            
            // Draw magnetic field lines (uniform horizontal field)
            fieldCtx.strokeStyle = '#60a5fa';
            fieldCtx.lineWidth = 2;
            fieldCtx.globalAlpha = 0.7;
            
            const numLines = 10;
            const spacing = canvasHeight / (numLines + 1);
            
            for (let i = 1; i <= numLines; i++) {
                const y = spacing * i;
                
                fieldCtx.beginPath();
                fieldCtx.moveTo(50, y);
                fieldCtx.lineTo(canvasWidth - 50, y);
                fieldCtx.stroke();
                
                // Add arrowheads (to the right)
                drawArrowhead(fieldCtx, canvasWidth - 60, y, 0);
            }
            
            fieldCtx.globalAlpha = 1.0;
            
            // Draw magnetic field direction label
            fieldCtx.fillStyle = '#60a5fa';
            fieldCtx.font = 'bold 14px Arial';
            fieldCtx.textAlign = 'center';
            fieldCtx.fillText('B', canvasWidth - 30, canvasHeight / 2);
            fieldCtx.fillText('→', canvasWidth - 15, canvasHeight / 2);
            
            // Draw velocity direction label if particle exists
            if (particle) {
                const angleRad = params.angle * Math.PI / 180;
                const vx = Math.cos(angleRad);
                const vy = Math.sin(angleRad);
                
                fieldCtx.fillStyle = '#ef4444';
                fieldCtx.fillText('v', centerX + 30, centerY - 30);
                fieldCtx.beginPath();
                fieldCtx.moveTo(centerX + 40, centerY - 30);
                fieldCtx.lineTo(centerX + 40 + vx * 20, centerY - 30 + vy * 20);
                fieldCtx.strokeStyle = '#ef4444';
                fieldCtx.lineWidth = 2;
                fieldCtx.stroke();
                
                // Draw angle arc
                fieldCtx.beginPath();
                fieldCtx.arc(centerX, centerY, 25, 0, angleRad, false);
                fieldCtx.strokeStyle = '#f59e0b';
                fieldCtx.lineWidth = 2;
                fieldCtx.stroke();
                
                // Draw angle label
                fieldCtx.fillStyle = '#f59e0b';
                fieldCtx.font = 'bold 12px Arial';
                fieldCtx.fillText(`θ = ${params.angle}°`, centerX + 15, centerY - 10);
            }
        }
        
        function drawArrowhead(ctx, x, y, angle) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle);
            
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(-10, -5);
            ctx.lineTo(-10, 5);
            ctx.closePath();
            ctx.fillStyle = '#60a5fa';
            ctx.fill();
            
            ctx.restore();
        }
        
        // Draw particle
        function drawParticle() {
            particlesCtx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            if (!particle) return;
            
            // Draw trail
            if (particle.trail.length > 1) {
                particlesCtx.beginPath();
                particlesCtx.moveTo(particle.trail[0].x, particle.trail[0].y);
                
                for (let i = 1; i < particle.trail.length; i++) {
                    particlesCtx.lineTo(particle.trail[i].x, particle.trail[i].y);
                }
                
                particlesCtx.strokeStyle = particle.color;
                particlesCtx.lineWidth = 2;
                particlesCtx.globalAlpha = 0.3;
                particlesCtx.stroke();
                particlesCtx.globalAlpha = 1.0;
            }
            
            // Draw particle
            particlesCtx.beginPath();
            particlesCtx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
            particlesCtx.fillStyle = particle.color;
            particlesCtx.fill();
            
            // Add glow effect
            const gradient = particlesCtx.createRadialGradient(
                particle.x, particle.y, 0,
                particle.x, particle.y, particle.radius * 2
            );
            gradient.addColorStop(0, particle.color);
            gradient.addColorStop(1, 'transparent');
            
            particlesCtx.globalAlpha = 0.3;
            particlesCtx.fillStyle = gradient;
            particlesCtx.beginPath();
            particlesCtx.arc(particle.x, particle.y, particle.radius * 2, 0, Math.PI * 2);
            particlesCtx.fill();
            particlesCtx.globalAlpha = 1.0;
            
            // Draw charge sign
            particlesCtx.fillStyle = 'white';
            particlesCtx.font = 'bold 12px Arial';
            particlesCtx.textAlign = 'center';
            particlesCtx.textBaseline = 'middle';
            particlesCtx.fillText(particle.charge >= 0 ? '+' : '-', particle.x, particle.y);
            
            // Draw velocity vector
            const scale = 5;
            particlesCtx.beginPath();
            particlesCtx.moveTo(particle.x, particle.y);
            particlesCtx.lineTo(
                particle.x + particle.velocity.x * scale,
                particle.y + particle.velocity.y * scale
            );
            particlesCtx.strokeStyle = '#ef4444';
            particlesCtx.lineWidth = 2;
            particlesCtx.stroke();
            
            // Draw velocity arrowhead
            drawArrowhead(particlesCtx, 
                particle.x + particle.velocity.x * scale,
                particle.y + particle.velocity.y * scale,
                Math.atan2(particle.velocity.y, particle.velocity.x)
            );
        }
        
        // Draw Lorentz force arrows
        function drawForceArrows() {
            forceArrowsCtx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            if (!particle || particle.force.magnitude === 0) return;
            
            // Calculate force vector (perpendicular to velocity)
            const forceAngle = Math.atan2(particle.velocity.y, particle.velocity.x) + Math.PI / 2;
            
            // Adjust direction based on charge
            const direction = particle.charge >= 0 ? 1 : -1;
            const finalForceAngle = forceAngle * direction;
            
            // Draw force vector
            const forceScale = particle.force.magnitude * 2; // Scale for visualization
            
            forceArrowsCtx.beginPath();
            forceArrowsCtx.moveTo(particle.x, particle.y);
            forceArrowsCtx.lineTo(
                particle.x + Math.cos(finalForceAngle) * forceScale,
                particle.y + Math.sin(finalForceAngle) * forceScale
            );
            forceArrowsCtx.strokeStyle = '#f59e0b';
            forceArrowsCtx.lineWidth = 3;
            forceArrowsCtx.stroke();
            
            // Draw force arrowhead
            drawArrowhead(forceArrowsCtx,
                particle.x + Math.cos(finalForceAngle) * forceScale,
                particle.y + Math.sin(finalForceAngle) * forceScale,
                finalForceAngle
            );
            
            // Label the force
            forceArrowsCtx.fillStyle = '#f59e0b';
            forceArrowsCtx.font = 'bold 12px Arial';
            forceArrowsCtx.textAlign = 'center';
            forceArrowsCtx.fillText(
                `F = ${particle.force.magnitude.toFixed(2)} N`,
                particle.x + Math.cos(finalForceAngle) * (forceScale + 15),
                particle.y + Math.sin(finalForceAngle) * (forceScale + 15)
            );
            
            // Draw right-hand rule visualization for positive charge
            if (particle.charge >= 0) {
                drawRightHandRule(particle.x, particle.y);
            }
        }
        
        // Draw right-hand rule visualization
        function drawRightHandRule(x, y) {
            forceArrowsCtx.save();
            forceArrowsCtx.translate(x + 60, y - 60);
            
            // Draw hand symbol
            forceArrowsCtx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            forceArrowsCtx.beginPath();
            forceArrowsCtx.arc(0, 0, 15, 0, Math.PI * 2);
            forceArrowsCtx.fill();
            
            // Draw fingers
            forceArrowsCtx.strokeStyle = '#ffffff';
            forceArrowsCtx.lineWidth = 2;
            
            // Index finger (B)
            forceArrowsCtx.beginPath();
            forceArrowsCtx.moveTo(0, 0);
            forceArrowsCtx.lineTo(20, 0);
            forceArrowsCtx.stroke();
            forceArrowsCtx.fillStyle = '#60a5fa';
            forceArrowsCtx.fillText('B', 25, 0);
            
            // Middle finger (v)
            forceArrowsCtx.beginPath();
            forceArrowsCtx.moveTo(0, 0);
            forceArrowsCtx.lineTo(0, -20);
            forceArrowsCtx.stroke();
            forceArrowsCtx.fillStyle = '#ef4444';
            forceArrowsCtx.fillText('v', 0, -25);
            
            // Thumb (F)
            forceArrowsCtx.beginPath();
            forceArrowsCtx.moveTo(0, 0);
            forceArrowsCtx.lineTo(15, 15);
            forceArrowsCtx.stroke();
            forceArrowsCtx.fillStyle = '#f59e0b';
            forceArrowsCtx.fillText('F', 20, 20);
            
            forceArrowsCtx.restore();
        }
        
        // Set up control listeners
        function setupControls() {
            // Update parameter values
            strengthSlider.addEventListener('input', (e) => {
                params.B = parseFloat(e.target.value);
                strengthValue.textContent = `${params.B.toFixed(1)} Tesla`;
                if (!simulationRunning) {
                    updateInfoDisplay();
                    drawMagneticField();
                    drawParticle();
                }
            });
            
            chargeSlider.addEventListener('input', (e) => {
                params.q = parseFloat(e.target.value);
                const sign = params.q >= 0 ? '+' : '';
                chargeValue.textContent = `${sign}${params.q.toFixed(1)} C`;
                if (particle) {
                    particle.charge = params.q;
                    particle.color = params.q >= 0 ? '#ef4444' : '#3b82f6';
                }
                if (!simulationRunning) {
                    updateInfoDisplay();
                    drawParticle();
                }
            });
            
            velocitySlider.addEventListener('input', (e) => {
                params.v = parseFloat(e.target.value);
                velocityValue.textContent = `${params.v} m/s`;
                if (particle) {
                    particle.velocity.magnitude = params.v;
                    particle.velocity.x = params.v * Math.cos(params.angle * Math.PI / 180);
                    particle.velocity.y = params.v * Math.sin(params.angle * Math.PI / 180);
                }
                if (!simulationRunning) {
                    updateInfoDisplay();
                    drawParticle();
                }
            });
            
            angleSlider.addEventListener('input', (e) => {
                params.angle = parseFloat(e.target.value);
                angleValue.textContent = `${params.angle}°`;
                if (particle) {
                    particle.velocity.angle = params.angle * Math.PI / 180;
                    particle.velocity.x = params.v * Math.cos(params.angle * Math.PI / 180);
                    particle.velocity.y = params.v * Math.sin(params.angle * Math.PI / 180);
                }
                if (!simulationRunning) {
                    updateInfoDisplay();
                    drawMagneticField();
                    drawParticle();
                }
            });
            
            // Simulation controls
            btnStartSimulation.addEventListener('click', startSimulation);
            btnResetSimulation.addEventListener('click', resetSimulation);
            btnPauseSimulation.addEventListener('click', togglePauseSimulation);
            
            // Tab navigation
            tabSimulasi.addEventListener('click', () => switchTab('simulasi'));
            tabData.addEventListener('click', () => switchTab('data'));
            tabEkspor.addEventListener('click', () => switchTab('ekspor'));
            
            // Data controls
            btnClearData.addEventListener('click', clearData);
            btnExportSelected.addEventListener('click', exportSelectedData);
            selectAllCheckbox.addEventListener('change', toggleSelectAll);
            
            // Export controls
            btnExportSpecific.addEventListener('click', () => exportSpecificData());
            btnExportFirst.addEventListener('click', () => exportFirstData());
            btnExportLast.addEventListener('click', () => exportLastData());
            btnExportMax.addEventListener('click', () => exportMaxData());
            btnExportMin.addEventListener('click', () => exportMinData());
            btnExportRange.addEventListener('click', exportRangeData);
            btnExportAll.addEventListener('click', exportAllData);
            btnExportChartForce.addEventListener('click', () => exportChart('force'));
            btnExportChartEnergy.addEventListener('click', () => exportChart('energy'));
            btnExportChartBoth.addEventListener('click', () => exportChart('both'));
            
            exportFormat.addEventListener('change', updateExportPreview);
            exportPrecision.addEventListener('change', updateExportPreview);
            exportStart.addEventListener('change', updateExportPreview);
            exportEnd.addEventListener('change', updateExportPreview);
            exportSpecificTime.addEventListener('change', updateExportPreview);
        }
        
        // Calculate Lorentz force
        function calculateLorentzForce() {
            // F = q * v * B * sin(theta)
            const angleRad = params.angle * Math.PI / 180;
            const forceMagnitude = Math.abs(params.q) * params.v * params.B * Math.sin(angleRad);
            
            // Calculate radius of circular motion (if v perpendicular to B)
            const radius = (params.v * Math.sin(angleRad)) / (Math.abs(params.q) * params.B);
            
            // Calculate kinetic energy
            const mass = 9.1e-31; // Electron mass (kg)
            const energy = 0.5 * mass * params.v * params.v;
            
            // Calculate momentum
            const momentum = mass * params.v;
            
            return {
                force: forceMagnitude,
                radius: radius,
                energy: energy,
                momentum: momentum,
                direction: params.q >= 0 ? 'Kaidah Tangan Kanan' : 'Berlawanan'
            };
        }
        
        // Update info display
        function updateInfoDisplay() {
            const results = calculateLorentzForce();
            
            infoLorentzActive.textContent = `${results.force.toFixed(2)} N`;
            infoMagneticField.textContent = `${params.B.toFixed(2)} T`;
            infoAngle.textContent = `${params.angle}°`;
            infoForceDirection.textContent = results.direction;
            
            // Update current values
            currentForce.textContent = `${results.force.toFixed(2)} N`;
            currentEnergy.textContent = `${results.energy.toExponential(2)} J`;
            currentMomentum.textContent = `${results.momentum.toExponential(2)} kg·m/s`;
            currentRadius.textContent = `${results.radius.toExponential(2)} m`;
            
            // Update particle force
            if (particle) {
                particle.force.magnitude = results.force;
            }
        }
        
        // Start simulation (5 seconds only)
        function startSimulation() {
            if (simulationRunning) return;
            
            simulationRunning = true;
            simulationPaused = false;
            simulationTimeValue = 0;
            simulationData = [];
            
            // Reset particle position
            initParticle();
            
            btnStartSimulation.disabled = true;
            btnStartSimulation.innerHTML = '<i class="fas fa-sync-alt spin"></i> Simulasi Berjalan';
            btnPauseSimulation.innerHTML = '<i class="fas fa-pause"></i> Jeda';
            
            dataStatus.textContent = 'Merekam';
            dataStatus.className = 'text-lg font-bold text-yellow-600';
            
            // Hide empty states and show charts
            forceEmptyState.style.display = 'none';
            energyEmptyState.style.display = 'none';
            
            forceChartCanvas.style.display = 'block';
            energyChartCanvas.style.display = 'block';
            
            // Clear previous data from charts
            clearCharts();
            
            // Start simulation loop
            simulationInterval = setInterval(updateSimulation, 100); // Update every 100ms
            animationFrame = requestAnimationFrame(animate);
            
            showError('Simulasi Dimulai', 'Simulasi akan berjalan selama 5 detik');
        }
        
        // Reset simulation
        function resetSimulation() {
            stopSimulation();
            simulationTimeValue = 0;
            simulationData = [];
            
            updateDisplay();
            clearCharts();
            updateDataTable();
            
            // Show empty states again
            forceEmptyState.style.display = 'flex';
            energyEmptyState.style.display = 'flex';
            
            forceChartCanvas.style.display = 'none';
            energyChartCanvas.style.display = 'none';
            
            simulationTime.textContent = '0.0';
            simulationTimer.textContent = '5.0';
            currentForce.textContent = '0.00 N';
            currentEnergy.textContent = '0.00 J';
            currentMomentum.textContent = '0.00 kg·m/s';
            currentRadius.textContent = '0.00 m';
            
            dataRemaining.textContent = '5.0 s';
            dataStatus.textContent = 'Siap';
            dataStatus.className = 'text-lg font-bold text-green-600';
            
            // Reset particle
            initParticle();
            drawMagneticField();
            drawParticle();
            forceArrowsCtx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            showError('Simulasi Direset', 'Semua data telah direset');
        }
        
        // Toggle pause simulation
        function togglePauseSimulation() {
            if (!simulationRunning) return;
            
            simulationPaused = !simulationPaused;
            
            if (simulationPaused) {
                btnPauseSimulation.innerHTML = '<i class="fas fa-play"></i> Lanjutkan';
                dataStatus.textContent = 'Dijeda';
                dataStatus.className = 'text-lg font-bold text-red-600';
                cancelAnimationFrame(animationFrame);
                showError('Simulasi Dijeda', 'Simulasi dijeda sementara');
            } else {
                btnPauseSimulation.innerHTML = '<i class="fas fa-pause"></i> Jeda';
                dataStatus.textContent = 'Merekam';
                dataStatus.className = 'text-lg font-bold text-yellow-600';
                animationFrame = requestAnimationFrame(animate);
                showError('Simulasi Dilanjutkan', 'Simulasi dilanjutkan');
            }
        }
        
        // Stop simulation
        function stopSimulation() {
            simulationRunning = false;
            simulationPaused = false;
            
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }
            
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
            
            btnStartSimulation.disabled = false;
            btnStartSimulation.innerHTML = '<i class="fas fa-play"></i> Mulai (5s)';
        }
        
        // Update simulation
        function updateSimulation() {
            if (!simulationRunning || simulationPaused) return;
            
            // Calculate forces and update particle
            updateParticle();
            
            // Calculate remaining time
            const remainingTime = params.maxTime - simulationTimeValue;
            
            // Update displays
            simulationTime.textContent = simulationTimeValue.toFixed(1);
            simulationTimer.textContent = remainingTime.toFixed(1);
            dataRemaining.textContent = `${remainingTime.toFixed(1)} s`;
            
            // Calculate current values
            const results = calculateLorentzForce();
            
            // Record data
            const dataPoint = {
                time: simulationTimeValue,
                force: results.force,
                energy: results.energy,
                momentum: results.momentum,
                radius: results.radius,
                angle: params.angle,
                velocity: params.v,
                charge: params.q,
                magneticField: params.B,
                selected: false
            };
            
            simulationData.push(dataPoint);
            updateCharts(dataPoint);
            updateDataTable();
            
            // Increment time
            simulationTimeValue += params.dt;
            
            // Stop simulation after 5 seconds
            if (simulationTimeValue >= params.maxTime) {
                stopSimulation();
                dataStatus.textContent = 'Selesai';
                dataStatus.className = 'text-lg font-bold text-green-600';
                showError('Simulasi Selesai', 'Simulasi telah berjalan selama 5 detik');
            }
        }
        
        // Update particle position and velocity
        function updateParticle() {
            if (!particle) return;
            
            const centerX = canvasWidth / 2;
            const centerY = canvasHeight / 2;
            
            // For visualization, move particle in a circle if force is significant
            if (params.angle === 90) {
                // Circular motion
                const radius = 50;
                const angularSpeed = params.v / radius;
                const angle = angularSpeed * simulationTimeValue;
                
                particle.x = centerX + radius * Math.cos(angle);
                particle.y = centerY + radius * Math.sin(angle);
                
                // Update velocity vector (tangential to circle)
                particle.velocity.x = -params.v * Math.sin(angle);
                particle.velocity.y = params.v * Math.cos(angle);
            } else {
                // Linear motion with some deflection
                const deflection = params.angle * Math.PI / 180;
                particle.x = centerX + params.v * simulationTimeValue * Math.cos(deflection);
                particle.y = centerY + params.v * simulationTimeValue * Math.sin(deflection);
            }
            
            // Add to trail
            particle.trail.push({ x: particle.x, y: particle.y });
            if (particle.trail.length > particle.maxTrail) {
                particle.trail.shift();
            }
            
            // Keep particle within bounds
            if (particle.x < 0 || particle.x > canvasWidth || 
                particle.y < 0 || particle.y > canvasHeight) {
                // Reset to center if out of bounds
                particle.x = centerX;
                particle.y = centerY;
                particle.trail = [];
            }
        }
        
        // Animation loop
        function animate() {
            if (!simulationRunning || simulationPaused) return;
            
            // Draw everything
            drawMagneticField();
            drawParticle();
            drawForceArrows();
            
            animationFrame = requestAnimationFrame(animate);
        }
        
        // Update charts
        function updateCharts(dataPoint) {
            // Update force chart
            if (forceChart) {
                forceChart.data.labels.push(dataPoint.time.toFixed(1));
                forceChart.data.datasets[0].data.push(dataPoint.force);
                
                // Keep only data within 5 seconds
                if (forceChart.data.labels.length > 50) { // 5 seconds / 0.1 = 50
                    forceChart.data.labels.shift();
                    forceChart.data.datasets[0].data.shift();
                }
                
                // Update y-axis max if needed
                const maxForce = Math.max(...forceChart.data.datasets[0].data);
                forceChart.options.scales.y.suggestedMax = Math.max(10, maxForce * 1.2);
                
                forceChart.update('none');
            }
            
            // Update energy chart
            if (energyChart) {
                if (energyChart.data.labels.length === 0) {
                    energyChart.data.labels = [...forceChart.data.labels];
                } else {
                    energyChart.data.labels.push(dataPoint.time.toFixed(1));
                }
                
                energyChart.data.datasets[0].data.push(dataPoint.energy);
                
                // Keep only data within 5 seconds
                if (energyChart.data.labels.length > 50) {
                    energyChart.data.labels.shift();
                    energyChart.data.datasets[0].data.shift();
                }
                
                // Update y-axis max if needed
                const maxEnergy = Math.max(...energyChart.data.datasets[0].data);
                energyChart.options.scales.y.suggestedMax = Math.max(50, maxEnergy * 1.2);
                
                energyChart.update('none');
            }
        }
        
        // Clear charts
        function clearCharts() {
            if (forceChart) {
                forceChart.data.labels = [];
                forceChart.data.datasets[0].data = [];
                forceChart.options.scales.y.suggestedMax = 10;
                forceChart.update();
            }
            
            if (energyChart) {
                energyChart.data.labels = [];
                energyChart.data.datasets[0].data = [];
                energyChart.options.scales.y.suggestedMax = 50;
                energyChart.update();
            }
        }
        
        // Update data table
        function updateDataTable() {
            magneticTableBody.innerHTML = '';
            
            if (simulationData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="5" class="text-center py-6 text-gray-500">
                        <i class="fas fa-database text-2xl mb-2 block text-gray-300"></i>
                        <p class="text-sm">Belum ada data simulasi</p>
                        <p class="text-xs mt-1">Klik "Mulai Simulasi" untuk memulai</p>
                    </td>
                `;
                magneticTableBody.appendChild(row);
                return;
            }
            
            // Show last 15 data points
            const startIndex = Math.max(0, simulationData.length - 15);
            
            for (let i = startIndex; i < simulationData.length; i++) {
                const data = simulationData[i];
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="data-checkbox" data-index="${i}" ${data.selected ? 'checked' : ''}>
                    </td>
                    <td>${data.time.toFixed(2)}</td>
                    <td>${data.force.toFixed(4)}</td>
                    <td>${data.energy.toExponential(2)}</td>
                    <td>
                        <button class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 export-single" data-index="${i}">
                            <i class="fas fa-download mr-1"></i> Ekspor
                        </button>
                    </td>
                `;
                
                magneticTableBody.appendChild(row);
            }
            
            // Add event listeners to checkboxes and export buttons
            document.querySelectorAll('.data-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    simulationData[index].selected = this.checked;
                    updateSelectAllCheckbox();
                });
            });
            
            document.querySelectorAll('.export-single').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    exportSingleData(index);
                });
            });
            
            // Update data count
            dataCount.textContent = simulationData.length;
            dataInterval.textContent = `${params.dt} s`;
            
            // Update select all checkbox
            updateSelectAllCheckbox();
        }
        
        // Toggle select all
        function toggleSelectAll() {
            const checked = selectAllCheckbox.checked;
            simulationData.forEach(data => {
                data.selected = checked;
            });
            updateDataTable();
        }
        
        // Update select all checkbox
        function updateSelectAllCheckbox() {
            const allSelected = simulationData.length > 0 && 
                simulationData.every(data => data.selected);
            const someSelected = simulationData.some(data => data.selected);
            
            selectAllCheckbox.checked = allSelected;
            selectAllCheckbox.indeterminate = someSelected && !allSelected;
        }
        
        // Clear data
        function clearData() {
            if (simulationData.length > 0 && confirm('Hapus semua data simulasi?')) {
                simulationData = [];
                updateDataTable();
                showError('Data Dihapus', 'Semua data simulasi telah dihapus');
            }
        }
        
        // Export single data point
        function exportSingleData(index) {
            if (index < 0 || index >= simulationData.length) return;
            
            const data = simulationData[index];
            const precision = parseInt(exportPrecision.value);
            
            const content = `Data Simulasi Gaya Lorentz - Waktu: ${data.time.toFixed(2)}s\n` +
                           `==========================================\n` +
                           `Waktu: ${data.time.toFixed(precision)} s\n` +
                           `Gaya Lorentz: ${data.force.toFixed(precision)} N\n` +
                           `Energi Kinetik: ${data.energy.toExponential(precision)} J\n` +
                           `Momentum: ${data.momentum.toExponential(precision)} kg·m/s\n` +
                           `Jari-jari Lintasan: ${data.radius.toExponential(precision)} m\n` +
                           `Sudut (θ): ${data.angle.toFixed(precision)}°\n` +
                           `Kecepatan: ${data.velocity.toFixed(precision)} m/s\n` +
                           `Muatan: ${data.charge.toFixed(precision)} C\n` +
                           `Medan Magnet: ${data.magneticField.toFixed(precision)} T\n` +
                           `==========================================\n` +
                           `Rumus: F = q·v·B·sin(θ) = ${data.charge.toFixed(2)} × ${data.velocity.toFixed(2)} × ${data.magneticField.toFixed(2)} × sin(${data.angle.toFixed(2)}°) = ${data.force.toFixed(2)} N\n` +
                           `Diekspor pada: ${new Date().toLocaleString('id-ID')}`;
            
            downloadFile(content, `gaya-lorentz-${data.time.toFixed(2)}s.txt`);
            showError('Data Diekspor', `Data pada t=${data.time.toFixed(2)}s telah diunduh`);
        }
        
        // Export selected data
        function exportSelectedData() {
            const selectedData = simulationData.filter(data => data.selected);
            
            if (selectedData.length === 0) {
                showError('Tidak Ada Data', 'Pilih data terlebih dahulu dengan mencentang checkbox');
                return;
            }
            
            const precision = parseInt(exportPrecision.value);
            const format = exportFormat.value;
            
            let content = '';
            let filename = '';
            
            if (format === 'csv') {
                content = 'Waktu (s),Gaya Lorentz (N),Energi (J),Momentum (kg·m/s),Jari-jari (m),Sudut (°),Kecepatan (m/s),Muatan (C),Medan Magnet (T)\n';
                selectedData.forEach(data => {
                    content += `${data.time.toFixed(precision)},${data.force.toFixed(precision)},${data.energy.toExponential(precision)},${data.momentum.toExponential(precision)},${data.radius.toExponential(precision)},${data.angle.toFixed(precision)},${data.velocity.toFixed(precision)},${data.charge.toFixed(precision)},${data.magneticField.toFixed(precision)}\n`;
                });
                filename = `data-terpilih-${new Date().toISOString().slice(0, 10)}.csv`;
            } else if (format === 'json') {
                const exportData = selectedData.map(data => ({
                    waktu: data.time.toFixed(precision),
                    gaya_lorentz: data.force.toFixed(precision),
                    energi: data.energy.toExponential(precision),
                    momentum: data.momentum.toExponential(precision),
                    jari_jari: data.radius.toExponential(precision),
                    sudut: data.angle.toFixed(precision),
                    kecepatan: data.velocity.toFixed(precision),
                    muatan: data.charge.toFixed(precision),
                    medan_magnet: data.magneticField.toFixed(precision)
                }));
                content = JSON.stringify(exportData, null, 2);
                filename = `data-terpilih-${new Date().toISOString().slice(0, 10)}.json`;
            } else {
                content = `DATA SIMULASI GAYA LORENTZ (${selectedData.length} data terpilih)\n` +
                         `==========================================\n\n`;
                selectedData.forEach((data, index) => {
                    content += `Data ${index + 1} - t = ${data.time.toFixed(2)}s:\n` +
                              `  Gaya Lorentz: ${data.force.toFixed(precision)} N\n` +
                              `  Energi Kinetik: ${data.energy.toExponential(precision)} J\n` +
                              `  Momentum: ${data.momentum.toExponential(precision)} kg·m/s\n` +
                              `  Jari-jari Lintasan: ${data.radius.toExponential(precision)} m\n` +
                              `  Sudut (θ): ${data.angle.toFixed(precision)}°\n` +
                              `  Kecepatan: ${data.velocity.toFixed(precision)} m/s\n` +
                              `  Muatan: ${data.charge.toFixed(precision)} C\n` +
                              `  Medan Magnet: ${data.magneticField.toFixed(precision)} T\n\n`;
                });
                content += `==========================================\n` +
                          `Total Data: ${selectedData.length}\n` +
                          `Diekspor pada: ${new Date().toLocaleString('id-ID')}`;
                filename = `data-terpilih-${new Date().toISOString().slice(0, 10)}.txt`;
            }
            
            downloadFile(content, filename);
            showError('Data Diekspor', `${selectedData.length} data terpilih telah diunduh`);
        }
        
        // Export specific data by time
        function exportSpecificData() {
            const time = parseFloat(exportSpecificTime.value);
            
            if (isNaN(time) || time < 0 || time > 5) {
                showError('Waktu Tidak Valid', 'Masukkan waktu antara 0.0 - 5.0 detik');
                return;
            }
            
            // Find closest data point
            let closestData = null;
            let minDiff = Infinity;
            
            simulationData.forEach(data => {
                const diff = Math.abs(data.time - time);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestData = data;
                }
            });
            
            if (!closestData) {
                showError('Data Tidak Ditemukan', 'Tidak ada data pada waktu tersebut');
                return;
            }
            
            exportSingleData(simulationData.indexOf(closestData));
        }
        
        // Export first data point
        function exportFirstData() {
            if (simulationData.length === 0) {
                showError('Data Kosong', 'Tidak ada data untuk diekspor');
                return;
            }
            exportSingleData(0);
        }
        
        // Export last data point
        function exportLastData() {
            if (simulationData.length === 0) {
                showError('Data Kosong', 'Tidak ada data untuk diekspor');
                return;
            }
            exportSingleData(simulationData.length - 1);
        }
        
        // Export data with maximum force
        function exportMaxData() {
            if (simulationData.length === 0) {
                showError('Data Kosong', 'Tidak ada data untuk diekspor');
                return;
            }
            
            let maxIndex = 0;
            let maxForce = simulationData[0].force;
            
            simulationData.forEach((data, index) => {
                if (data.force > maxForce) {
                    maxForce = data.force;
                    maxIndex = index;
                }
            });
            
            exportSingleData(maxIndex);
        }
        
        // Export data with minimum force
        function exportMinData() {
            if (simulationData.length === 0) {
                showError('Data Kosong', 'Tidak ada data untuk diekspor');
                return;
            }
            
            let minIndex = 0;
            let minForce = simulationData[0].force;
            
            simulationData.forEach((data, index) => {
                if (data.force < minForce) {
                    minForce = data.force;
                    minIndex = index;
                }
            });
            
            exportSingleData(minIndex);
        }
        
        // Export range data
        function exportRangeData() {
            if (simulationData.length === 0) {
                showError('Data Kosong', 'Tidak ada data untuk diekspor');
                return;
            }
            
            const startTime = parseFloat(exportStart.value);
            const endTime = parseFloat(exportEnd.value);
            
            if (isNaN(startTime) || isNaN(endTime) || startTime < 0 || endTime > 5 || startTime >= endTime) {
                showError('Rentang Tidak Valid', 'Masukkan rentang waktu yang valid (0-5 detik)');
                return;
            }
            
            const filteredData = simulationData.filter(data => 
                data.time >= startTime && data.time <= endTime
            );
            
            if (filteredData.length === 0) {
                showError('Data Tidak Ditemukan', 'Tidak ada data dalam rentang waktu tersebut');
                return;
            }
            
            // Temporarily select the filtered data
            const originalSelection = simulationData.map(data => data.selected);
            simulationData.forEach(data => {
                data.selected = (data.time >= startTime && data.time <= endTime);
            });
            
            // Export selected data
            exportSelectedData();
            
            // Restore original selection
            simulationData.forEach((data, index) => {
                data.selected = originalSelection[index];
            });
            
            updateDataTable();
        }
        
        // Export all data
        function exportAllData() {
            if (simulationData.length === 0) {
                showError('Data Kosong', 'Tidak ada data untuk diekspor');
                return;
            }
            
            // Select all data
            simulationData.forEach(data => {
                data.selected = true;
            });
            
            // Export selected data
            exportSelectedData();
            
            // Clear selection
            simulationData.forEach(data => {
                data.selected = false;
            });
            
            updateDataTable();
        }
        
        // Export chart
        function exportChart(type) {
            if (!forceChart || simulationData.length === 0) {
                showError('Grafik Tidak Tersedia', 'Tidak ada data simulasi untuk diekspor');
                return;
            }
            
            let canvas = null;
            let filename = '';
            
            if (type === 'force') {
                canvas = forceChartCanvas;
                filename = `grafik-gaya-lorentz-${new Date().toISOString().slice(0, 10)}.png`;
            } else if (type === 'energy') {
                canvas = energyChartCanvas;
                filename = `grafik-energi-${new Date().toISOString().slice(0, 10)}.png`;
            } else if (type === 'both') {
                // Create combined chart
                const combinedCanvas = document.createElement('canvas');
                combinedCanvas.width = 800;
                combinedCanvas.height = 600;
                const ctx = combinedCanvas.getContext('2d');
                
                // Draw background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);
                
                // Draw title
                ctx.fillStyle = '#1f2937';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('GRAFIK SIMULASI GAYA LORENTZ', combinedCanvas.width / 2, 30);
                ctx.font = '14px Arial';
                ctx.fillText(`Parameter: B=${params.B} T, q=${params.q} C, v=${params.v} m/s, θ=${params.angle}°`, combinedCanvas.width / 2, 55);
                ctx.fillText(`Tanggal: ${new Date().toLocaleString('id-ID')}`, combinedCanvas.width / 2, 75);
                
                // Draw force chart
                ctx.drawImage(forceChartCanvas, 50, 100, 700, 200);
                
                // Draw energy chart
                ctx.drawImage(energyChartCanvas, 50, 350, 700, 200);
                
                // Convert to data URL
                const dataUrl = combinedCanvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `grafik-kombinasi-${new Date().toISOString().slice(0, 10)}.png`;
                link.href = dataUrl;
                link.click();
                
                showError('Grafik Tersimpan', 'Kedua grafik telah diunduh sebagai PNG');
                return;
            }
            
            const dataUrl = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = filename;
            link.href = dataUrl;
            link.click();
            
            showError('Grafik Tersimpan', `Grafik ${type} telah diunduh sebagai PNG`);
        }
        
        // Update export preview
        function updateExportPreview() {
            if (simulationData.length === 0) {
                exportPreview.textContent = 'Belum ada data simulasi. Jalankan simulasi terlebih dahulu.';
                return;
            }
            
            const precision = parseInt(exportPrecision.value);
            const specificTime = parseFloat(exportSpecificTime.value);
            const startTime = parseFloat(exportStart.value);
            const endTime = parseFloat(exportEnd.value);
            
            let preview = '';
            
            // Show data for specific time if provided
            if (!isNaN(specificTime) && specificTime >= 0 && specificTime <= 5) {
                let closestData = null;
                let minDiff = Infinity;
                
                simulationData.forEach(data => {
                    const diff = Math.abs(data.time - specificTime);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestData = data;
                    }
                });
                
                if (closestData) {
                    preview = `Data pada t ≈ ${closestData.time.toFixed(2)}s:\n` +
                             `Gaya Lorentz: ${closestData.force.toFixed(precision)} N\n` +
                             `Energi: ${closestData.energy.toExponential(precision)} J\n` +
                             `Momentum: ${closestData.momentum.toExponential(precision)} kg·m/s\n` +
                             `Jari-jari: ${closestData.radius.toExponential(precision)} m`;
                } else {
                    preview = 'Tidak ada data pada waktu tersebut';
                }
            } else {
                // Show summary
                preview = `Total Data: ${simulationData.length}\n` +
                         `Rentang Waktu: 0.0 - ${Math.min(5, simulationTimeValue).toFixed(1)} s\n` +
                         `Interval: ${params.dt} s\n` +
                         `Gaya Maksimum: ${Math.max(...simulationData.map(d => d.force)).toFixed(precision)} N\n` +
                         `Gaya Minimum: ${Math.min(...simulationData.map(d => d.force)).toFixed(precision)} N\n` +
                         `Rata-rata Gaya: ${(simulationData.reduce((sum, d) => sum + d.force, 0) / simulationData.length).toFixed(precision)} N`;
            }
            
            exportPreview.textContent = preview;
        }
        
        // Switch tab
        function switchTab(tab) {
            // Update tab buttons
            tabSimulasi.classList.remove('active');
            tabData.classList.remove('active');
            tabEkspor.classList.remove('active');
            
            simulasiContent.classList.add('hidden');
            dataContent.classList.add('hidden');
            eksporContent.classList.add('hidden');
            
            // Show selected tab
            switch(tab) {
                case 'simulasi':
                    tabSimulasi.classList.add('active');
                    simulasiContent.classList.remove('hidden');
                    break;
                case 'data':
                    tabData.classList.add('active');
                    dataContent.classList.remove('hidden');
                    updateDataTable();
                    break;
                case 'ekspor':
                    tabEkspor.classList.add('active');
                    eksporContent.classList.remove('hidden');
                    updateExportPreview();
                    break;
            }
        }
        
        // Helper function to download file
        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // Update display
        function updateDisplay() {
            const results = calculateLorentzForce();
            currentForce.textContent = `${results.force.toFixed(2)} N`;
            currentEnergy.textContent = `${results.energy.toExponential(2)} J`;
        }
        
        // Error handling
        function showError(title, message) {
            errorTitle.textContent = title;
            errorDetail.textContent = message;
            errorMessage.classList.remove('hidden');
            
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 3000);
        }
        
        // Add spin animation
        const style = document.createElement('style');
        style.textContent = `
            .spin {
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
