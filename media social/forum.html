<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Forum Diskusi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Cloudinary Widget -->
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #9999ff;
      --secondary: #7a7ae6;
    }
    
    body {
      font-family: 'Baloo 2', cursive;
      background-color: #f8fafc;
    }
    
    .app-container {
      max-width: 414px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      position: relative;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      /* Tambahkan padding-top untuk header fixed */
      padding-top: 72px; /* Tinggi header (64px + 8px margin) */
    }
    
    /* HEADER FIXED - BERWARNA PUTIH */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      max-width: 414px;
      margin: 0 auto;
      background: white; /* Diubah dari gradient menjadi putih */
      padding: 1rem; /* Menambahkan padding */
    }
    
    /* Sesuaikan main content untuk dimulai di bawah header */
    main {
      padding-bottom: 80px; /* Space untuk bottom nav */
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      max-width: 414px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
      background: white;
      z-index: 100; /* Sama dengan header */
      height: 70px;
      display: flex;
      align-items: center;
    }
    
    .nav-icon {
      transition: all 0.3s ease;
      font-size: 1.25rem;
    }
    
    .nav-icon.active {
      transform: translateY(-5px);
      color: var(--primary);
    }
    
    .app-logo {
      display: flex;
      align-items: center;
    }
    
    .app-logo-icon {
      background: linear-gradient(135deg, #9999ff, #7a7ae6);
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
    }
    
    .app-name {
      font-weight: 700;
      font-size: 1.25rem;
      color: #9999ff;
    }

    /* INSTAGRAM-STYLE THREAD LAYOUT */
    .threads-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      padding: 12px;
    }
    
    .thread-card {
      background: white;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .thread-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    /* Thread header (profile + name + time) */
    .thread-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .avatar { 
      width: 32px; 
      height: 32px; 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-weight: bold; 
      color: white; 
      flex-shrink: 0;
      margin-right: 12px;
    }
    
    .thread-user-info {
      flex: 1;
      min-width: 0;
    }
    
    .thread-user-name {
      font-weight: 600;
      font-size: 0.9375rem;
      color: #111827;
      line-height: 1.2;
    }
    
    .thread-time {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 2px;
    }
    
    /* Thread content */
    .thread-content-container {
      padding: 12px 16px 0;
    }
    
    .thread-text {
      font-size: 0.9375rem;
      line-height: 1.5;
      color: #374151;
      margin-bottom: 12px;
      word-break: break-word;
    }
    
    /* Highlight mention @nayraai */
    .mention-nayraai {
      color: #9999ff;
      font-weight: bold;
      background-color: rgba(153, 153, 255, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    /* AI Reply Styling */
    .ai-reply {
      background-color: #f0f9ff;
      border-left: 4px solid #9999ff;
      padding: 10px;
      margin-top: 8px;
      border-radius: 8px;
    }
    
    .ai-reply-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .ai-reply-icon {
      background-color: #9999ff;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
      font-size: 12px;
    }
    
    .ai-reply-name {
      font-weight: 600;
      color: #9999ff;
      font-size: 0.875rem;
    }
    
    .ai-reply-text {
      font-size: 0.875rem;
      color: #374151;
      line-height: 1.5;
    }
    
    /* Loading indicator untuk AI */
    .ai-typing-indicator {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      background-color: #f0f9ff;
      border-radius: 8px;
      margin-top: 4px;
    }
    
    .ai-typing-dots {
      display: flex;
      align-items: center;
    }
    
    .ai-typing-dot {
      width: 6px;
      height: 6px;
      background-color: #9999ff;
      border-radius: 50%;
      margin: 0 2px;
      animation: typing 1.4s infinite ease-in-out;
    }
    
    .ai-typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .ai-typing-dot:nth-child(2) { animation-delay: -0.16s; }
    .ai-typing-dot:nth-child(3) { animation-delay: 0s; }
    
    @keyframes typing {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    
    /* Instagram-style image grid */
    .thread-images {
      margin-top: 8px;
      position: relative;
    }
    
    .single-image {
      width: 100%;
      max-height: 500px;
      border-radius: 8px;
      object-fit: cover;
    }
    
    .multi-image-grid {
      display: grid;
      gap: 2px;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .two-images {
      grid-template-columns: 1fr 1fr;
    }
    
    .three-images {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 200px 200px;
    }
    
    .four-images {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 150px 150px;
    }
    
    .five-images {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 120px 120px 120px;
    }
    
    .multi-image-item {
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    
    .multi-image-item:hover {
      transform: scale(1.03);
    }
    
    .image-count-overlay {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.875rem;
      font-weight: 600;
      z-index: 2;
    }
    
    /* Thread actions (like, comment, share) */
    .thread-actions {
      padding: 8px 16px;
      display: flex;
      align-items: center;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .thread-action-btn {
      background: none;
      border: none;
      display: flex;
      align-items: center;
      padding: 8px;
      margin-right: 16px;
      color: #6b7280;
      cursor: pointer;
      transition: color 0.2s ease;
      border-radius: 50%;
    }
    
    .thread-action-btn:hover {
      background-color: #f9fafb;
    }
    
    .like-btn:hover {
      color: #ef4444;
    }
    
    .like-btn.liked {
      color: #ef4444;
    }
    
    .comment-btn:hover {
      color: #3b82f6;
    }
    
    .action-count {
      font-size: 0.875rem;
      font-weight: 500;
      margin-left: 6px;
    }
    
    .action-icon {
      font-size: 1.25rem;
    }
    
    /* Thread stats */
    .thread-stats {
      padding: 8px 16px 12px;
      font-size: 0.875rem;
      color: #6b7280;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .likes-count {
      font-weight: 600;
      color: #111827;
    }
    
    /* Comments header with toggle button */
    .comments-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .comments-toggle-btn {
      background: none;
      border: none;
      color: #6b7280;
      font-size: 0.875rem;
      cursor: pointer;
      padding: 4px 8px;
      font-weight: 500;
      transition: color 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
      border-radius: 4px;
    }
    
    .comments-toggle-btn:hover {
      color: #111827;
      background-color: #f9fafb;
    }
    
    .toggle-icon {
      transition: transform 0.3s ease;
      font-size: 0.75rem;
    }
    
    .toggle-icon.collapsed {
      transform: rotate(-90deg);
    }
    
    /* Comments section - initially hidden */
    .comments-section {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
      opacity: 0;
    }
    
    .comments-section.expanded {
      max-height: 2000px;
      opacity: 1;
    }
    
    /* Comment list inside expanded section */
    .comments-list {
      padding: 12px 16px 0;
    }
    
    .comment {
      display: flex;
      margin-bottom: 12px;
    }
    
    .comment-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      margin-right: 8px;
      flex-shrink: 0;
    }
    
    .comment-content {
      flex: 1;
    }
    
    .comment-header {
      display: flex;
      align-items: baseline;
      margin-bottom: 2px;
    }
    
    .comment-user {
      font-weight: 600;
      font-size: 0.875rem;
      color: #111827;
      margin-right: 8px;
    }
    
    .comment-text {
      font-size: 0.875rem;
      color: #374151;
      line-height: 1.4;
    }
    
    .comment-actions {
      display: flex;
      align-items: center;
      margin-top: 4px;
    }
    
    .comment-time {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-right: 12px;
    }
    
    .comment-like-btn {
      background: none;
      border: none;
      color: #9ca3af;
      font-size: 0.75rem;
      cursor: pointer;
      padding: 2px 0;
      transition: color 0.2s ease;
    }
    
    .comment-like-btn:hover {
      color: #ef4444;
    }
    
    .comment-reply-btn {
      background: none;
      border: none;
      color: #9ca3af;
      font-size: 0.75rem;
      cursor: pointer;
      padding: 2px 0;
      margin-left: 12px;
      transition: color 0.2s ease;
    }
    
    .comment-reply-btn:hover {
      color: #3b82f6;
    }
    
    /* Add comment input - always visible even when comments are collapsed */
    .add-comment {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-top: 1px solid #f3f4f6;
    }
    
    .comment-input {
      flex: 1;
      border: none;
      background: none;
      padding: 8px 0;
      font-size: 0.875rem;
      color: #111827;
      outline: none;
      resize: none;
      max-height: 60px;
      font-family: 'Baloo 2', cursive;
    }
    
    .comment-input::placeholder {
      color: #9ca3af;
    }
    
    .post-comment-btn {
      background: none;
      border: none;
      color: #9999ff;
      font-weight: 600;
      font-size: 0.875rem;
      cursor: pointer;
      padding: 8px 0 8px 8px;
      transition: color 0.2s ease;
    }
    
    .post-comment-btn:hover {
      color: #7a7ae6;
    }
    
    .post-comment-btn:disabled {
      color: #d1d5db;
      cursor: not-allowed;
    }
    
    /* Thread options */
    .thread-options {
      position: absolute;
      top: 12px;
      right: 16px;
    }
    
    .thread-options-btn {
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      transition: background-color 0.2s ease;
    }
    
    .thread-options-btn:hover {
      background-color: #f3f4f6;
    }
    
    .thread-options-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      min-width: 160px;
      z-index: 100;
      overflow: hidden;
      display: none;
    }
    
    .thread-options-menu.show {
      display: block;
    }
    
    .thread-option-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      font-size: 0.875rem;
      color: #374151;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    .thread-option-item:hover {
      background-color: #f9fafb;
    }
    
    .thread-option-item.delete {
      color: #ef4444;
    }
    
    .thread-option-icon {
      margin-right: 12px;
      width: 16px;
      text-align: center;
    }
    
    /* Image styles */
    .thread-image {
      max-width: 100%;
      max-height: 500px;
      border-radius: 8px;
      margin-top: 10px;
      cursor: pointer;
      transition: transform 0.3s ease;
      object-fit: cover;
    }
    
    .thread-image:hover {
      transform: scale(1.02);
    }
    
    .image-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    
    .image-preview {
      position: relative;
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .image-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .remove-image-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(255, 0, 0, 0.8);
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .image-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .image-modal.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    .image-modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
    }
    
    .close-modal-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* FAB Styles */
    .fab-container {
      position: fixed;
      bottom: 80px;
      right: 24px;
      z-index: 1000;
      transition: all 0.3s ease;
    }
    
    .fab {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-color: #9999ff;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .fab:hover {
      background-color: #7a7ae6;
      transform: scale(1.05);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }
    
    .fab i {
      font-size: 1.5rem;
    }
    
    .fab-form-container {
      position: fixed;
      bottom: 146px;
      right: 24px;
      width: 300px;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      padding: 16px;
      z-index: 999;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
      pointer-events: none;
    }
    
    .fab-form-container.active {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    
    .fab-form-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 998;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .fab-form-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    
    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100vh;
      background-color: white;
      box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
      transition: right 0.3s ease;
      z-index: 1001;
      overflow-y: auto;
    }
    
    .sidebar.active {
      right: 0;
    }
    
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .hamburger {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #9999ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .hamburger:hover {
      background-color: #7a7ae6;
      transform: scale(1.05);
    }
    
    .sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .sidebar-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #9999ff;
    }
    
    .sidebar-content {
      padding: 1rem;
    }
    
    .ai-feature {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      background-color: #f7f9fc;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .ai-feature:hover {
      background-color: #e6f0ff;
      transform: translateY(-2px);
    }
    
    .ai-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #9999ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-right: 1rem;
    }
    
    .ai-text {
      flex: 1;
    }
    
    .ai-title {
      font-weight: 600;
      color: #2d3748;
    }
    
    .ai-desc {
      font-size: 0.875rem;
      color: #718096;
    }
    
    /* Pagination Styles */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
      gap: 0.5rem;
    }
    
    .pagination-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f1f5f9;
      color: #475569;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .pagination-btn:hover:not(:disabled) {
      background-color: #e2e8f0;
    }
    
    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination-btn.active {
      background-color: #9999ff;
      color: white;
    }
    
    .pagination-info {
      font-size: 0.875rem;
      color: #64748b;
      margin: 0 0.5rem;
    }
    
    .loading-indicator {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
      color: #64748b;
    }
    
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #e2e8f0;
      border-top: 2px solid #9999ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Style khusus untuk bottom nav items */
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      text-decoration: none;
      flex: 1;
      height: 100%;
      padding: 0.5rem 0;
    }
    
    .nav-item span {
      font-size: 0.75rem;
      margin-top: 0.25rem;
    }
    
    .reply-item {
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Improved mobile styles */
    @media (max-width: 414px) {
      /* Sesuaikan padding-top untuk header fixed di mobile */
      .app-container {
        padding-top: 68px; /* Sedikit lebih kecil untuk mobile */
      }
      
      .threads-grid {
        padding: 8px;
        gap: 8px;
      }
      
      .thread-header {
        padding: 10px 12px;
      }
      
      .thread-content-container {
        padding: 10px 12px 0;
      }
      
      .thread-actions {
        padding: 6px 12px;
      }
      
      .thread-stats {
        padding: 6px 12px 10px;
      }
      
      .comments-header {
        padding: 10px 12px;
      }
      
      .comments-list {
        padding: 10px 12px 0;
      }
      
      .add-comment {
        padding: 10px 12px;
      }
      
      .fab-form-container {
        width: 85%;
        right: 50%;
        transform: translate(50%, 20px);
      }
      
      .fab-form-container.active {
        transform: translate(50%, 0);
      }
      
      .sidebar {
        width: 280px;
        right: -280px;
      }
      
      .pagination {
        padding: 0.75rem;
      }
      
      .pagination-btn {
        width: 32px;
        height: 32px;
      }
      
      .bottom-nav {
        height: 65px;
      }
      
      .nav-icon {
        font-size: 1.1rem;
      }
      
      .thread-image {
        max-height: 300px;
      }
      
      .image-preview {
        width: 60px;
        height: 60px;
      }
      
      .send-reply-btn {
        width: 32px;
        height: 32px;
      }
    }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Mobile App Container -->
  <div class="app-container">
    <!-- App Header - Sekarang fixed dan putih -->
    <header class="p-4">
      <div class="flex justify-between items-center">
        <div class="app-logo">
          <div class="app-logo-icon" style="background: #9999ff; color: white;">
            <i class="fas fa-atom"></i>
          </div>
          <h1 class="app-name" style="color: #9999ff;">QUANTARA</h1>
        </div>
        <div class="flex items-center space-x-3">
          <div class="hamburger" id="hamburgerButton">
            <i class="fas fa-bars"></i>
          </div>
        </div>
      </div>
    </header>

    <!-- Sidebar -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">Menu AI</div>
        <button class="hamburger" id="closeSidebar">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="sidebar-content">
        <!-- Link ke pesan.html -->
        <a href="../pesan/pesan.html" class="ai-feature">
          <div class="ai-icon">
            <i class="fas fa-paper-plane"></i>
          </div>
          <div class="ai-text">
            <div class="ai-title">Message</div>
            <div class="ai-desc">Sapa Teman dengan pesan singkat</div>
          </div>
        </a>
        
        <!-- Link ke nayra.html -->
        <a href="../ai/nayra.html" class="ai-feature">
          <div class="ai-icon">
            <i class="fas fa-robot"></i>
          </div>
          <div class="ai-text">
            <div class="ai-title">Nayra AI</div>
            <div class="ai-desc">Asisten AI untuk membantu belajar sains</div>
          </div>
        </a>
      </div>
    </div>
    
    <!-- Image Modal -->
    <div class="image-modal" id="imageModal">
      <button class="close-modal-btn" id="closeModalBtn">
        <i class="fas fa-times"></i>
      </button>
      <img id="modalImage" src="" alt="Gambar diperbesar">
    </div>
    
    <!-- Thread Container (Instagram-style grid) -->
    <main class="pb-20">
      <div id="threads" class="threads-grid"></div>
      <div id="loadingIndicator" class="loading-indicator" style="display: none;">
        <div class="loading-spinner"></div>
        <span>Memuat thread...</span>
      </div>
      <div id="pagination" class="pagination"></div>
    </main>

    <!-- Post Form (Hidden by default, will be shown via FAB) -->
    <div class="fab-form-overlay" id="fabFormOverlay"></div>
    
    <div class="fab-form-container" id="fabFormContainer">
      <div class="flex items-start space-x-3 mb-4">
        <div class="avatar" style="background-color: #9999ff;">
          <span id="userInitial" class="text-lg">U</span>
        </div>
        <div>
          <p class="text-sm font-semibold" id="fabUserName">User</p>
        </div>
      </div>
      
      <textarea 
        id="fabMsgInput" 
        placeholder="Apa yang ingin Anda diskusikan? (bisa LaTeX: $x^2+y^2=z^2$)" 
        rows="4"
        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-9999ff focus:border-transparent resize-none"
        style="--tw-ring-color: #9999ff;"
      ></textarea>
      
      <!-- Image preview container -->
      <div id="imagePreviewContainer" class="image-preview-container" style="display: none;"></div>
      
      <div class="flex justify-between items-center mt-3">
        <div class="flex space-x-2" style="color: #9999ff;">
          <!-- Image upload button -->
          <button id="imageUploadBtn" class="p-2 rounded-full hover:bg-blue-50" title="Unggah gambar">
            <i class="fas fa-image"></i>
          </button>
          <button class="p-2 rounded-full hover:bg-blue-50"><i class="fas fa-code"></i></button>
        </div>
        <button id="fabSendBtn" class="text-white px-4 py-2 rounded-full font-medium disabled:opacity-50 disabled:cursor-not-allowed" 
                style="background-color: #9999ff; hover:background-color: #7a7ae6;" disabled>
          Post
        </button>
      </div>
    </div>

    <!-- FAB Button -->
    <div class="fab-container">
      <div class="fab" id="fabButton">
        <i class="fas fa-plus"></i>
      </div>
    </div>
    
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
      <a href="../dashboard siswa.html" class="nav-item">
        <i class="fas fa-home nav-icon"></i>
        <span>Beranda</span>
      </a>
      <a href="../soal harian/dashboard soal.html" class="nav-item">
        <i class="fas fa-flask nav-icon"></i>
        <span>Soal Harian</span>
      </a>
      <a href="../ai/nayra.html" class="nav-item">
        <i class="fas fa-robot nav-icon"></i>
        <span>Nayra AI</span>
      </a>
      <a href="../materi harian/kategori materi.html" class="nav-item">
        <i class="fas fa-chalkboard-teacher nav-icon"></i>
        <span>Materi Harian</span>
      </a>
      <a href="../profil/profil.html" class="nav-item">
        <i class="fas fa-user nav-icon"></i>
        <span>Profil</span>
      </a>
    </nav>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, orderBy, onSnapshot, doc, updateDoc,
      arrayUnion, arrayRemove, getDoc,
      deleteDoc, getDocs, writeBatch, limit, startAfter
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ðŸ”¹ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAJ5I8k2MzAyDLt9fUcXHRNtRVjKB_ETLY",
      authDomain: "projectid-81104.firebaseapp.com",
      projectId: "projectid-81104",
      storageBucket: "projectid-81104.appspot.com",
      messagingSenderId: "554913260457",
      appId: "1:554913260457:web:bf988867ebfd902c651ab8"
    };

    // ðŸ”¹ Cloudinary Configuration
    const CLOUDINARY_CLOUD_NAME = "ddjzsvomj";
    const CLOUDINARY_API_KEY = "846512428512365";
    const CLOUDINARY_UPLOAD_PRESET = "forum_images"; // Anda perlu membuat upload preset di Cloudinary

    // ðŸ”¹ Groq AI Configuration - Diubah ke llama-3.1-8b-instant
    const GROQ_API_KEY = "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"; // Ganti dengan API key Groq Anda
    const GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions";
    const AI_MODEL = "llama-3.1-8b-instant"; // Diubah dari mixtral-8x7b-32768 ke llama-3.1-8b-instant

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const threadsDiv = document.getElementById("threads");
    const userInitial = document.getElementById("userInitial");
    const fabUserName = document.getElementById("fabUserName");
    const loadingIndicator = document.getElementById("loadingIndicator");
    const paginationDiv = document.getElementById("pagination");
    
    // FAB elements
    const fabButton = document.getElementById("fabButton");
    const fabFormContainer = document.getElementById("fabFormContainer");
    const fabFormOverlay = document.getElementById("fabFormOverlay");
    const fabMsgInput = document.getElementById("fabMsgInput");
    const fabSendBtn = document.getElementById("fabSendBtn");
    const imageUploadBtn = document.getElementById("imageUploadBtn");
    const imagePreviewContainer = document.getElementById("imagePreviewContainer");
    
    // Sidebar elements
    const hamburgerButton = document.getElementById("hamburgerButton");
    const closeSidebar = document.getElementById("closeSidebar");
    const sidebar = document.getElementById("sidebar");
    const sidebarOverlay = document.getElementById("sidebarOverlay");
    
    // Image modal elements
    const imageModal = document.getElementById("imageModal");
    const modalImage = document.getElementById("modalImage");
    const closeModalBtn = document.getElementById("closeModalBtn");

    // Pagination variables
    const THREADS_PER_PAGE = 5;
    let currentPage = 1;
    let lastVisible = null;
    let firstVisible = null;
    let totalThreads = 0;
    let totalPages = 1;
    let threadsQuery = null;
    let threadsUnsubscribe = null;

    let currentUser = null;
    let currentProfile = null;
    let uploadedImages = []; // Array untuk menyimpan URL gambar yang diunggah
    
    // IndexedDB variables
    let dbCache = null;
    const DB_NAME = 'forum_cache';
    const DB_VERSION = 1;
    const THREADS_STORE = 'threads';
    const REPLIES_STORE = 'replies';
    const CACHE_DURATION = 5 * 60 * 1000; // 5 menit dalam milidetik

    // Initialize IndexedDB
    async function initIndexedDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          dbCache = request.result;
          resolve(dbCache);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          
          // Buat store untuk threads
          if (!db.objectStoreNames.contains(THREADS_STORE)) {
            const threadsStore = db.createObjectStore(THREADS_STORE, { keyPath: 'id' });
            threadsStore.createIndex('createdAt', 'createdAt', { unique: false });
            threadsStore.createIndex('cachedAt', 'cachedAt', { unique: false });
          }
          
          // Buat store untuk replies
          if (!db.objectStoreNames.contains(REPLIES_STORE)) {
            const repliesStore = db.createObjectStore(REPLIES_STORE, { keyPath: 'id' });
            repliesStore.createIndex('threadId', 'threadId', { unique: false });
            repliesStore.createIndex('createdAt', 'createdAt', { unique: false });
            repliesStore.createIndex('cachedAt', 'cachedAt', { unique: false });
          }
        };
      });
    }

    // Save threads to cache
    async function saveThreadsToCache(threads) {
      if (!dbCache) return;
      
      return new Promise((resolve, reject) => {
        const transaction = dbCache.transaction([THREADS_STORE], 'readwrite');
        const store = transaction.objectStore(THREADS_STORE);
        
        threads.forEach(thread => {
          store.put({
            ...thread,
            cachedAt: Date.now()
          });
        });
        
        transaction.oncomplete = () => resolve();
        transaction.onerror = () => reject(transaction.error);
      });
    }

    // Get threads from cache
    async function getThreadsFromCache(page = 1, limit = THREADS_PER_PAGE) {
      if (!dbCache) return { threads: [], total: 0 };
      
      return new Promise((resolve, reject) => {
        const transaction = dbCache.transaction([THREADS_STORE], 'readonly');
        const store = transaction.objectStore(THREADS_STORE);
        const index = store.index('createdAt');
        const request = index.getAll();
        
        request.onsuccess = () => {
          const allThreads = request.result;
          
          // Filter out expired cache
          const now = Date.now();
          const validThreads = allThreads.filter(thread => 
            thread.cachedAt && (now - thread.cachedAt) < CACHE_DURATION
          );
          
          // Sort by createdAt descending
          validThreads.sort((a, b) => b.createdAt - a.createdAt);
          
          // Apply pagination
          const start = (page - 1) * limit;
          const end = start + limit;
          const paginatedThreads = validThreads.slice(start, end);
          
          resolve({
            threads: paginatedThreads,
            total: validThreads.length
          });
        };
        
        request.onerror = () => reject(request.error);
      });
    }

    // Save replies to cache
    async function saveRepliesToCache(threadId, replies) {
      if (!dbCache) return;
      
      return new Promise((resolve, reject) => {
        const transaction = dbCache.transaction([REPLIES_STORE], 'readwrite');
        const store = transaction.objectStore(REPLIES_STORE);
        
        replies.forEach(reply => {
          store.put({
            ...reply,
            threadId: threadId,
            cachedAt: Date.now()
          });
        });
        
        transaction.oncomplete = () => resolve();
        transaction.onerror = () => reject(transaction.error);
      });
    }

    // Get replies from cache
    async function getRepliesFromCache(threadId) {
      if (!dbCache) return [];
      
      return new Promise((resolve, reject) => {
        const transaction = dbCache.transaction([REPLIES_STORE], 'readonly');
        const store = transaction.objectStore(REPLIES_STORE);
        const index = store.index('threadId');
        const request = index.getAll(threadId);
        
        request.onsuccess = () => {
          const allReplies = request.result;
          
          // Filter out expired cache
          const now = Date.now();
          const validReplies = allReplies.filter(reply => 
            reply.cachedAt && (now - reply.cachedAt) < CACHE_DURATION
          );
          
          // Sort by createdAt ascending
          validReplies.sort((a, b) => a.createdAt - b.createdAt);
          
          resolve(validReplies);
        };
        
        request.onerror = () => reject(request.error);
      });
    }

    // Clear expired cache
    async function clearExpiredCache() {
      if (!dbCache) return;
      
      const now = Date.now();
      
      // Clear expired threads
      const threadsTransaction = dbCache.transaction([THREADS_STORE], 'readwrite');
      const threadsStore = threadsTransaction.objectStore(THREADS_STORE);
      const threadsRequest = threadsStore.index('cachedAt').openCursor();
      
      threadsRequest.onsuccess = (event) => {
        const cursor = event.target.result;
        if (cursor) {
          if (now - cursor.value.cachedAt > CACHE_DURATION) {
            cursor.delete();
          }
          cursor.continue();
        }
      };
      
      // Clear expired replies
      const repliesTransaction = dbCache.transaction([REPLIES_STORE], 'readwrite');
      const repliesStore = repliesTransaction.objectStore(REPLIES_STORE);
      const repliesRequest = repliesStore.index('cachedAt').openCursor();
      
      repliesRequest.onsuccess = (event) => {
        const cursor = event.target.result;
        if (cursor) {
          if (now - cursor.value.cachedAt > CACHE_DURATION) {
            cursor.delete();
          }
          cursor.continue();
        }
      };
    }

    // Toggle sidebar
    function toggleSidebar() {
      sidebar.classList.toggle("active");
      sidebarOverlay.classList.toggle("active");
    }

    // Close sidebar
    function closeSidebarFunc() {
      sidebar.classList.remove("active");
      sidebarOverlay.classList.remove("active");
    }

    // Event listeners for sidebar
    hamburgerButton.addEventListener("click", toggleSidebar);
    closeSidebar.addEventListener("click", closeSidebarFunc);
    sidebarOverlay.addEventListener("click", closeSidebarFunc);

    // Toggle image modal
    function openImageModal(imageUrl) {
      modalImage.src = imageUrl;
      imageModal.classList.add("active");
    }

    function closeImageModal() {
      imageModal.classList.remove("active");
      modalImage.src = "";
    }

    // Event listeners for image modal
    closeModalBtn.addEventListener("click", closeImageModal);
    imageModal.addEventListener("click", (e) => {
      if (e.target === imageModal) {
        closeImageModal();
      }
    });

    // Toggle FAB form
    function toggleFabForm() {
      fabFormContainer.classList.toggle("active");
      fabFormOverlay.classList.toggle("active");
      
      if (fabFormContainer.classList.contains("active")) {
        fabMsgInput.focus();
      }
    }

    // Close FAB form
    function closeFabForm() {
      fabFormContainer.classList.remove("active");
      fabFormOverlay.classList.remove("active");
      fabMsgInput.value = "";
      fabSendBtn.disabled = true;
      // Clear image previews
      clearImagePreviews();
    }

    // Clear image previews
    function clearImagePreviews() {
      uploadedImages = [];
      imagePreviewContainer.innerHTML = "";
      imagePreviewContainer.style.display = "none";
    }

    // Event listeners for FAB
    fabButton.addEventListener("click", toggleFabForm);
    fabFormOverlay.addEventListener("click", closeFabForm);

    // Aktifkan tombol hanya kalau ada teks atau gambar
    fabMsgInput.addEventListener('input', () => {
      const hasText = fabMsgInput.value.trim().length > 0;
      const hasImages = uploadedImages.length > 0;
      fabSendBtn.disabled = !(hasText || hasImages);
    });

    // Initialize Cloudinary Upload Widget
    function initializeCloudinaryWidget() {
      const myWidget = cloudinary.createUploadWidget(
        {
          cloudName: CLOUDINARY_CLOUD_NAME,
          uploadPreset: CLOUDINARY_UPLOAD_PRESET,
          sources: ['local', 'url', 'camera'],
          multiple: true,
          maxFiles: 5,
          clientAllowedFormats: ['jpg', 'jpeg', 'png', 'gif', 'webp'],
          maxFileSize: 5000000, // 5MB
          styles: {
            palette: {
              window: "#FFFFFF",
              windowBorder: "#90A0B3",
              tabIcon: "#9999ff",
              menuIcons: "#5A616A",
              textDark: "#000000",
              textLight: "#FFFFFF",
              link: "#9999ff",
              action: "#FF620C",
              inactiveTabIcon: "#0E2F5A",
              error: "#F44235",
              inProgress: "#9999ff",
              complete: "#20B832",
              sourceBg: "#E4EBF1"
            }
          }
        },
        (error, result) => {
          if (!error && result && result.event === "success") {
            console.log("Image uploaded successfully: ", result.info);
            
            // Add image URL to uploadedImages array
            uploadedImages.push({
              url: result.info.secure_url,
              public_id: result.info.public_id
            });
            
            // Update image preview
            updateImagePreviews();
            
            // Enable send button if there are images
            fabSendBtn.disabled = false;
          }
          
          if (error) {
            console.error("Cloudinary upload error:", error);
            alert("Gagal mengunggah gambar: " + error.message);
          }
        }
      );

      // Add event listener to image upload button
      imageUploadBtn.addEventListener("click", () => {
        myWidget.open();
      }, false);
    }

    // Update image previews in the form
    function updateImagePreviews() {
      imagePreviewContainer.innerHTML = "";
      
      uploadedImages.forEach((image, index) => {
        const previewDiv = document.createElement("div");
        previewDiv.className = "image-preview";
        
        previewDiv.innerHTML = `
          <img src="${image.url}" alt="Preview ${index + 1}">
          <button class="remove-image-btn" data-index="${index}">
            <i class="fas fa-times"></i>
          </button>
        `;
        
        imagePreviewContainer.appendChild(previewDiv);
        
        // Add click event to image
        const img = previewDiv.querySelector('img');
        img.addEventListener('click', () => {
          openImageModal(image.url);
        });
      });
      
      // Show container if there are images
      imagePreviewContainer.style.display = uploadedImages.length > 0 ? "flex" : "none";
      
      // Add event listeners to remove buttons
      document.querySelectorAll('.remove-image-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const index = parseInt(btn.getAttribute('data-index'));
          removeImage(index);
        });
      });
    }

    // Remove image from preview
    function removeImage(index) {
      uploadedImages.splice(index, 1);
      updateImagePreviews();
      
      // Disable send button if no text and no images
      const hasText = fabMsgInput.value.trim().length > 0;
      const hasImages = uploadedImages.length > 0;
      fabSendBtn.disabled = !(hasText || hasImages);
    }

    // Ambil profil user (dari collection users -> field name)
    async function getUserProfile(uid) {
      try {
        const userRef = doc(db, "users", uid);
        const snap = await getDoc(userRef);
        return snap.exists() ? snap.data() : null;
      } catch (err) {
        console.error("getUserProfile:", err);
        return null;
      }
    }

    // Fungsi untuk mendeteksi mention @nayraai dalam teks
    function containsNayraAIMention(text) {
      if (!text) return false;
      // Deteksi berbagai variasi penulisan @nayraai
      const mentionPatterns = [
        /@nayraai\b/i,
        /@nayra\b/i,
        /@nairaai\b/i,
        /@naira\b/i
      ];
      
      return mentionPatterns.some(pattern => pattern.test(text));
    }

    // Fungsi untuk mengekstrak pertanyaan dari komentar (menghapus mention)
    function extractQuestionFromComment(text) {
      if (!text) return "";
      // Hapus mention @nayraai dan variannya
      const cleanedText = text
        .replace(/@nayraai\b/gi, '')
        .replace(/@nayra\b/gi, '')
        .replace(/@nairaai\b/gi, '')
        .replace(/@naira\b/gi, '')
        .trim();
      
      return cleanedText || "Hai! Apa yang bisa saya bantu?";
    }

    // Fungsi untuk memanggil Groq AI API dengan llama-3.1-8b-instant
    async function callGroqAI(question, threadContext = null) {
      try {
        if (!GROQ_API_KEY || GROQ_API_KEY === "gsk_YOUR_API_KEY_HERE") {
          console.error("API Key Groq tidak ditemukan!");
          return "Maaf, server Nayra AI sedang sibuk!";
        }
        
        // Siapkan prompt untuk AI
        let systemPrompt = `Anda adalah Nayra AI, asisten sains yang ramah dan membantu di forum QUANTARA. 
        Anda memiliki pengetahuan mendalam tentang matematika, fisika, kimia, biologi, dan ilmu pengetahuan lainnya.
        
        Tugas Anda:
        1. Jawab pertanyaan dengan jelas dan rinci
        2. Gunakan bahasa Indonesia yang mudah dipahami
        3. Jika relevan, sertakan rumus matematika dalam format LaTeX (gunakan $$ untuk display math dan $ untuk inline math)
        4. Jika tidak tahu jawabannya, akui dengan jujur dan sarankan sumber belajar lain
        5. Tetap ramah dan mendukung
        6. Maksimal jawaban 3-4 paragraf`;
        
        if (threadContext) {
          systemPrompt += `\n\nKonteks thread: ${threadContext}`;
        }
        
        const messages = [
          {
            role: "system",
            content: systemPrompt
          },
          {
            role: "user",
            content: question
          }
        ];
        
        const response = await fetch(GROQ_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${GROQ_API_KEY}`
          },
          body: JSON.stringify({
            model: AI_MODEL,
            messages: messages,
            temperature: 0.7,
            max_tokens: 1000
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        return data.choices[0]?.message?.content || "Maaf, saya tidak bisa menjawab saat ini.";
        
      } catch (error) {
        console.error("Error calling Groq AI:", error);
        return "Maaf, terjadi kesalahan saat memproses permintaan Anda. Silakan coba lagi nanti.";
      }
    }

    // Fungsi untuk menambahkan AI reply ke thread
    async function addAIReply(threadId, question, threadContext = null) {
      try {
        // Tampilkan indikator typing AI
        const repliesDiv = document.getElementById(`replies-${threadId}`);
        if (repliesDiv) {
          const typingIndicator = document.createElement("div");
          typingIndicator.className = "ai-typing-indicator";
          typingIndicator.id = `ai-typing-${threadId}`;
          typingIndicator.innerHTML = `
            <div class="ai-reply-icon">
              <i class="fas fa-robot"></i>
            </div>
            <div class="ai-typing-dots">
              <span class="ai-typing-dot"></span>
              <span class="ai-typing-dot"></span>
              <span class="ai-typing-dot"></span>
            </div>
            <span style="margin-left: 8px; font-size: 0.875rem; color: #666;">Nayra AI sedang mengetik...</span>
          `;
          repliesDiv.appendChild(typingIndicator);
          repliesDiv.scrollTop = repliesDiv.scrollHeight;
        }
        
        // Panggil Groq AI dengan model llama-3.1-8b-instant
        const aiResponse = await callGroqAI(question, threadContext);
        
        // Hapus indikator typing
        const typingElement = document.getElementById(`ai-typing-${threadId}`);
        if (typingElement) {
          typingElement.remove();
        }
        
        // Tambahkan reply AI ke Firebase
        const repliesRef = collection(db, "threads", threadId, "replies");
        await addDoc(repliesRef, {
          uid: "ai_nayra", // ID khusus untuk AI
          email: "ai@nayra.quantara",
          name: "Nayra AI",
          teks: aiResponse,
          isAI: true, // Flag untuk menandai ini adalah reply AI
          createdAt: serverTimestamp()
        });
        
        // Auto-expand comments section
        const commentsSection = document.getElementById(`comments-${threadId}`);
        if (!commentsSection.classList.contains('expanded')) {
          toggleComments(threadId);
        }
        
      } catch (error) {
        console.error("Error adding AI reply:", error);
        
        // Hapus indikator typing jika ada error
        const typingElement = document.getElementById(`ai-typing-${threadId}`);
        if (typingElement) {
          typingElement.remove();
        }
        
        // Tambahkan pesan error sebagai fallback
        const repliesRef = collection(db, "threads", threadId, "replies");
        await addDoc(repliesRef, {
          uid: "ai_nayra",
          email: "ai@nayra.quantara",
          name: "Nayra AI",
          teks: "Maaf, saya sedang mengalami kesalahan teknis. Silakan coba lagi nanti.",
          isAI: true,
          createdAt: serverTimestamp()
        });
      }
    }

    // Cek login
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        currentUser = user;
        currentProfile = await getUserProfile(user.uid);
        const initial = (currentProfile?.name?.charAt(0) || user.email.charAt(0)).toUpperCase();
        userInitial.textContent = initial;
        fabUserName.textContent = currentProfile?.name || user.email;
        
        // Initialize IndexedDB
        await initIndexedDB();
        // Clear expired cache
        await clearExpiredCache();
        
        // Initialize Cloudinary widget after user is authenticated
        initializeCloudinaryWidget();
        await loadThreads();
      }
    });

    // Post thread baru dari FAB form
    fabSendBtn.addEventListener("click", async () => {
      const text = fabMsgInput.value.trim();
      if (!text && uploadedImages.length === 0) return;
      
      try {
        // Prepare thread data
        const threadData = {
          uid: currentUser.uid,
          email: currentUser.email,
          name: currentProfile?.name || currentUser.email,
          teks: text,
          likes: 0,
          likedBy: [],
          createdAt: serverTimestamp()
        };
        
        // Add images if any
        if (uploadedImages.length > 0) {
          threadData.images = uploadedImages;
        }
        
        await addDoc(collection(db, "threads"), threadData);
        
        // Reset form
        closeFabForm();
        clearImagePreviews();
        
        // Reset to first page after posting
        currentPage = 1;
        await loadThreads();
      } catch (err) {
        console.error("add thread error:", err);
        alert("Gagal membuat thread: " + err.message);
      }
    });

    // Enter key untuk post dari FAB form
    fabMsgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && e.ctrlKey) {
        e.preventDefault();
        fabSendBtn.click();
      }
    });

    // Hitung total jumlah thread untuk pagination
    async function getTotalThreads() {
      try {
        const threadsSnapshot = await getDocs(collection(db, "threads"));
        return threadsSnapshot.size;
      } catch (err) {
        console.error("Error getting total threads:", err);
        return 0;
      }
    }

    // Load threads dengan pagination (with cache)
    async function loadThreads() {
      try {
        loadingIndicator.style.display = "flex";
        threadsDiv.innerHTML = "";
        
        // Unsubscribe previous listener if exists
        if (threadsUnsubscribe) {
          threadsUnsubscribe();
        }
        
        // Try to get threads from cache first
        const cacheResult = await getThreadsFromCache(currentPage, THREADS_PER_PAGE);
        
        if (cacheResult.threads.length > 0) {
          // Render threads from cache
          cacheResult.threads.forEach((thread) => {
            renderThread(thread.id, thread);
          });
          
          totalThreads = cacheResult.total;
          totalPages = Math.ceil(totalThreads / THREADS_PER_PAGE);
          renderPagination();
          
          // Render LaTeX
          renderMathInElement(threadsDiv, {
            delimiters: [
              {left: "$$", right: "$$", display: true},
              {left: "$", right: "$", display: false}
            ]
          });
          
          loadingIndicator.style.display = "none";
          console.log('Loaded threads from cache');
        } else {
          // If no cache, get from Firebase
          console.log('No cache available, loading from Firebase');
        }
        
        // Get total threads count
        totalThreads = await getTotalThreads();
        totalPages = Math.ceil(totalThreads / THREADS_PER_PAGE);
        
        // Build query based on current page
        if (currentPage === 1) {
          threadsQuery = query(
            collection(db, "threads"), 
            orderBy("createdAt", "desc"), 
            limit(THREADS_PER_PAGE)
          );
        } else {
          // We need to get the last document from previous page
          const firstPageQuery = query(
            collection(db, "threads"),
            orderBy("createdAt", "desc"),
            limit((currentPage - 1) * THREADS_PER_PAGE)
          );
          
          const firstPageSnapshot = await getDocs(firstPageQuery);
          const lastDoc = firstPageSnapshot.docs[firstPageSnapshot.docs.length - 1];
          
          threadsQuery = query(
            collection(db, "threads"),
            orderBy("createdAt", "desc"),
            startAfter(lastDoc),
            limit(THREADS_PER_PAGE)
          );
        }
        
        // Set up real-time listener for current page
        threadsUnsubscribe = onSnapshot(threadsQuery, async (snapshot) => {
          threadsDiv.innerHTML = "";
          const threadsToCache = [];
          
          snapshot.forEach((docSnap) => {
            const threadData = docSnap.data();
            // Convert timestamp for caching
            const threadForCache = {
              id: docSnap.id,
              ...threadData,
              createdAt: threadData.createdAt?.toDate?.()?.getTime() || Date.now()
            };
            threadsToCache.push(threadForCache);
            renderThread(docSnap.id, threadData);
          });
          
          // Save to cache
          if (threadsToCache.length > 0) {
            await saveThreadsToCache(threadsToCache);
          }
          
          // Update pagination UI
          renderPagination();
          
          // render LaTeX
          renderMathInElement(threadsDiv, {
            delimiters: [
              {left: "$$", right: "$$", display: true},
              {left: "$", right: "$", display: false}
            ]
          });
          
          loadingIndicator.style.display = "none";
        }, (err) => {
          console.error("thread snapshot error:", err);
          loadingIndicator.style.display = "none";
        });
      } catch (err) {
        console.error("Error loading threads:", err);
        loadingIndicator.style.display = "none";
      }
    }

    // Render pagination controls
    function renderPagination() {
      if (totalPages <= 1) {
        paginationDiv.innerHTML = "";
        return;
      }
      
      let paginationHTML = "";
      
      // Previous button
      paginationHTML += `
        <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">
          <i class="fas fa-chevron-left"></i>
        </button>
      `;
      
      // Page numbers
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      if (startPage > 1) {
        paginationHTML += `
          <button class="pagination-btn" onclick="changePage(1)">1</button>
          ${startPage > 2 ? '<span class="pagination-info">...</span>' : ''}
        `;
      }
      
      for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
          <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">
            ${i}
          </button>
        `;
      }
      
      if (endPage < totalPages) {
        paginationHTML += `
          ${endPage < totalPages - 1 ? '<span class="pagination-info">...</span>' : ''}
          <button class="pagination-btn" onclick="changePage(${totalPages})">${totalPages}</button>
        `;
      }
      
      // Next button
      paginationHTML += `
        <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">
          <i class="fas fa-chevron-right"></i>
        </button>
      `;
      
      // Page info
      paginationHTML += `
        <span class="pagination-info">
          Halaman ${currentPage} dari ${totalPages}
        </span>
      `;
      
      paginationDiv.innerHTML = paginationHTML;
    }

    // Change page function
    window.changePage = async function(page) {
      if (page < 1 || page > totalPages || page === currentPage) return;
      
      currentPage = page;
      await loadThreads();
      
      // Scroll to top of threads
      threadsDiv.scrollIntoView({ behavior: 'smooth' });
    };

    // Render Thread dengan layout Instagram-style dan komentar tersembunyi
    function renderThread(id, data) {
      const div = document.createElement("div");
      div.className = "thread-card";

      const colors = ['#9999ff','#ff9999','#99ff99','#ff99ff','#ffcc99','#ffff99'];
      const colorIndex = Math.abs(hashCode(data.name || data.email || "")) % colors.length;
      const avatarColor = colors[colorIndex];
      const initial = (data.name || data.email || "").charAt(0).toUpperCase();
      const isLiked = data.likedBy && data.likedBy.includes(currentUser.uid);
      const likeCount = data.likes || 0;

      // Process text to highlight @nayraai mentions
      let processedText = escapeHtml(data.teks || "");
      if (containsNayraAIMention(processedText)) {
        processedText = processedText.replace(/@nayraai\b/gi, '<span class="mention-nayraai">@nayraai</span>');
        processedText = processedText.replace(/@nayra\b/gi, '<span class="mention-nayraai">@nayra</span>');
        processedText = processedText.replace(/@nairaai\b/gi, '<span class="mention-nayraai">@nairaai</span>');
        processedText = processedText.replace(/@naira\b/gi, '<span class="mention-nayraai">@naira</span>');
      }

      // Prepare images HTML with Instagram-style grid
      let imagesHTML = "";
      if (data.images && data.images.length > 0) {
        const images = data.images;
        if (images.length === 1) {
          imagesHTML = `
            <div class="thread-images">
              <img src="${images[0].url}" alt="Gambar 1" class="single-image" onclick="openImageModal('${images[0].url}')">
            </div>
          `;
        } else {
          // Multi-image grid
          let gridClass = "";
          if (images.length === 2) gridClass = "two-images";
          else if (images.length === 3) gridClass = "three-images";
          else if (images.length === 4) gridClass = "four-images";
          else gridClass = "five-images";
          
          let gridHTML = "";
          const displayCount = Math.min(images.length, 5);
          
          for (let i = 0; i < displayCount; i++) {
            // Special handling for 3 images layout
            if (images.length === 3 && i === 0) {
              gridHTML += `
                <div style="grid-column: span 2;">
                  <img src="${images[i].url}" alt="Gambar ${i+1}" class="multi-image-item" onclick="openImageModal('${images[i].url}')">
                </div>
              `;
            } else {
              gridHTML += `
                <img src="${images[i].url}" alt="Gambar ${i+1}" class="multi-image-item" onclick="openImageModal('${images[i].url}')">
              `;
            }
          }
          
          imagesHTML = `
            <div class="thread-images">
              <div class="multi-image-grid ${gridClass}">
                ${gridHTML}
              </div>
              ${images.length > 5 ? `<div class="image-count-overlay">+${images.length - 5}</div>` : ''}
            </div>
          `;
        }
      }

      div.innerHTML = `
        <div class="thread-header">
          <div class="avatar" style="background-color: ${avatarColor};"><span>${initial}</span></div>
          <div class="thread-user-info">
            <div class="thread-user-name">${escapeHtml(data.name || data.email)}</div>
            <div class="thread-time">${formatDate(data.createdAt?.toDate?.())}</div>
          </div>
          <div class="thread-options">
            <button class="thread-options-btn" onclick="toggleThreadOptions('${id}')">
              <i class="fas fa-ellipsis-h"></i>
            </button>
            <div class="thread-options-menu" id="options-menu-${id}">
              ${data.uid === currentUser.uid ? `
                <div class="thread-option-item delete" onclick="deleteThread('${id}')">
                  <div class="thread-option-icon"><i class="fas fa-trash"></i></div>
                  <div>Hapus</div>
                </div>
              ` : ''}
              <div class="thread-option-item" onclick="reportThread('${id}')">
                <div class="thread-option-icon"><i class="fas fa-flag"></i></div>
                <div>Laporkan</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="thread-content-container">
          <div class="thread-text">${processedText}</div>
          ${imagesHTML}
        </div>
        
        <div class="thread-actions">
          <button class="thread-action-btn like-btn ${isLiked ? 'liked' : ''}" onclick="likeThread('${id}', ${isLiked})">
            <i class="fas fa-heart action-icon"></i>
            <span class="action-count">${likeCount}</span>
          </button>
          <button class="thread-action-btn comment-btn" onclick="toggleComments('${id}')">
            <i class="fas fa-comment action-icon"></i>
            <span class="action-count" id="reply-count-${id}">0</span>
          </button>
          <button class="thread-action-btn" onclick="shareThread('${id}')">
            <i class="fas fa-share action-icon"></i>
          </button>
        </div>
        
        <div class="thread-stats">
          <span class="likes-count">${likeCount} like${likeCount !== 1 ? 's' : ''}</span>
        </div>
        
        <div class="comments-header">
          <button class="comments-toggle-btn" onclick="toggleComments('${id}')" id="toggle-btn-${id}">
            <i class="fas fa-chevron-down toggle-icon collapsed" id="toggle-icon-${id}"></i>
            <span id="toggle-text-${id}">Lihat komentar (<span id="comment-count-${id}">0</span>)</span>
          </button>
        </div>
        
        <div class="comments-section" id="comments-${id}">
          <div class="comments-list" id="replies-${id}"></div>
        </div>
        
        <div class="add-comment">
          <div class="avatar comment-avatar" style="background-color: #9999ff;">
            <span>${(currentProfile?.name?.charAt(0) || currentUser.email.charAt(0)).toUpperCase()}</span>
          </div>
          <textarea id="comment-${id}" class="comment-input" placeholder="Tambahkan komentar..." rows="1"></textarea>
          <button onclick="replyToThread('${id}')" class="post-comment-btn" id="send-comment-${id}" disabled>
            Post
          </button>
        </div>
      `;

      threadsDiv.appendChild(div);

      // Setup comment input event listener
      setTimeout(() => {
        const commentInput = div.querySelector(`#comment-${id}`);
        const postCommentBtn = div.querySelector(`#send-comment-${id}`);
        
        if (commentInput && postCommentBtn) {
          // Auto-resize textarea
          commentInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            
            const hasText = this.value.trim().length > 0;
            postCommentBtn.disabled = !hasText;
          });
          
          // Enter key untuk komentar
          commentInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              if (!postCommentBtn.disabled) {
                window.replyToThread(id);
              }
            }
          });
        }
      }, 100);

      // Load replies (with cache)
      loadReplies(id);
    }

    // Load replies for a thread (with cache)
    async function loadReplies(threadId) {
      // Try to get from cache first
      const cachedReplies = await getRepliesFromCache(threadId);
      
      if (cachedReplies.length > 0) {
        // Render cached replies
        const repliesDiv = document.getElementById(`replies-${threadId}`);
        const replyCountSpan = document.getElementById(`reply-count-${threadId}`);
        const commentCountSpan = document.getElementById(`comment-count-${threadId}`);
        
        if (repliesDiv) {
          repliesDiv.innerHTML = "";
          cachedReplies.forEach((reply) => {
            repliesDiv.innerHTML += renderReply(reply, ['#9999ff','#ff9999','#99ff99','#ff99ff','#ffcc99','#ffff99'], threadId, reply.id);
          });
          
          if (replyCountSpan) replyCountSpan.textContent = cachedReplies.length;
          if (commentCountSpan) commentCountSpan.textContent = cachedReplies.length;
          
          // Render LaTeX inside replies area
          renderMathInElement(repliesDiv, {
            delimiters: [
              {left: "$$", right: "$$", display: true},
              {left: "$", right: "$", display: false}
            ]
          });
        }
        console.log(`Loaded ${cachedReplies.length} replies from cache for thread ${threadId}`);
      }
      
      // Then setup real-time listener
      const repliesRef = collection(db, "threads", threadId, "replies");
      const q = query(repliesRef, orderBy("createdAt", "asc"));
      
      onSnapshot(q, async (snap) => {
        const repliesDiv = document.getElementById(`replies-${threadId}`);
        const replyCountSpan = document.getElementById(`reply-count-${threadId}`);
        const commentCountSpan = document.getElementById(`comment-count-${threadId}`);
        if (!repliesDiv) return;
        
        const repliesToCache = [];
        let count = 0;
        
        repliesDiv.innerHTML = "";
        snap.forEach((rDoc) => {
          const rData = rDoc.data();
          repliesDiv.innerHTML += renderReply(rData, ['#9999ff','#ff9999','#99ff99','#ff99ff','#ffcc99','#ffff99'], threadId, rDoc.id);
          count++;
          
          // Prepare for caching
          repliesToCache.push({
            id: rDoc.id,
            ...rData,
            threadId: threadId,
            createdAt: rData.createdAt?.toDate?.()?.getTime() || Date.now()
          });
        });
        
        if (replyCountSpan) replyCountSpan.textContent = count;
        if (commentCountSpan) commentCountSpan.textContent = count;
        
        // Update toggle button text
        const toggleText = document.getElementById(`toggle-text-${threadId}`);
        if (toggleText) {
          const commentCountText = count === 0 ? "Tambahkan komentar pertama" : `Lihat komentar (${count})`;
          toggleText.innerHTML = commentCountText.replace(`(${count})`, `(<span id="comment-count-${threadId}">${count}</span>)`);
        }
        
        // Save to cache
        if (repliesToCache.length > 0) {
          await saveRepliesToCache(threadId, repliesToCache);
        }
        
        // Render LaTeX inside replies area
        renderMathInElement(repliesDiv, {
          delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "$", right: "$", display: false}
          ]
        });
      }, (err) => {
        console.error("replies snapshot error:", err);
      });
    }

    // Toggle show/hide comments
    window.toggleComments = function(threadId) {
      const commentsSection = document.getElementById(`comments-${threadId}`);
      const toggleIcon = document.getElementById(`toggle-icon-${threadId}`);
      const toggleBtn = document.getElementById(`toggle-btn-${threadId}`);
      const replyCount = document.getElementById(`reply-count-${threadId}`)?.textContent || 0;
      const commentCountSpan = document.getElementById(`comment-count-${threadId}`);
      const commentCount = commentCountSpan ? commentCountSpan.textContent : 0;
      
      if (commentsSection.classList.contains('expanded')) {
        // Collapse comments
        commentsSection.classList.remove('expanded');
        toggleIcon.classList.add('collapsed');
        if (toggleBtn) {
          toggleBtn.innerHTML = `
            <i class="fas fa-chevron-down toggle-icon collapsed" id="toggle-icon-${threadId}"></i>
            <span id="toggle-text-${threadId}">Lihat komentar (<span id="comment-count-${threadId}">${commentCount}</span>)</span>
          `;
        }
      } else {
        // Expand comments
        commentsSection.classList.add('expanded');
        toggleIcon.classList.remove('collapsed');
        if (toggleBtn) {
          toggleBtn.innerHTML = `
            <i class="fas fa-chevron-up toggle-icon" id="toggle-icon-${threadId}"></i>
            <span id="toggle-text-${threadId}">Sembunyikan komentar (<span id="comment-count-${threadId}">${commentCount}</span>)</span>
          `;
        }
        
        // Focus comment input when expanding
        setTimeout(() => {
          const commentInput = document.getElementById(`comment-${threadId}`);
          if (commentInput) {
            commentInput.focus();
          }
        }, 300);
      }
    };

    // Render single reply; include delete button only if owner
    function renderReply(r, colors, threadId, replyId) {
      const replyColorIndex = Math.abs(hashCode(r.name || r.email || "")) % colors.length;
      const replyAvatarColor = colors[replyColorIndex];
      const replyInitial = (r.name || r.email || "").charAt(0).toUpperCase();
      const canDelete = r.uid === currentUser.uid;
      const isAI = r.isAI || r.uid === "ai_nayra";

      // Jika ini adalah reply AI, gunakan styling khusus
      if (isAI) {
        return `
          <div class="comment">
            <div class="ai-reply-icon">
              <i class="fas fa-robot"></i>
            </div>
            <div class="comment-content" style="margin-left: 8px;">
              <div class="comment-header">
                <div class="ai-reply-name">${escapeHtml(r.name || "Nayra AI")}</div>
                <div class="comment-time">${formatDate(r.createdAt?.toDate?.() || r.createdAt)}</div>
              </div>
              <div class="ai-reply-text">${escapeHtml(r.teks)}</div>
            </div>
          </div>
        `;
      }

      return `
        <div class="comment">
          <div class="avatar comment-avatar" style="background-color: ${replyAvatarColor};">
            <span>${replyInitial}</span>
          </div>
          <div class="comment-content">
            <div class="comment-header">
              <div class="comment-user">${escapeHtml(r.name || r.email)}</div>
              <div class="comment-time">${formatDate(r.createdAt?.toDate?.() || r.createdAt)}</div>
            </div>
            <div class="comment-text">${escapeHtml(r.teks)}</div>
            <div class="comment-actions">
              <button class="comment-like-btn" onclick="likeComment('${threadId}', '${replyId}')">Suka</button>
              ${canDelete ? `
                <button class="comment-reply-btn" onclick="deleteReply('${threadId}','${replyId}')">Hapus</button>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    // Toggle thread options menu
    window.toggleThreadOptions = function(threadId) {
      const menu = document.getElementById(`options-menu-${threadId}`);
      menu.classList.toggle('show');
      
      // Close other open menus
      document.querySelectorAll('.thread-options-menu').forEach(otherMenu => {
        if (otherMenu !== menu && otherMenu.classList.contains('show')) {
          otherMenu.classList.remove('show');
        }
      });
      
      // Close menu when clicking outside
      setTimeout(() => {
        const closeMenuHandler = (e) => {
          if (!menu.contains(e.target) && !e.target.closest(`#options-menu-${threadId}`)) {
            menu.classList.remove('show');
            document.removeEventListener('click', closeMenuHandler);
          }
        };
        document.addEventListener('click', closeMenuHandler);
      }, 0);
    };

    // Report thread
    window.reportThread = function(threadId) {
      alert(`Thread ${threadId} telah dilaporkan.`);
      // Close the menu
      const menu = document.getElementById(`options-menu-${threadId}`);
      menu.classList.remove('show');
    };

    // Share thread
    window.shareThread = function(threadId) {
      if (navigator.share) {
        navigator.share({
          title: 'Thread dari QUANTARA',
          text: 'Lihat thread menarik ini di QUANTARA!',
          url: window.location.href + '?thread=' + threadId,
        })
        .catch(console.error);
      } else {
        alert('Fitur berbagi tidak didukung di browser ini.');
      }
    };

    // Focus comment input
    window.focusComment = function(id) {
      const el = document.getElementById(`comment-${id}`);
      if (el) {
        el.focus();
        // Expand comments section if collapsed
        const commentsSection = document.getElementById(`comments-${id}`);
        if (!commentsSection.classList.contains('expanded')) {
          toggleComments(id);
        }
      }
    };

    // Balas thread (subkoleksi) - DIPERBARUI dengan deteksi AI
    window.replyToThread = async function(id) {
      const input = document.getElementById(`comment-${id}`);
      if (!input || !input.value.trim()) return;
      
      const commentText = input.value.trim();
      
      try {
        const repliesRef = collection(db, "threads", id, "replies");
        
        // Tambahkan komentar user ke Firebase
        await addDoc(repliesRef, {
          uid: currentUser.uid,
          email: currentUser.email,
          name: currentProfile?.name || currentUser.email,
          teks: commentText,
          createdAt: serverTimestamp()
        });
        
        // Reset input
        input.value = "";
        input.style.height = 'auto';
        
        // Disable send button after sending
        const postCommentBtn = document.getElementById(`send-comment-${id}`);
        if (postCommentBtn) {
          postCommentBtn.disabled = true;
        }
        
        // Auto-expand comments section if it was collapsed
        const commentsSection = document.getElementById(`comments-${id}`);
        if (!commentsSection.classList.contains('expanded')) {
          toggleComments(id);
        }
        
        // Cek apakah komentar mengandung mention @nayraai
        if (containsNayraAIMention(commentText)) {
          // Dapatkan konteks thread untuk membantu AI
          const threadDoc = await getDoc(doc(db, "threads", id));
          const threadData = threadDoc.data();
          const threadContext = threadData?.teks || "";
          
          // Ekstrak pertanyaan dari komentar
          const question = extractQuestionFromComment(commentText);
          
          // Panggil AI untuk membalas (menggunakan llama-3.1-8b-instant)
          await addAIReply(id, question, threadContext);
        }
        
      } catch (err) {
        console.error("add reply error:", err);
        alert("Gagal menambah komentar: " + err.message);
      }
    };

    // Delete reply (only works if rules allow; UI already ensures only owner sees button)
    window.deleteReply = async function(threadId, replyId) {
      if (!confirm("Yakin ingin menghapus komentar ini?")) return;
      try {
        const ref = doc(db, "threads", threadId, "replies", replyId);
        await deleteDoc(ref);
        
        // Clear cache for this reply
        if (dbCache) {
          const transaction = dbCache.transaction([REPLIES_STORE], 'readwrite');
          const store = transaction.objectStore(REPLIES_STORE);
          store.delete(replyId);
        }
      } catch (err) {
        console.error("delete reply error:", err);
        alert("Gagal menghapus komentar: " + err.message);
      }
    };

    // Delete thread + its replies (batch delete). Only owner can delete (rules enforced server-side).
    window.deleteThread = async function(threadId) {
      if (!confirm("Yakin ingin menghapus thread ini beserta semua komentarnya?")) return;
      try {
        // batch delete replies then thread
        const repliesRef = collection(db, "threads", threadId, "replies");
        const repliesSnap = await getDocs(repliesRef);
        const batch = writeBatch(db);
        repliesSnap.forEach((rDoc) => {
          batch.delete(rDoc.ref);
        });
        // delete thread doc
        const threadRef = doc(db, "threads", threadId);
        batch.delete(threadRef);
        await batch.commit();
        
        // Clear cache for this thread and its replies
        if (dbCache) {
          const transaction = dbCache.transaction([THREADS_STORE, REPLIES_STORE], 'readwrite');
          const threadsStore = transaction.objectStore(THREADS_STORE);
          const repliesStore = transaction.objectStore(REPLIES_STORE);
          
          threadsStore.delete(threadId);
          
          // Delete all replies for this thread
          const index = repliesStore.index('threadId');
          const request = index.getAllKeys(threadId);
          request.onsuccess = () => {
            request.result.forEach(key => {
              repliesStore.delete(key);
            });
          };
        }
        
        // Reload threads after deletion
        await loadThreads();
      } catch (err) {
        console.error("delete thread error:", err);
        alert("Gagal menghapus thread: " + err.message);
      }
    };

    // Like / Unlike (ke sederhana)
    window.likeThread = async function(id, isCurrentlyLiked) {
      try {
        const ref = doc(db, "threads", id);
        const snap = await getDoc(ref);
        const data = snap.data() || {};
        const currentLikes = data.likes || 0;
        if (isCurrentlyLiked) {
          await updateDoc(ref, { likes: Math.max(0, currentLikes - 1), likedBy: arrayRemove(currentUser.uid) });
        } else {
          await updateDoc(ref, { likes: currentLikes + 1, likedBy: arrayUnion(currentUser.uid) });
        }
        
        // Update cache
        if (dbCache) {
          const transaction = dbCache.transaction([THREADS_STORE], 'readwrite');
          const store = transaction.objectStore(THREADS_STORE);
          const request = store.get(id);
          request.onsuccess = () => {
            const thread = request.result;
            if (thread) {
              thread.likes = isCurrentlyLiked ? Math.max(0, currentLikes - 1) : currentLikes + 1;
              thread.likedBy = isCurrentlyLiked 
                ? (thread.likedBy || []).filter(uid => uid !== currentUser.uid)
                : [...(thread.likedBy || []), currentUser.uid];
              thread.cachedAt = Date.now();
              store.put(thread);
            }
          };
        }
      } catch (err) {
        console.error("like error:", err);
      }
    };

    // Like comment
    window.likeComment = function(threadId, commentId) {
      // Implement like functionality for comments if needed
      alert('Fitur like komentar akan segera hadir!');
    };
    
    // Open image modal
    window.openImageModal = openImageModal;
    
    // Open AI feature
    window.openAIFeature = function(feature) {
      alert(`Membuka fitur AI: ${feature}`);
      closeSidebarFunc();
    };

    // Helpers
    function hashCode(str) { let hash = 0; for (let i=0;i<str.length;i++){ hash = str.charCodeAt(i) + ((hash<<5)-hash); } return hash; }
    function formatDate(date) {
      if (!date) return 'baru saja';
      const now = new Date(), diff = Math.floor((now - date)/1000);
      if (diff<60) return 'beberapa detik lalu';
      if (diff<3600) return `${Math.floor(diff/60)} menit lalu`;
      if (diff<86400) return `${Math.floor(diff/3600)} jam lalu`;
      if (diff<2592000) return `${Math.floor(diff/86400)} hari lalu`;
      return date.toLocaleDateString('id-ID',{year:'numeric',month:'short',day:'numeric'});
    }

    // basic HTML escape to avoid accidental HTML injection
    function escapeHtml(s) {
      if (!s && s !== 0) return "";
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

  </script>
</body>
</html>
