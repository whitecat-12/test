<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Science Explorer - Quiz Siswa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ... (CSS tetap sama seperti sebelumnya) ... */
        
        .mapel-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 10px;
        }
        
        .mapel-fisika { background: #e0f2fe; color: #0369a1; }
        .mapel-kimia { background: #dcfce7; color: #166534; }
        .mapel-biologi { background: #f3e8ff; color: #7c3aed; }
        .mapel-matematika { background: #fef3c7; color: #92400e; }
        
        /* Loading spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #38b2ac;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- üîπ MathJax -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            svg: { fontCache: 'global' }
        };
    </script>
    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <!-- Mobile App Container -->
    <div class="app-container">
        <!-- App Header -->
        <header class="bg-gradient-to-r from-primary to-secondary p-4 text-white">
            <div class="flex justify-between items-center">
                <div class="app-logo">
                    <div class="app-logo-icon">
                        <i class="fas fa-atom"></i>
                    </div>
                    <h1 class="app-name">QUANTARA</h1>
                </div>
                <div class="flex items-center space-x-3">
                    <i class="fas fa-search"></i>
                    <i class="fas fa-user-circle text-xl"></i>
                </div>
            </div>
            
            <!-- Mata Pelajaran Indicator -->
            <div id="mapelIndicator" class="mt-2 text-sm text-center font-medium bg-white bg-opacity-20 py-1 px-3 rounded-full inline-block">
                Memuat quiz...
            </div>
        </header>
        
        <!-- Main Content Area -->
        <main class="pb-20 islamic-pattern">
            <!-- Quiz Container -->
            <div class="p-4">
                <div class="bg-white quiz-container p-4">
                    <!-- Header -->
                    <div class="text-center mb-6">
                        <h1 class="text-2xl font-bold lavender-text" id="quizTitle">Quiz Siswa</h1>
                        <div class="w-20 h-1 lavender-bg mx-auto mt-2 rounded-full"></div>
                        <div id="mapelBadge" class="mt-2"></div>
                        <p class="text-gray-600 mt-2 text-sm" id="quizDesc">Uji pengetahuanmu dengan quiz menyenangkan ini!</p>
                    </div>

                    <!-- Progress indicator -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium lavender-text">Progress</span>
                            <span class="text-sm font-medium text-gray-600" id="progress-text">0/0</span>
                        </div>
                        <div class="bg-gray-200 rounded-full h-2.5">
                            <div class="lavender-bg h-2.5 rounded-full" id="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-8">
                        <div class="spinner"></div>
                        <p class="text-gray-500 mt-3">Memuat soal quiz...</p>
                    </div>

                    <!-- Tempat soal -->
                    <div id="quiz" class="space-y-6 mb-6 hidden"></div>

                    <!-- No Questions Message -->
                    <div id="noQuestions" class="text-center py-8 hidden">
                        <div class="text-5xl mb-4">üìù</div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Belum Ada Soal</h3>
                        <p class="text-gray-500 mb-4">Belum ada soal untuk mata pelajaran ini.</p>
                        <a href="soal harian/dashboard soal.html" class="bg-lavender text-white px-4 py-2 rounded-lg inline-block">
                            Kembali ke Dashboard
                        </a>
                    </div>

                    <!-- Navigasi soal -->
                    <div id="navigation" class="flex justify-between mt-6 hidden">
                        <button id="prevBtn" class="nav-button bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm" disabled>
                            ‚Üê Sebelumnya
                        </button>
                        <button id="nextBtn" class="nav-button lavender-bg text-white px-4 py-2 rounded-lg text-sm">
                            Selanjutnya ‚Üí
                        </button>
                    </div>

                    <!-- Logout -->
                    <button id="logoutBtn" class="mt-6 w-full bg-white lavender-text border lavender-border p-3 rounded-lg font-medium hover:bg-lavender hover:text-white transition-all text-sm">
                        Logout
                    </button>
                </div>
            </div>
        </main>
        
        <!-- BOTTOM NAVIGATION YANG SUDAH DISAMAKAN -->
        <nav class="bottom-nav">
            <a href="index.html" class="nav-item">
                <i class="fas fa-home nav-icon"></i>
                <span>Beranda</span>
            </a>
            <a href="soal harian/dashboard soal.html" class="nav-item">
                <i class="fas fa-flask nav-icon"></i>
                <span>Soal Harian</span>
            </a>
            <a href="ai/index.html" class="nav-item">
                <i class="fas fa-robot nav-icon"></i>
                <span>Nayra AI</span>
            </a>
            <a href="kategori/kategori materi.html" class="nav-item">
                <i class="fas fa-chalkboard-teacher nav-icon"></i>
                <span>Materi Harian</span>
            </a>
            <a href="profil.html" class="nav-item">
                <i class="fas fa-user nav-icon"></i>
                <span>Profil</span>
            </a>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJ5I8k2MzAyDLt9fUcXHRNtRVjKB_ETLY",
            authDomain: "projectid-81104.firebaseapp.com",
            projectId: "projectid-81104",
            storageBucket: "projectid-81104.firebasestorage.app",
            messagingSenderId: "554913260457",
            appId: "1:554913260457:web:bf988867ebfd902c651ab8",
            measurementId: "G-8WFHQW5WGN"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();

        // DOM Elements
        const quizEl = document.getElementById("quiz");
        const nextBtn = document.getElementById("nextBtn");
        const prevBtn = document.getElementById("prevBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progress-text");
        const loadingState = document.getElementById("loadingState");
        const noQuestions = document.getElementById("noQuestions");
        const navigation = document.getElementById("navigation");
        const mapelIndicator = document.getElementById("mapelIndicator");
        const mapelBadge = document.getElementById("mapelBadge");
        const quizTitle = document.getElementById("quizTitle");
        const quizDesc = document.getElementById("quizDesc");

        // State variables
        let soalList = [];
        let currentIndex = 0;
        let score = 0;                 
        let answered = {};             
        let currentUser = null;
        let selectedMapel = "";

        // üîπ Fungsi untuk mendapatkan parameter dari URL
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                mapel: params.get('mapel') || "",
                jenis: params.get('jenis') || "",
                tingkat: params.get('tingkat') || ""
            };
        }

        // üîπ Setup mapel badge berdasarkan jenis mata pelajaran
        function setupMapelBadge(mapel) {
            const mapelLower = mapel.toLowerCase();
            let badgeClass = "mapel-fisika";
            let icon = "fas fa-atom";
            
            if (mapelLower.includes("fisika")) {
                badgeClass = "mapel-fisika";
                icon = "fas fa-atom";
            } else if (mapelLower.includes("kimia")) {
                badgeClass = "mapel-kimia";
                icon = "fas fa-flask";
            } else if (mapelLower.includes("biologi")) {
                badgeClass = "mapel-biologi";
                icon = "fas fa-dna";
            } else if (mapelLower.includes("matematika")) {
                badgeClass = "mapel-matematika";
                icon = "fas fa-calculator";
            }
            
            mapelBadge.innerHTML = `
                <span class="mapel-badge ${badgeClass}">
                    <i class="${icon} mr-1"></i> ${mapel}
                </span>
            `;
            
            mapelIndicator.textContent = `Quiz ${mapel}`;
            quizTitle.textContent = `Quiz ${mapel}`;
            quizDesc.textContent = `Uji pengetahuanmu tentang ${mapel} dengan quiz ini!`;
        }

        // üîπ Logout
        logoutBtn.addEventListener("click", async () => {
            await signOut(auth);
            window.location.href = "login.html";
        });

        // üîπ Cek login user
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html";
            } else {
                currentUser = user;
                initializeQuiz();
            }
        });

        // üîπ Inisialisasi quiz
        async function initializeQuiz() {
            const params = getUrlParams();
            selectedMapel = params.mapel;
            
            if (!selectedMapel) {
                // Jika tidak ada parameter mapel, tampilkan semua soal atau redirect
                loadingState.classList.add("hidden");
                quizEl.classList.add("hidden");
                noQuestions.classList.remove("hidden");
                noQuestions.innerHTML = `
                    <div class="text-5xl mb-4">üîç</div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Pilih Mata Pelajaran</h3>
                    <p class="text-gray-500 mb-4">Silakan pilih mata pelajaran terlebih dahulu.</p>
                    <a href="soal harian/dashboard soal.html" class="bg-lavender text-white px-4 py-2 rounded-lg inline-block">
                        Kembali ke Dashboard
                    </a>
                `;
                return;
            }
            
            setupMapelBadge(selectedMapel);
            await loadSoalByMapel(selectedMapel);
        }

        // üîπ Ambil soal DARI MATAPELAJARAN TERTENTU
        async function loadSoalByMapel(mapel) {
            try {
                loadingState.classList.remove("hidden");
                quizEl.classList.add("hidden");
                navigation.classList.add("hidden");
                noQuestions.classList.add("hidden");
                
                // Query untuk mengambil soal berdasarkan mapel
                const q = query(collection(db, "soal"), where("mapel", "==", mapel));
                const snapshot = await getDocs(q);
                
                soalList = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                if (soalList.length === 0) {
                    loadingState.classList.add("hidden");
                    noQuestions.classList.remove("hidden");
                    return;
                }

                // Reset state
                currentIndex = 0;
                score = 0;
                answered = {};
                
                // Setup UI
                loadingState.classList.add("hidden");
                quizEl.classList.remove("hidden");
                navigation.classList.remove("hidden");
                updateProgress();
                renderSoal();
                
            } catch (err) {
                console.error("Error load soal:", err);
                loadingState.classList.add("hidden");
                quizEl.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-5xl mb-4 text-red-500">‚ùå</div>
                        <p class="text-red-500">Gagal mengambil soal. Cek koneksi internet Anda.</p>
                        <button onclick="location.reload()" class="mt-4 bg-lavender text-white px-4 py-2 rounded-lg">
                            Coba Lagi
                        </button>
                    </div>`;
            }
        }

        // Update progress bar
        function updateProgress() {
            if (soalList.length === 0) return;
            const progress = ((currentIndex + 1) / soalList.length) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${currentIndex + 1}/${soalList.length}`;
        }

        // üîπ Tampilkan soal
        function renderSoal() {
            const data = soalList[currentIndex];
            updateProgress();

            quizEl.innerHTML = `
                <div class="p-4 bg-white border border-gray-100 rounded-xl shadow-sm">
                    <div class="flex justify-between items-start mb-3">
                        <h2 class="font-semibold text-base lavender-text">Soal ${currentIndex + 1}:</h2>
                        <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">${data.mapel}</span>
                    </div>
                    <p class="mb-4 text-gray-700 text-base">${data.pertanyaan}</p>
                    <div class="space-y-3">
                        ${["A","B","C","D"].map(opt => `
                            <div class="option bg-white p-3 rounded-lg cursor-pointer shadow-sm hover:shadow-md text-sm border border-gray-200"
                                data-opt="${opt}" data-correct="${opt === data.jawaban}">
                                <div class="flex items-center">
                                    <span class="font-medium mr-3 w-6 h-6 flex items-center justify-center rounded-full 
                                        ${opt === data.jawaban ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">
                                        ${opt}
                                    </span>
                                    <span>${data.opsi[opt]}</span>
                                </div>
                            </div>
                        `).join("")}
                    </div>
                    <p id="feedback" class="mt-4 p-3 rounded-lg hidden text-sm"></p>
                </div>
            `;

            if (window.MathJax) MathJax.typesetPromise();

            document.querySelectorAll(".option").forEach(optEl => {
                optEl.addEventListener("click", () => {
                    const opt = optEl.dataset.opt;
                    const benar = optEl.dataset.correct === "true";
                    const feedback = document.getElementById("feedback");
                    
                    if (!answered[currentIndex]) {   
                        answered[currentIndex] = opt;
                        if (benar) {
                            score += (100 / soalList.length);
                        }
                    }

                    if (benar) {
                        optEl.classList.add("correct-answer");
                        feedback.innerHTML = `
                            <div class="flex items-start">
                                <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                                <div>
                                    <span class="font-medium text-green-700">Jawaban Benar!</span>
                                    <div class="text-green-600 mt-1">${data.penjelasan || "Penjelasan tidak tersedia"}</div>
                                </div>
                            </div>`;
                        feedback.className = "mt-4 p-3 rounded-lg bg-green-50 text-green-700 border border-green-200 text-sm";
                    } else {
                        optEl.classList.add("wrong-answer");
                        document.querySelectorAll(".option").forEach(o => {
                            if (o.dataset.correct === "true") {
                                o.classList.add("correct-answer");
                            }
                        });
                        feedback.innerHTML = `
                            <div class="flex items-start">
                                <i class="fas fa-times-circle text-red-500 mt-1 mr-2"></i>
                                <div>
                                    <span class="font-medium text-red-700">Jawaban Salah.</span>
                                    <div class="text-red-600 mt-1">${data.penjelasan || "Penjelasan tidak tersedia"}</div>
                                </div>
                            </div>`;
                        feedback.className = "mt-4 p-3 rounded-lg bg-red-50 text-red-700 border border-red-200 text-sm";
                    }

                    feedback.classList.remove("hidden");
                    if (window.MathJax) MathJax.typesetPromise([feedback]);

                    document.querySelectorAll(".option").forEach(o => {
                        o.style.pointerEvents = "none";
                        o.classList.remove("hover:shadow-md");
                    });
                });
            });

            prevBtn.disabled = currentIndex === 0;
            nextBtn.textContent = currentIndex === soalList.length - 1 ? "Selesai üéØ" : "Selanjutnya ‚Üí";
            nextBtn.className = currentIndex === soalList.length - 1 
                ? "nav-button bg-green-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-600" 
                : "nav-button lavender-bg text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-600";
        }

        // üîπ Navigasi soal
        nextBtn.addEventListener("click", () => {
            if (currentIndex < soalList.length - 1) {
                currentIndex++;
                renderSoal();
            } else {
                showResult();
            }
        });

        prevBtn.addEventListener("click", () => {
            if (currentIndex > 0) {
                currentIndex--;
                renderSoal();
            }
        });

        // üîπ Tampilkan hasil & simpan ke Firestore
        async function showResult() {
            const finalScore = Math.round(score);
            
            document.querySelector(".mb-6").style.display = "none";
            quizEl.innerHTML = `
                <div class="score-display p-6 text-center border border-lavender rounded-xl">
                    <div class="text-4xl mb-3">üéâ</div>
                    <h2 class="text-xl font-bold mb-2 lavender-text">Quiz Selesai!</h2>
                    <div class="mapel-badge mapel-fisika inline-block mb-3">
                        <i class="fas fa-trophy mr-1"></i> ${selectedMapel}
                    </div>
                    <p class="text-base text-gray-600 mb-3">Kamu telah menyelesaikan semua soal ${selectedMapel}</p>
                    <div class="inline-block bg-white rounded-full px-5 py-3 shadow-md mb-4">
                        <span class="text-gray-600 text-sm">Nilai akhir:</span>
                        <span class="text-2xl font-bold lavender-text"> ${finalScore}</span>
                        <span class="text-gray-400 text-sm">/100</span>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg mt-4">
                        <p class="text-sm text-gray-600 mb-2">Statistik Jawaban:</p>
                        <div class="flex justify-between text-sm">
                            <span>Benar: ${Object.values(answered).filter((ans, idx) => ans === soalList[idx].jawaban).length}/${soalList.length}</span>
                            <span>Salah: ${Object.values(answered).filter((ans, idx) => ans !== soalList[idx].jawaban).length}/${soalList.length}</span>
                        </div>
                    </div>
                    
                    <div class="mt-6 space-y-2">
                        <button onclick="location.reload()" class="w-full bg-lavender text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-redo mr-2"></i> Coba Lagi
                        </button>
                        <button onclick="window.location.href='soal harian/dashboard soal.html'" class="w-full bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">
                            <i class="fas fa-arrow-left mr-2"></i> Kembali ke Dashboard
                        </button>
                    </div>
                </div>
            `;
            
            navigation.style.display = "none";

            try {
                await addDoc(collection(db, "nilai"), {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    mapel: selectedMapel,
                    score: finalScore,
                    totalSoal: soalList.length,
                    benar: Object.values(answered).filter((ans, idx) => ans === soalList[idx].jawaban).length,
                    salah: Object.values(answered).filter((ans, idx) => ans !== soalList[idx].jawaban).length,
                    createdAt: new Date()
                });
                console.log("Nilai tersimpan");
            } catch (err) {
                console.error("Gagal simpan nilai:", err);
            }
        }

        // INTERAKSI NAVBAR YANG SUDAH DISAMAKAN
        document.addEventListener('DOMContentLoaded', function() {
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    navItems.forEach(nav => {
                        nav.classList.remove('active');
                        nav.querySelector('.nav-icon').classList.remove('active');
                    });
                    
                    this.classList.add('active');
                    this.querySelector('.nav-icon').classList.add('active');
                });
            });
        });
    </script>
</body>
</html>
